<html>
<head>
	<link rel="shortcut icon" id="gameIcon" type="image/x-icon" href="resources/favicon-normal.png">
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>
		1255 Burgomaster
	</title>
	<link rel="stylesheet"  type="text/css" href="./css/normalize.min.css"/>
	<link rel="stylesheet"  type="text/css" href="./css/game.css"/>
	<link rel="stylesheet"  type="text/css" href="./css/hire.css"/>
	<link rel="stylesheet"  type="text/css" href="./css/inn.css" />
	<script src="https://browser.sentry-cdn.com/5.1.2/bundle.min.js" crossorigin="anonymous"></script>
	<script>
		'use strict';
		if (window.location.href.indexOf("file")===-1){
			Sentry.init({ dsn: 'https://84a2a9b7436b40a6868d8493ee91c6dd@o1014630.ingest.sentry.io/5979860' });
		}
	</script>
	<script>
		if (window.location.href.indexOf("file")===-1){
			webserver = "https://navi.areso.pro:7001";
			ws_server = "wss://navi.areso.pro:7000";
			//ws_server = "ws://51.68.172.115:7000";
			dev_flag  = false;
		} else {
			webserver = "http://localhost:6699";
			ws_server = "ws://localhost:6698";
			dev_flag  = true;
		}
	</script>
	<script src="js/dom.js" ></script>
</head>
<body>

<div id="htmlGame">
		<div class="menu-panel">
			<button class="tab-link" onclick="openTab(event, 'Main')" id="tabCity">Main</button>
			<button class="tab-link is-tutorial" onclick="openTab(event, 'Building')" id="tabBuilding">Building</button>
			<button class="tab-link" onclick="openTab(event, 'Settings')" id="tabSettings">Settings</button>
			<button class="tab-link" onclick="openTab(event, 'About')" id="tabAbout">How To Play</button>
			<button class="tab-link" onclick="openTab(event, 'Discord')" id="tabDiscord">Discord</button>
			<div id="lblEventCountdownValue" style="margin-left:20px;" onclick="game.getEventHelp()"></div>
			<a href="https://www.patreon.com/bePatron?u=7838459" target="_blank"><img src="resources/patreon.png" style="padding: 6px 0px"></a>
		</div>
		<div class="resource-panel">
			<div class="gold-val" onclick="checkGold()">
				<img id="gold_img_bt" class="resource-icon" src="resources/gold_a.png">
				<span id="gold">0</span>
			</div>
			<div class="population-val" onclick="checkPop()">
				<img id="pop_img" class="resource-icon" src="resources/pop.png">
				<span id="pop">2</span>
			</div>
			<div class="gems-val" onclick="showModal(0, '', getAck, localeStrings[90],  localeStrings[60], '');">
				<img id="gems_img" class="resource-icon" src="resources/amber_ico.png">
				<span id="gems">0</span>
			</div>
			<div class="time-val">
				<img class="resource-icon" src="resources/sand_clock.png">
				<span id="dcounter">30</span>
			</div>
			<div class="server-val">
				Server: <span id="server-status">n/d</span>
			</div>
			<div class="event-val" style="margin-left: 20px;">
				<span id="event-label"></span>
				<span id="event-value" onclick="getEventHelp()"></span>
			</div>
		</div>
		<div class="content-panel">
			<div id="Main" class="tab">
				<canvas width="800" height="480" id="canvas" class="canvas" style="z-index:1"></canvas>
				<div id="events_graphics"></div>
				<button id="saveGameButton" onclick="saveGame()" class="btn">Save game</button>
				<button id="loadGameButton" onclick="loadGame()" class="btn">Load game</button>
				<button id="buttonPutOutFire" onclick="game.putOutFire()" class="btn">Put out fire</button>
				<button id="buttonDeathPenalty" onclick="game.deathPenalty()" class="btn">Execute smb</button>
			</div>
			<div id="Explore" class="tab">
				<canvas width="800" height="480" id="canvasMap" class="canvas" style="z-index:1"></canvas>
			</div>
			<div id="tabUniversity" class="tab">
				<div id="available_researches">
				
				</div>
				<!--<img src="resources/serpentine.png" onclick="game.research('artillery')">-->
				<div id="lblReseachHelp" class="building-description"></div>
			</div>
			<div id="Settings" class="tab">
				<h3><div id="labelSettings">Settings</div></h3>
				<button id="btnReg"   onclick="setReg()"                             >REG</button>
				<button id="btnLogin" onclick="setLogin()" style="margin-left:20px;" >LOGIN</button><br>
				 Nickname: <input id="login"    type="text"     value=""><br>
				Password: <input id="password" type="password" value=""><br>
				<span id="emailLine">Email: <input id="email" type="text" value=""> - trully optional, only for account recovering<br></span>
				<button id="btnRegLogin" onclick="remoteRegLogin()">Register</button><br><hr>
				<select id="selectLng" size="1" onchange="reloadLang()">
					<option id="optionLngEn" selected value="en-US">English</option>
					<option id="optionLngRu"          value="ru-RU">Русский</option>
					<option id="optionLngGe"          value="de-DE">Deutsch</option>
					<option id="optionLngEo"          value="eo">Esperanto</option>
					<option id="optionLngFr"          value="fr-FR">Français</option>
				</select>
				<table>
					<tr>
						<td width="40%"><label id="labelAutosave">Autosave</label><img id="autosaveImg" onclick="changeAutosave()" src="resources/button_red.png" style="margin-left: 20px;"></td>
						<td><button id="buttonExportGame" onclick="exportGame()" >Export Game</button></td>
						<td><button id="buttonImportGame" onclick="importGame()" >Import Game</button></td>
					</tr>
				</table>
				<button id="buttonSaveToCloud" onclick="cloudQuickSave()" style="margin-bottom:20px; margin-top:15px;" >Save to Cloud</button>
				<button id="buttonLoadFromCloud" onclick="cloudQuickLoad()" style="margin-left:30px; margin-bottom:20px; margin-top:15px;">Load save from Cloud</button>
				<br>
				<input id="savestring" name="savestring" value="" style="width:600px">
				<br>
				<a id="downloadGame" href="https://github.com/Areso/1255-burgomaster/archive/gh-pages.zip">Download game for playing off-grid (to play without Internet connection)</a>
				<br>
				<br>
				<button id="btnColorMode" onclick="changeColorMode()">ChangeColorMode</button>
				<button id="btnSoundSettings" onclick="openTab(null, 'tabSettingsSound')">Open sound settings</button>
				<br>
				<br>
				<input type="checkbox" id="cbMobileUI" value="mobileUI" onclick="game.mobileUI()" style="margin-left: 50px;"><label id="lblStnMobileUI">Mobile UI</label>
	Research			<label id="lblStnEventLogSize" style="margin-left: 20px;">Event log size</label>
				<input id="inpStnEventLogSize" value="" onchange="game.setupEventLogSize()" style="width:35px; margin-right:10px;">
				<label id="lblStnLines">lines</label>
				<br>
				<lable id="lblStnUID" style="visibility:hidden;">Your UID</lable><label id="lblStnUIDValue" style="margin-left: 20px; visibility:hidden;"></label>
				<label id="lblStnAlias" style="display: none" >Your nickname</label>
				<input id="inpStnAliasValue" style="display: none" value="" onchange="game.updateAlias()" style="margin-left: 20px;">
				<br>
				<label id="lblStnAliasResult"></label><br>
				<textarea id="patchnotes" class="interface" value="" style="width:700px; height:280px; top:255px; left:40px; visibility: hidden;"></textarea>
			</div>
			<div id="tabModTools" class="tab">
				<button id="set_btn"  onclick="reloadSettings()" style="visibility: hidden">reload settings</button>
				<button id="ban_btn"  onclick="reloadBanned()"   style="visibility: hidden">reload banned</button>
				<div id="moderation_area"   name="moderation"    class="interface" value="" style="width:800px; height:150px; top: 80px; left: 10px"></div>
			</div>
			<div id="tabSettingsSound" class="tab">
				<label id="lblSoundMenu">Sound effects and music</label><br>
				<!--Note, those above overwrite those below-->
				<table border="0" width="100%">
					<tr>
						<td width="60%"><label id="lblOption">Option</label></td>
						<td width="20%"><label id="lblOn">On</label></td>
						<td width="20%"><label id="lblOff">Off</label></td>
					</tr>
					<tr>
						<td width="60%"><label id="lblSfxAll">All sound effects</label></td>
						<td width="20%"><input type = "radio"
																	 name = "sfx"
																	 id = "sfx_on"
																	 value = "on"
																	 onchange="game.setupAudio('sfx','all',1)"/></td>
						<td width="20%"><input type = "radio"
																	 name = "sfx"
																	 id = "sfx_off"
																	 value = "off"
																	 onchange="game.setupAudio('sfx','all',0)"
																	 checked = "checked" /></td>
					</tr>
					<tr>
						<td width="60%"><label id="lblSfxEvt">Effects on all events</label></td>
						<td width="20%"><input type = "radio"
																	 name = "sfx_events"
																	 id = "sfx_events_on"
																	 value = "on"
																	 onchange="game.setupAudio('sfx','events',1)"/></td>
						<td width="20%"><input type = "radio"
																	 name = "sfx_events"
																	 id = "sfx_events_off"
																	 value = "off"
																	 onchange="game.setupAudio('sfx','events',0)"
																	 checked = "checked" /></td>
					</tr>
					<tr>
						<td width="60%"><label id="lblSfxEvtAR">Effects on action required events</label></td>
						<td width="20%"><input type = "radio"
																	 name = "sfx_actions"
																	 id = "sfx_actions_on"
																	 value = "on"
																	 onchange="game.setupAudio('sfx','actions',1)"/></td>
						<td width="20%"><input type = "radio"
																	 name = "sfx_actions"
																	 id = "sfx_actions_off"
																	 value = "off"
																	 onchange="game.setupAudio('sfx','actions',0)"
																	 checked = "checked" /></td>
					</tr>
					<tr>
						<td width="60%">-----</td>
						<td width="20%">-----</td>
						<td width="20%">-----</td>
					</tr>
					<tr>
						<td width="60%"><label id="lblMscAll">Music all</label></td>
						<td width="20%"><input type = "radio"
																	 name = "music_all"
																	 id = "music_on"
																	 value = "on"
																	 onchange="game.setupAudio('music','all',1)"/></td>
						<td width="20%"><input type = "radio"
																	 name = "music_all"
																	 id = "music_off"
																	 value = "off"
																	 onchange="game.setupAudio('music','all',0)"
																	 checked = "checked" /></td>
					</tr>
					<tr>
						<td width="60%"><label id="lblMscScr">Lore and scenery music</label></td>
						<td width="20%"><input type = "radio"
																	 name = "music_script"
																	 id = "music_scripts_on"
																	 onchange="game.setupAudio('music','scripts',1)"
																	 value = "on" /></td>
						<td width="20%"><input type = "radio"
																	 name = "music_script"
																	 id = "music_scripts_off"
																	 value = "off"
																	 onchange="game.setupAudio('music','scripts',0)"
																	 checked = "checked" /></td>
					</tr>
				</table>
				<br>
				<hr>
				<button id="btnToGeneralSettings" onclick="openTab(null, 'Settings')">Back</button>
			</div>
			<div id="tabGarrison" class="tab">
				<h3><div id="labelGarrison">Garrison</div></h3>
				<div id="divtreasuryGuard">
					<table border="1">
						<tr>
							<td>
								<div id="treasury_guard_div" align="center">
									<img src="resources/knight6.png">
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<button id="buttonFireGuard" onclick="game.fireTreasuryGuard()" style="width:100px">Fire</button>
								<span id="treasuryGuard">0</span>
								<button id="buttonHireGuard" onclick="game.hireTreasuryGuard()" style="width:100px">Hire</button>
							</td>
						</tr>
					</table>
				</div>
			</div>
			<div id="tabFirebrigade" class="tab">
				<h3><label id="lblFirebrigade">Fire brigade</label></h3>
				<table border="0" width="100%">
					<tr>
						<td width="60%"><label id="lblFBOption">The fire service is</label></td>
						<td width="20%"><label id="lblFBOn">on duty</label></td>
						<td width="20%"><label id="lblFBOff">off duty</label></td>
					</tr>
					<tr>
						<td width="60%"></td>
						<td width="20%"><input type = "radio"
																	 name = "inp_fb"
																	 id = "fb_on"
																	 value = "on"
																	 onchange="game.setupFirebrigade(1)"/></td>
						<td width="20%"><input type = "radio"
																	 name = "inp_fb"
																	 id = "fb_off"
																	 value = "off"
																	 onchange="game.setupFirebrigade(0)"
																	 checked = "checked" /></td>
					</tr>
				</table>
				<br>
				<label id="lblFBUpKeepPrice">The price of sustain of the service is:</label><label id="lblFBUpkeepPriceValue" style="margin-left:20px;">0</label>
				<br>
				<div id="divFBProgress" style="display: none">0% of fire extinguished</div>
				<br>
			</div>
			<div id="Building" class="tab">
				<div id="labelBuilding" style="display: none;">Building</div>
					<div class="building-wrapper">
						<div class="building-list">

							<div id="bldHome" class="building-card">
								<div class="building-card__img">
									<img
										id="home_img"
										class="is-tutorial"
										src="./resources/home_as.png"
										alt="home_as.png"
										onmouseover="game.help(this)"
										onclick="game.help(this)"
									/>
								</div>
								<div class="building-card__action">
									<button id="homes" class="btn is-tutorial" onclick="game.Build('Home')">Build Home</button>
								</div>
							</div>

							<div id="bldDefence" class="building-card">
								<div class="building-card__img">
									<img
										id="defences_img"
										class="is-tutorial"
										src="./resources/wallsf_as2.png"
										alt="wallsf_as2.png"
										onmouseover="game.help(this)"
										onclick="game.help(this)">
								</div>
								<div class="building-card__action">
									<button id="defence" class="btn is-tutorial" onclick="game.Build('Wall')">Build Walls</button>
								</div>
							</div>

							<div id="bldTreasury" class="building-card">
								<div class="building-card__img">
									<img
										id="treasury_img"
										class="is-tutorial"
										src="./resources/treasury_as.png"
										alt="treasury_as.png"
										onmouseover="game.help(this)"
										onclick="game.help(this)">
								</div>
								<div class="building-card__action">
									<button id="treasury" class="btn is-tutorial" onclick="game.Build('Treasury')">Build Treasury</button>
								</div>
							</div>

							<div id="bldGallows" class="building-card">
								<div class="building-card__img">
									<img
										id="gallows_img"
										class="is-tutorial"
										src="./resources/gallows.png"
										alt="gallows.png"
										onmouseover="game.help(this)"
										onclick="game.help(this)">
								</div>
								<div class="building-card__action">
									<button id="buttonBldGallows" class="btn is-tutorial" onclick="game.buildGallowsOrFountain('Gallows')">Build Gallows</button>
								</div>
							</div>

							<div id="bldFountain" class="building-card">
								<div class="building-card__img">
									<img
										id="fountain_img"
										class="is-tutorial"
										src="./resources/fountain.png"
										alt="fountain.png"
										onmouseover="game.help(this)"
										onclick="game.help(this)">
								</div>
								<div class="building-card__action">
									<button id="buttonBldFountain" class="btn is-tutorial" onclick="game.buildGallowsOrFountain('Fountain')">Build Fountain</button>
								</div>
							</div>

							<div id="bldStash" class="building-card">
								<div class="building-card__img">
									<img
										id="moneystash_img"
										class="is-tutorial"
										src="./resources/trapdoor.png"
										alt="trapdoor.png"
										onmouseover="game.help(this)"
										onclick="game.help(this)">
								</div>
								<div class="building-card__action">
									<button id="buttonBldStash" class="btn is-tutorial" onclick="game.Build('Stash')">Build Stash</button>
								</div>
							</div>

							<div id="bldStable" class="building-card">
								<div class="building-card__img">
									<img
										id="stable_img"
										class="is-tutorial"
										src="./resources/stable.png"
										alt="stable.png"
										onmouseover="game.help(this)"
										onclick="game.help(this)">
								</div>
								<div class="building-card__action">
									<button id="buttonBldStable" class="btn is-tutorial" onclick="game.Build('Stable')">Build Stable</button>
								</div>
							</div>

							<div id="bldArchery" class="building-card">
								<div class="building-card__img">
									<img
										id="archery_img"
										class="is-tutorial"
										src="./resources/archery_range.png"
										alt="archery_range.png"
										onmouseover="game.help(this)"
										onclick="game.help(this)">
								</div>
								<div class="building-card__action">
									<button id="buttonBldArchery" class="btn is-tutorial" onclick="game.Build('Archery')">Build Archery range</button>
								</div>
							</div>

							<div id="bldInn" class="building-card">
								<div class="building-card__img">
									<img
										id="inn_img"
										class="is-tutorial"
										src="./resources/inn.png"
										alt="tavern.png"
										onmouseover="game.help(this)"
										onclick="game.help(this)">
								</div>
								<div class="building-card__action">
									<button id="buttonBldInn" class="btn is-tutorial" onclick="game.Build('Inn')">Build Inn</button>
								</div>
							</div>
							<!--UNIVERSITY-->
							<div id="bldUniversity" class="building-card">
								<div class="building-card__img">
									<img
										id="university_img"
										src="./resources/university2.png"
										alt="university image"
										onmouseover="game.help(this)"
										onclick="game.help(this)">
								</div>
								<div class="building-card__action">
									<button id="buttonBuildUniversity" class="btn" onclick="game.Build('University')">Build University</button>
								</div>
							</div>
						</div>
					</div>
				<div id="lblBuildHelp" class="building-description"></div>
			</div>
			<div id="About" class="tab">
				<div id="lblAboutGame">
					<h1>1255 Burgomaster</h1><br>
					<h2>How to play</h2>
				</div>
			</div>
			<div id="tabPopulation" class="tab">
				<div id="lblTabPop">Population history tab</div>
				<br>
				<table border="1">
					<tbody>
					<tr id="popStatK">
					</tr>
					<tr id="popStatV">
					</tr>
					</tbody>
				</table>
				<br>
				<button id="btnPopAtStart"  onclick="popAtStart()" style="width:160px">To the beginning</button>
				<button id="btnPopPrev"     onclick="popPrev()" style="width:160px">Earlier</button>
				<button id="btnPopNext"     onclick="popNext()" style="width:160px">Later</button>
				<button id="btnPopAtEnd"    onclick="popAtEnd()" style="width:160px">To the end</button>
				<br>
				<br>
				<div id="lblCurrentPopLimit"></div>
			</div>
			<div id="tabGold" class="tab">
				<div id="lblTabGold">Gold history tab</div>
				<br>
				<table border="1">
					<tbody>
					<tr id="goldStatK">
					</tr>
					<tr id="goldStatV">
					</tr>
					</tbody>
				</table>
				<br>
				<button id="btnGoldAtStart"  onclick="goldAtStart()" style="width:160px">To the beginning</button>
				<button id="btnGoldPrev"     onclick="goldPrev()" style="width:160px">Earlier</button>
				<button id="btnGoldNext"     onclick="goldNext()" style="width:160px">Later</button>
				<button id="btnGoldAtEnd"    onclick="goldAtEnd()" style="width:160px">To the end</button>
				<br>
				<br>
				<div id="lblCurrentGoldLimit"></div>
			</div>
			<div id="tabInn" class="tab">
				<h3 id="lblTabInn">Welcome to Inn!</h3>
				<div id="hireHeroBlock">
					<label id="lblAvailableForHire">Hero for hire</label>
					<table>
						<tr>
							<td>
								<!--HRP-->
								<img id="imgPrevHero" src="resources/pointer_l.png" onclick="prevHero()">
								<img id="imgHeroForHire" src="resources/hero-knight.png">
								<img id="imgNextHero" src="resources/pointer_r.png" onclick="nextHero()">
							</td>
							<td>
								<div>
									<label id="lblClassForHire">Knight</label>
									<label>,  </label>
									<label id="lblLevelForHireLbl">level </label>
									<label id="lblLevelForHire">1</label>
								</div>
								<div>
									<label id="lblPrimaryStats">ATK:2, DEF:2, INT: 2, MP: 20</label>
								</div>
								<div>
									<label id="lblSpeciality">Get high chances to increase ATK when level up</label>
								</div>
							</td>
						</tr>
					</table>
					<button id="btnHireHero" class="btn" onclick="game.heroHire()" style="width:160px; margin-left: 30px">Hire hero %arg1 level</button>
				</div>
				<div id="heroUpkeep">
					<label id="lblUpkeepSrc">The primary source of payments to the hero's troops is </label>
					<select id="selectUpkeepSrc" size="1" onchange="game.changeUpkeepSrc()">
						<option id="optionPurse" selected value="0">Hero's purse</option>
						<option id="optionTreasury"       value="1">Treasury</option>
					</select>
				</div>
				<div id="heroStats"></div>
				<button id="btnDismissHero" class="btn"   onclick="game.heroDismiss()" style="width:160px; visibility:hidden">Dismiss hero</button>
				<button id="btnAutocampaign"  class="btn"   onclick="game.autocampaign()" style="width:160px; visibility: hidden">Launch autocampaign!</button>
				<button id="btnAutocampaignJournal" class="btn"   onclick="openTabAutocampaignJournal()" style="width:160px; visibility: hidden">Open journal</button>
				<button id="btnTowngate" class="btn" onclick="game.towngate()" style="visibility: hidden">Teleport to the town!</button>
				<br>
				<br>
				<button id="btnLeaveCity" class="btn"   onclick="game.cityLeave()" style="width:160px; visibility: hidden">Go to exploring!</button>
				<button id="btnGenerateMap" class="btn"  onclick="game.generateMap()" style="width:160px">Regenerate map</button>

				<button id="btnAutobattlesList" class="btn" onclick="openTabAutocampaignBattle()" style="width:160px">Autocampaign battles</button>

			</div>
			<div id="tabAutocampaignJournal" class="tab">
				<div id="lblAutocampaignJournal"></div>
				<button id="btnToInn" class="btn"  style="width:160px;" onclick="openTab(null, 'tabInn')">Back</button>
			</div>
			<div id="tabAutocampaignBattle" class="tab">
				<div id="lblAutocampaignBattle"></div>
				<button id="btnToInn1" class="btn" style="width:160px;" onclick="openTab(null, 'tabInn')">Back</button>
			</div>
			<div id="tabTroopsHiring" class="tab">
				<div class="grid-container" style="width: 800px; height: 480px">
					<div class="grid-item hire" id="grid-hire11">
						<img id="imgHiringScreenSergeantToHire"   src="resources/sergeant.png" class="unit-img"
								 onmouseover="hoverInObj(this)" onmouseout="hoverOutObj(this)" onclick="selectObj(this)">
					</div>
					<div class="grid-item hire" id="grid-hire12">
						<img id="imgHiringScreenTurkopolToHire" src="resources/turkopol.png" class="unit-img"
								 onmouseover="hoverInObj(this)" onmouseout="hoverOutObj(this)" onclick="selectObj(this)">
					</div>
					<div class="grid-item hire" id="grid-hire13">
						<img id="imgHiringScreenKnightToHire" src="resources/knight.png" class="unit-img"
								 onmouseover="hoverInObj(this)" onmouseout="hoverOutObj(this)" onclick="selectObj(this)">
					</div>
					<div class="grid-item hire not-implemented" id="grid-hire21">4</div>
					<div class="grid-item hire not-implemented" id="grid-hire22">5</div>
					<div class="grid-item hire not-implemented" id="grid-hire23">6</div>
					<div class="grid-item" id="grid-info">info</div>
					<div class="grid-item" id="grid-castellan">
						<img id="imgCastellanInHiringScreen" src="resources/castellan.png">
					</div>
					<div class="grid-item" id="grid-garrison1">
						<img id="imgHiringScreenGarrisonSergeant1" src="resources/sergeant.png" class="unit-img"
								 onmouseover="hoverInObj(this)" onmouseout="hoverOutObj(this)" onclick="selectObj(this)">
					</div>
					<div class="grid-item" id="grid-garrison1v">10</div>
					<div class="grid-item" id="grid-garrison2">
						<img id="imgHiringScreenGarrisonTurkopol2" src="resources/turkopol.png" class="unit-img"
								 onmouseover="hoverInObj(this)" onmouseout="hoverOutObj(this)" onclick="selectObj(this)">
					</div>
					<div class="grid-item" id="grid-garrison2v">200</div>
					<div class="grid-item" id="grid-garrison3">
						<img id="imgHiringScreenGarrisonKnight3" src="resources/knight.png" class="unit-img"
								 onmouseover="hoverInObj(this)" onmouseout="hoverOutObj(this)" onclick="selectObj(this)">
					</div>
					<div class="grid-item" id="grid-garrison3v">300</div>
					<div class="grid-item not-implemented" id="grid-garrison4">garrison4</div>
					<div class="grid-item not-implemented" id="grid-garrison4v">400</div>
					<div class="grid-item not-implemented" id="grid-garrison5">garrison5</div>
					<div class="grid-item not-implemented" id="grid-garrison5v">500</div>
					<div class="grid-item not-implemented" id="grid-garrison6">garrison6</div>
					<div class="grid-item not-implemented" id="grid-garrison6v">600</div>

					<div class="grid-item visiting-hero" id="grid-hero">
						<img id="imgHeroInHiringScreen" width="90px" height="90px" style="display: none" src="" >
						<img id="imgHeroInHiringScreenKnight2" style="display: none" src="resources/hero-knight.png" onmouseover="game.help(this)">
						<img id="imgHeroInHiringScreenMonk2" style="display: none" src="resources/hero-monk.png" onmouseover="game.help(this)">
					</div>
					<div class="grid-item visiting-hero" id="grid-hero1">
						<img id="imgHiringScreenHeroSergeant1" src="resources/sergeant.png">
					</div>
					<div class="grid-item visiting-hero" id="grid-hero1v">100</div>
					<div class="grid-item visiting-hero" id="grid-hero2">
						<img id="imgHiringScreenHeroTurkopol2" src="resources/turkopol.png">
					</div>
					<div class="grid-item visiting-hero" id="grid-hero2v">200</div>
					<div class="grid-item visiting-hero" id="grid-hero3">
						<img id="imgHiringScreenHeroKnight3"   src="resources/knight.png"  >
					</div>
					<div class="grid-item visiting-hero" id="grid-hero3v">300</div>
					<div class="grid-item not-implemented" id="grid-hero4">hero4</div>
					<div class="grid-item not-implemented" id="grid-hero4v">400</div>
					<div class="grid-item not-implemented" id="grid-hero5">hero5</div>
					<div class="grid-item not-implemented" id="grid-hero5v">500</div>
					<div class="grid-item not-implemented" id="grid-hero6">hero6</div>
					<div class="grid-item not-implemented" id="grid-hero6v">600</div>
				</div>
			</div>
			<!--
			<div id="tabTroopsHiringOld" class="tab">
				<label id="lblTroopsHiring">Hiring troops</label><br>
				<div id="lblTroopsHelp" style="height: 80px; width: 780px;">
				</div>
				<table border="1px">
					<tr>
						<td>

						</td>
						<td>
							<div class="unit-main">
								<img id="imgHiringScreenSergeant" src="resources/sergeant.png" onmouseover="game.help(this)">
								<div class="unit-info">
									<p>Atk.: <span id="sergeantsAttack">5</span></p>
									<p>Def.: <span id="sergeantsDefence">8</span></p>
									<p>Dmg: 3-4</p>
									<p>HP: <span id="sergeantsHealth">15</span></p>
								</div>
							</div>
						</td>
						<td>
							<div class="unit-main">
								<img id="imgHiringScreenTurkopol" src="resources/turkopol.png" onmouseover="game.help(this)">
								<div class="unit-info">
									<p>Atk.: <span id="turkopolsAttack">5</span></p>
									<p>Def.: <span id="turkopolsDefence">5</span></p>
									<p>Dmg: 2-3</p>
									<p>HP: <span id="turkopolsHealth">12</span></p>
								</div>
							</div>

						</td>
						<td>
							<div class="unit-main">
								<img id="imgHiringScreenKnight" src="resources/knight.png" onmouseover="game.help(this)">
								<div class="unit-info">
									<p>Atk.: <span id="knightsAttack">10</span></p>
									<p>Def.: <span id="knightsDefence">9</span></p>
									<p>Dmg: 5-10</p>
									<p>HP: <span id="knightsHealth">20</span></p>
								</div>
							</div>
						</td>
						<td></td>
					</tr>
					<tr>
						<td>

						</td>
						<td>
							<button id="btnHireSergeant" onclick="game.hireTroopsSergeant()" onmouseover="game.help(this)" class="btn-hire">Hire sergeant</button>
						</td>
						<td>
							<button id="btnHireTurkopol" onclick="game.hireTroopsTurkopol()" onmouseover="game.help(this)" class="btn-hire">Hire turkopol</button>
						</td>
						<td>
							<button id="btnHireKnight" onclick="game.hireTroopsKnight()" onmouseover="game.help(this)" class="btn-hire">Hire knight</button>
						</td>
						<td></td>
					</tr>
					<tr>
						<td>
							<img id="imgCastellanInHiringScreen" src="resources/castellan.png" onmouseover="game.help(this)">
						</td>
						<td>
							<div><label class="lblHiringTroops" id="lblTabHiringTroopsSergeantsGarrison">sergeants: </label></div><div id="lblGarnisonSergeants" style="display: inline">0</div>
							<button class="btnArrow" id="btnMoveSergeantToHero" onclick="game.moveSergeantsToHero()" onmouseover="game.help(this)">↓</button>
							<button class="btnArrow" id="btnMoveAllSergeantsToHero" onclick="game.moveAllSergeantsToHero()" onmouseover="game.help(this)">⇓</button>
							<br>
							<button id="btnDismissGarrisonSergeant" class="btnDismiss" onclick="game.dismissGarrisonSergeant()" onmouseover="game.help(this)">X</button>
							<button id="btnDismissAllGarrisonSergeants" class="btnDismiss" onclick="game.dismissAllGarrisonSergenats()" onmouseover="game.help(this)">XX</button>
						</td>
						<td>
							<div><label class="lblHiringTroops" id="lblTabHiringTroopsTurkopolsGarrison">turkopols: </label></div><div id="lblGarnisonTurkopols" style="display: inline">0</div>
							<button class="btnArrow" id="btnMoveTurkopolToHero" onclick="game.moveTurkopolsToHero()" onmouseover="game.help(this)">↓</button>
							<button class="btnArrow" id="btnMoveAllTurkopolsToHero" onclick="game.moveAllTurkopolsToHero()" onmouseover="game.help(this)">⇓</button>
							<br>
							<button id="btnDismissGarrisonTurkopol" class="btnDismiss" onclick="game.dismissGarrisonTurkopol()" onmouseover="game.help(this)">X</button>
							<button id="btnDismissAllGarrisonTurkopols" class="btnDismiss" onclick="game.dismissAllGarrisonTurkopols()" onmouseover="game.help(this)">XX</button>
						</td>
						<td>
							<div><label class="lblHiringTroops" id="lblTabHiringTroopsKnightsGarrison">knights: </label></div><div id="lblGarnisonKnights" style="display: inline">0</div>
							<button class="btnArrow" id="btnMoveKnightToHero" onclick="game.moveKnightsToHero()" onmouseover="game.help(this)">↓</button>
							<button class="btnArrow" id="btnMoveAllKnightsToHero" onclick="game.moveAllKnightsToHero()" onmouseover="game.help(this)">⇓</button>
							<br>
							<button id="btnDismissGarrisonKnight" class="btnDismiss" onclick="game.dismissGarrisonKnight()" onmouseover="game.help(this)">X</button>
							<button id="btnDismissAllGarrisonKnights" class="btnDismiss" onclick="game.dismissAllGarrisonKnights()" onmouseover="game.help(this)">XX</button>
						</td>
						<td>
							<button class="btnArrow"  id="btnMoveAllTroopsToHero" onclick="game.moveAllTroopsToHero()" onmouseover="game.help(this)">⤋</button>
							<br>
							<button id="btnDismissAllGarrisonForces" class="btnDismiss" onclick="game.dismissAllGarrisonForces()" onmouseover="game.help(this)">XXX</button>
						</td>
					</tr>
					<tr id="trHeroHiringTroops" style="visibility: collapse">
						<td>
							<img id="imgHeroInHiringScreenKnight" style="display: none" src="resources/hero-knight.png" onmouseover="game.help(this)">
							<img id="imgHeroInHiringScreenMonk" style="display: none" src="resources/hero-monk.png" onmouseover="game.help(this)">
						</td>
						<td>
							<div><label class="lblHiringTroops" id="lblTabHiringTroopsSergeantsHeroSquad">sergeants: </label></div><div id="lblHeroSergeants" style="display: inline">0</div>
							<button class="btnArrow" id="btnMoveSergeantToGarrison" onclick="game.moveSergeantsToGarnison()" onmouseover="game.help(this)">↑</button>
							<button class="btnArrow" id="btnMoveAllSergeantsToGarrison" onclick="game.moveAllSergeantsToGarrison()" onmouseover="game.help(this)">⇑</button>
							<br>
							<button id="btnDismissHeroSergeant" class="btnDismiss" onclick="game.dismissHeroSergeant()" onmouseover="game.help(this)">X</button>
							<button id="btnDismissAllHeroSergeants" class="btnDismiss" onclick="game.dismissAllHeroSergeants()" onmouseover="game.help(this)">XX</button>
						</td>
						<td>
							<div><label class="lblHiringTroops" id="lblTabHiringTroopsTurkopolsHeroSquad">turkopols: </label></div><div id="lblHeroTurkopols" style="display: inline">0</div>
							<button class="btnArrow" id="btnMoveTurkopolToGarrison" onclick="game.moveTurkopolsToGarnison()" onmouseover="game.help(this)">↑</button>
							<button class="btnArrow" id="btnMoveAllTurkopolsToGarrison" onclick="game.moveAllTurkopolsToGarrison()" onmouseover="game.help(this)">⇑</button>
							<br>
							<button id="btnDismissHeroTurkopol" class="btnDismiss" onclick="game.dismissHeroTurkopol()" onmouseover="game.help(this)">X</button>
							<button id="btnDismissAllHeroTurkopols" class="btnDismiss" onclick="game.dismissAllHeroTurkopols()" onmouseover="game.help(this)">XX</button>
						</td>
						<td>
							<div><label class="lblHiringTroops" id="lblTabHiringTroopsKnightsHeroSquad">knights: </label></div><div id="lblHeroKnights" style="display: inline">0</div>
							<button class="btnArrow" id="btnMoveKnightToGarrison" onclick="game.moveKnightsToGarnison()" onmouseover="game.help(this)">↑</button>
							<button class="btnArrow" id="btnMoveAllKnightsToGarrison" onclick="game.moveAllKnightsToGarrison()" onmouseover="game.help(this)">⇑</button>
							<br>
							<button id="btnDismissHeroKnight" class="btnDismiss" onclick="game.dismissHeroKnight()" onmouseover="game.help(this)">X</button>
							<button id="btnDismissAllHeroKnights" class="btnDismiss" onclick="game.dismissAllHeroKnights()" onmouseover="game.help(this)">XX</button>
						</td>
						<td>
							<button class="btnArrow" id="btnMoveAllTroopsToGarrison" onclick="game.moveAllTroopsToGarrison()" onmouseover="game.help(this)">⤊</button>
							<br>
							<button id="btnDismissAllHeroForces" class="btnDismiss" onclick="game.dismissAllHeroForces()" onmouseover="game.help(this)">XXX</button>
						</td>
					</tr>
				</table>
			</div>
			-->
			<div id="tabBlackmarket" class="tab">
				<div>
					<div id="lblGoodsForSale">This blackmarket offers these goods for sale!</div>
					<div id="marketList"></div>
				</div>
				<div>
					<div id="lblGoodsForBuying">This blackmarket could buy your goods!</div>
					<div id="heroMarketList"></div>
				</div>
				<button id="btnLeaveBlackmarket" onclick="openTab(null, 'Explore')" style="width:160px; margin-left: 42px; margin-top: 10px;">Go to exploring!</button>
			</div>
			<div id="tabEvent" class="tab">
				<lbl id="lblEventDetails">

				</lbl>
				<br>
				<button id="btnToEventLeaderboard" class="interface" style="width:160px; top: 490px; left:50px;" onclick="game.openLeaderboard()">Open Leaderboard</button>
			</div>
			<div id="feedbackForm" class="tab">

			</div>
			<div id="tabEventLeaderboard" class="tab">
				<div id="lblEventLBDetails">

				</div>
				<button id="btnToEvent" class="interface" style="width:160px; top: 490px; left:50px;" onclick="openTab(null, 'tabEvent')">Back</button>
			</div>
			<div id="tabEventReward" class="tab">
				<lbl id="lblEventReward">

				</lbl>
			</div>
			<div id="Discord" class="tab">
				<iframe src="https://discordapp.com/widget?id=564554640755130409&theme=light" width="800" height="480" allowtransparency="true" frameborder="0"></iframe>
			</div>
			<div id="audio" class="tab">
				<audio id="fireAudio0">
					<source src="sounds/sfx/3_sound_of_fire_0.mp3" type="audio/mpeg">
				</audio>
				<audio id="stableAudio0">
					<source src="sounds/sfx/16_sound_of_horse_neighing_0.mp3" type="audio/mpeg">
				</audio>
				<audio id="stableAudio1">
					<source src="sounds/sfx/16_sound_of_horse_neighing_1.mp3" type="audio/mpeg">
				</audio>
				<audio id="stableAudio2">
					<source src="sounds/sfx/16_sound_of_horse_neighing_2.mp3" type="audio/mpeg">
				</audio>
				<audio id="treasuryAudio0">
					<source src="sounds/sfx/10_sound_of_treasury_0.mp3" type="audio/mpeg">
				</audio>
				<audio id="treasuryAudio1">
					<source src="sounds/sfx/10_sound_of_treasury_1.mp3" type="audio/mpeg">
				</audio>
				<audio id="treasuryAudio2">
					<source src="sounds/sfx/10_sound_of_treasury_2.mp3" type="audio/mpeg">
				</audio>
				<audio id="archeryAudio0">
					<source src="sounds/sfx/14_sound_of_arrow_hitting_the_wooden_target_0.mp3" type="audio/mpeg">
				</audio>
				<audio id="archeryAudio1">
					<source src="sounds/sfx/14_sound_of_arrow_hitting_the_wooden_target_1.mp3" type="audio/mpeg">
				</audio>
				<audio id="archeryAudio2">
					<source src="sounds/sfx/14_sound_of_arrow_hitting_the_wooden_target_2.mp3" type="audio/mpeg">
				</audio>
				<audio id="fountainAudio0">
					<source src="sounds/sfx/1_sound_of_fountain_0.mp3" type="audio/mpeg">
				</audio>
				<audio id="innAudio0">
					<source src="sounds/sfx/9_sound_of_inn_0.mp3" type="audio/mpeg">
				</audio>
				<audio id="gallowsAudio0">
					<source src="sounds/sfx/2_sound_of_gallows_0.mp3" type="audio/mpeg">
				</audio>
				<audio id="sawmillAudio0">
					<source src="sounds/sfx/11_sawmill_sound_0.mp3" type="audio/mpeg">
				</audio>
				<audio id="sawmillAudio1">
					<source src="sounds/sfx/11_sawmill_sound_1.mp3" type="audio/mpeg">
				</audio>
				<audio id="sawmillAudio2">
					<source src="sounds/sfx/11_sawmill_sound_2.mp3" type="audio/mpeg">
				</audio>
				<audio id="plagueAudio0">
					<source src="sounds/sfx/7_sound_of_dying_people_0.mp3" type="audio/mpeg">
				</audio>
				<audio id="stealingAudio0">
					<source src="sounds/sfx/6_sound_of_stealing_gold_0.mp3" type="audio/mpeg">
				</audio>
			</div>
			<div id="tabDebugging" class="tab">
				<div id="inpTable">

				</div>
				<div id="outTable">
				</div>
			</div>
			<!-- Canvas modal -->
			<canvas id="myDCanvas" width="700" height="200" class="canvas-modal">
				Your browser does not support the HTML5 canvas tag.
			</canvas>
		</div>

		<div class="info-panel">
			<div class="info-panel__actions">
				<button id="log_btn"  class="btn" onclick="openLog()">log</button>
				<button id="chat_btn" class="btn" onclick="openChat()">chat</button>
				<button id="mod_btn"  class="btn" onclick="openTab(null, 'tabModTools')" style="visibility: hidden">mod</button>
				<div id="lbl_online">Online: <span id="lbl_online_value">n/d</span></div>
			</div>
			<div id="log"  name="log"		class="info-panel__history"></div>
			<div id="chat" name="chat" 	class="info-panel__history"></div>
			<div id="chatForm" class="info-panel__form">
				<input id="inp_nickname"/>
				<div class="info-panel__form-msg">
					<input id="msg_out"/>
				</div>
				<button id="btnSend" onclick="sendOnClick2()" class="btn">Send</button>
			</div>
		</div>
</div>
<!--TOWN CANVAS-->

<script>
	// 1. Выносим сюда utils функции

	function getCurrentDate() {
		if (!Date.now) {
			Date.now = function now() {
				return new Date().getTime();
			};
		} else {
			return Date.now();
		}
	}

	function getUID() {
		var rnd = Math.floor((Math.random() * 100000) + 1);
		while (rnd.toString().length < 5) {
			rnd = "0"+rnd;
		}
		return getCurrentDate().toString()+rnd;
	}

	function genNick() {
		var rnd = Math.floor((Math.random() * 10000) + 1);
		while (rnd.toString().length < 4) {
			rnd = "0"+rnd;
		}
		nickName = "Guest"+rnd;
		return nickName;
	}


	function include (url, fn) {
		var e = document.createElement("script");
		e.onload = fn;
		e.src = url;
		e.async=true;
		document.getElementsByTagName("head")[0].appendChild(e);
	};

	//gameconfig
	var config = {
		startPop: 6,
		costWall:2,
		costTower:8,
		costCastle:24,
		costHome:2,
		costTreasury:20,
		costGallows:50,
		costFountain:50,
		costStash:50,
		costInn:20,
		costStable:50,
		costSmith:50,
		costArchery:50,
		bldUniversityCost: 200,
		lotteryPrize:50,
		treasuryGuardPriceHire:20,
		treasuryGuardPricePayroll:10,
		costPutOutFire:20,
		sizeMapX:18,//18
		sizeScrX:16,//16
		sizeMapY:18,//18
		sizeScrY:10,//10
		costHero:20,
		heroExpK:5,
		festPrice:2,
		festCooldown:30,
		glSaveVersion:9,
		genMapCostBasic:50,
		// fireStepsBasic:60,
		oneSecMS:1000,
		sergeantHiring:20,
		sergeantUpkeep:5,
		turkopolHiring:20,
		turkopolUpkeep:5,
		knightHiring:40,
		knightUpkeep:8,
		chestMoney:25,
		chestCity_timeout:15000,//ms
		chestCity:50,
		maxLevelHome: 40,
		maxLevelTreasury: -1, //Not limited
		maxLevelStash: -1, //Not limited
		maxLevelGallows: 10,
		maxLevelFountain: 10,
		maxLevelInn: 10,
		maxLevelStable: 3,
		maxLevelArchery: 3,
		maxLevelUniversity: 1,
		tutorialDefenseEventTicks: 3,
		tutNewBuildingsT: 5,
		tutTreasuryG: 200,
		tutAutoSaveT: 10,
		tutStablesP: 40,
		tutArcheryP: 60,
		tutInnP: 80,
		tutSocialP: 100,
		online: true,
		pullMessages: true,
		pullMessagesMS: 1500,
		debug: false,
		theme: "winter",
		artilleryResearchCost: 200,
		popIncRate: 2,

	};
	var game = {
		gold: 30,
		gems: 0,
		pop: config.startPop,
		season: 2, //1 - Winter, 2 - Spring, 3 - Summer, 4 - Autumn
		year: 1255,
		food: 20,
		treasuryGuard: 0,
		buildLevelD: 0,
		buildLevelH: 0,
		buildLevelTreasury: 0,
		buildLevelGallows: 0,
		buildLevelFountain: 0,
		buildLevelStash: 0,
		buildLevelInn: 0,
		buildLevelStable: 0,
		buildLevelArchery: 0,
		buildLevelSmith: 0,
		buildLevelUniversity: 0,
		fire: 0,
		fireSteps: 0,
		fireGuard: 0,
		hero: 0,
		happiness: 80,
		o_autosave: 0,
		newSaveVersion: 8,
		saveVersion: "saveV1010",
		castleX: 1,
		castleY: 1,
		heroX: 1,
		heroY: 1,
		mapCreated: 0,
		myMapLand: [],
		myMapObjects: [],
		myMapRemObjects: [],
		years: [],
		pops: [],
		budgets: [],
		adv_steps: 0,
		ac_steps: 0,
		userPopAck: 0,
		userGoldAck: 0,
		userASaveAck: 0,
		blackMarketGoods: [],
		isHero: 0,//do I need this?
		cityWarehouse: [], //should the list contain objects?
		myhero: {},
		myheroArmy: {armyID: 1, units: {}},
		castellan: {},
		festival_cooldown: 0,
		sergeants: 0,
		turkopols: 0,
		knights: 0,
		active_tab: '',
		prestige: 0,
		prestige_time: [],
		isMobile: 0,
		sfx_all: 0,
		sfx_events: 0,
		sfx_actions: 0,
		music_all: 0,
		music_scripts: 0,
		log_size: 8,
		alias: "",
		UID: getUID(),
		nickname: genNick(),
		tips: [],
		story: [],
		chestCity: 0,
		ticks: 0,
		autocampaignCounter: 0,
		autocampaignBattlesCounter: 0,
		enemyHero: null,
		enemyHeroArmy: {armyID: 2, units: {}},
		enemyMaxArmyCount: 3,
		expReward: 0,
		goldReward: 0,
		difficultyModifier: 0,
		attacker: 1,
		isAutoBattle: false,
		isDefeated: false,
		nightMode: false,
		monstersOnAdvMap: [],
		techLearned: [],
		techEnabled: [],
		techDisabled: [],
		techArtillery: 0,
		role: "player",
		isTutorialState: true,
		changeUpkeepSrc : function () {
			var x         = document.getElementById("selectUpkeepSrc").selectedIndex;
			var y         = document.getElementById("selectUpkeepSrc").options;
			var upkeepSrc = parseInt(y[x].value); //y[x].id, text, index
			if (upkeepSrc === 0){
				game.myhero.upkeepsrc = 0;
			} else {
				game.myhero.upkeepsrc = 1;
			}
		},
		openLeaderboard : function () {
			game.getEventLeaderboard();
			openTab(null, 'tabEventLeaderboard');
		},
		festivalPrice : function () {
			return game.pop*config.festPrice*(game.buildLevelTreasury+1)*(game.buildLevelFountain+1);
		},
		checkTreasuryCapacity : function() {
			if(game.heroExists()) {
				if (game.gold+game.myhero.gold > game.goldLimit()) {
					postEventLog(locObj.moneyExceedsTreasury.txt, "bold");
				}
			} else {
				if (game.gold > game.goldLimit()) {
					postEventLog(locObj.moneyExceedsTreasury.txt, "bold");
				}
			}
		},
		addMoneyToTreasury : function (changeValue) {
			var gold_was      = game.gold;
			var gold_limit    = game.goldLimit();
			var gold_possible = game.gold+changeValue;
			if (gold_possible > gold_limit) {
				game.gold      = gold_limit;
				if (game.userGoldAck === 0) {
					postEventLog(locObj.buildUpgradeTreasury.txt, "bold");
					game.userGoldAck = 1;
				}
			} else {
				game.gold      = gold_possible;
				game.userGoldAck = 0;
			}
			return game.gold - gold_was;
		},
		getReward : function () {
			back_response_reward = null;
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState === 4 && this.status === 200) {
					back_response_reward = JSON.parse(this.responseText);
					textToTab  = back_response_reward["msgToPlayer"];
					game.gems += back_response_reward["gems"];
					game.gems += back_response_reward["prize_v"];
					document.getElementById("lblEventReward").innerHTML = textToTab;
					openTab(null, "tabEventReward");
					updateUI();
				}
			};
			dataToParse = game.UID;
			xhttp.open("POST", "http://armata.ga:5000/api/v1.0/get_reward", true);
			xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xhttp.send(dataToParse);
		},
		sendSaveToTheCloud : function (lastHope_str) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState === 4 && this.status === 200) {
					msg = "savegame sent to the cloud successfully";
					postEventLog(msg);
				}
			};
			dataToParse = game.UID;
			xhttp.open("POST", "http://51.68.172.115:9090/lasthope", true);
			xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xhttp.send(lastHope_str);
		},
		updateAlias : function () {
			proposedAlias = document.getElementById("inpStnAliasValue").value;
			console.log(proposedAlias);
			back_response_alias = null;
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState === 4 && this.status === 200) {
					back_response_alias = JSON.parse(this.responseText);
					console.log(back_response_alias);
					if (back_response_alias["content"]===200) {
						document.getElementById("lblStnAliasResult").innerText=localeStrings[88][0];
						game.alias = document.getElementById("inpStnAliasValue").value;
					}
					if (back_response_alias["content"]===201) {
						document.getElementById("lblStnAliasResult").innerText=localeStrings[88][1];
						game.alias = document.getElementById("inpStnAliasValue").value;
					}
					if (back_response_alias["content"]===204) {
						document.getElementById("lblStnAliasResult").innerText=localeStrings[88][2];
						document.getElementById("inpStnAliasValue").value = "";
					}
					setTimeout(function(){ document.getElementById("lblStnAliasResult").innerText=""; }, 5000);
				} else {
					game.alias = document.getElementById("inpStnAliasValue").value;
				}
			};
			dataToParse = game.UID+delimiter+game.alias+delimiter+proposedAlias;
			xhttp.open("POST", "http://armata.ga:5000/api/v1.0/register_alias", true);
			xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xhttp.send(dataToParse);
		},
		getEventHelp : function () {
			if (eventHelpMsg!==null) {
				if (flag_event_started===0){
					disabledElements.push("saveGameButton");
					disabledElements.push("loadGameButton");
					document.getElementById("saveGameButton").disabled = true;
					document.getElementById("loadGameButton").disabled = true;
					showModal(0, '', getAck, eventHelpMsg,  localeStrings[60], '');
				} else {
					openTab(null, 'tabEvent');
				}
			}
		},
		setupEventLogSize : function () {
			game.log_size = document.getElementById("inpStnEventLogSize").value;
			document.getElementById("log").style.height = game.log_size * 20;
		},
		mobileUI : function () {
			if (document.getElementById("cbMobileUI").checked === true) {
				game.isMobile = 1;
			} else {
				game.isMobile = 0;
			}
		},
		setupFirebrigade : function (theValue) {
			game.fireGuard = theValue;
		},
		fireGuardUpkeep : function () {
			var totalBGUpkeep = 0;
			totalBGUpkeep    += 5*(game.buildLevelD+game.buildLevelH+game.buildLevelTreasury);
			totalBGUpkeep    += 5*(game.buildLevelGallows+game.buildLevelFountain+game.buildLevelStash);
			totalBGUpkeep    += 5*(game.buildLevelInn+game.buildLevelStable+game.buildLevelArchery);
			return totalBGUpkeep;
		},
		towngate : function () {
			if (game.myhero.aCampaignBackward===1){
				var theTowngateIndex = game.myhero.inventory.indexOf("artid00");
				if (theTowngateIndex!==-1){
					game.artefact_loss(null, "hero", theTowngateIndex);
					game.myhero.aCampaignLong = 1;
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[255]);
					postEventLog(msg);
					updateUI();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[256]);
					postEventLog(msg);
				}
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1",localeStrings[257]);
				postEventLog(msg);
			}
		},
		artefact_sell : function () {
			var x = document.getElementById("selectGoodsFromHero").selectedIndex;
			var y = document.getElementById("selectGoodsFromHero").options;
			if (y !== -1 && x!==y ){
				var the_selling_artefact      = y[x].value; //y[x].id, text, index
				var the_selling_artefactIndex = y[x].index; //y[x].id, text, index
				buyingPrice = artefacts[the_selling_artefact].priceBuy/2;
				game.myhero.gold += buyingPrice;
				game.checkTreasuryCapacity();
				game.artefact_loss(artefacts[the_selling_artefact], "hero", the_selling_artefactIndex);
				if (artefacts[the_selling_artefact].id!=="artid00"){
					game.blackMarketGoods.push(artefacts[the_selling_artefact].id);
				}
				updateBlackMarket(null,the_selling_artefactIndex);
				msg = localeStrings[230];
				postEventLog(msg);
				updateUI();
			}
		},
		artefact_buy : function () {
			var x = document.getElementById("selectGoodsForHero").selectedIndex;
			var y = document.getElementById("selectGoodsForHero").options;
			var the_buying_artefact      = y[x].value; //y[x].id, text, index
			var the_buying_artefactIndex = y[x].index; //y[x].id, text, index
			if (game.gold>=artefacts[the_buying_artefact].priceBuy){
				game.gold = game.gold - artefacts[the_buying_artefact].priceBuy;
				game.artefact_gain(artefacts[the_buying_artefact], "hero");
				if (artefacts[the_buying_artefact].id !== "artid00"){
					game.blackMarketGoods = deleteFromArray(game.blackMarketGoods, the_buying_artefactIndex);
					updateBlackMarket(the_buying_artefactIndex,null);
				} else {
					updateBlackMarket(null,null);
				}
				msg = localeStrings[231];
				postEventLog(msg);
				updateUI();
			} else {
				postEventLog(locObj.notEnoughGold.txt, "bold");
			}
		},
		artefact_gain : function (artefact, target) {
			if (target==="hero") {
				game.myhero.inventory.push(artefact.id);
				if (game.myhero.inventoryWorn===undefined){
					game.myhero.inventoryWorn=[];
				}
				game.myhero.inventoryWorn.push(0);
			}

		},
		artefact_loss : function (artefact, target, posInInventory) {
			if (target==="hero") {
				game.myhero.inventory     = deleteFromArray(game.myhero.inventory, posInInventory);
				game.myhero.inventoryWorn = deleteFromArray(game.myhero.inventoryWorn, posInInventory);
			}
		},
		artefact_equip : function (invid, target) {
			if (target==="hero") {
				for (var i=0;i<artefacts[game.myhero.inventory[invid]].attr.length;i++){
					game.myhero[artefacts[game.myhero.inventory[invid]].attr[i]]+=artefacts[game.myhero.inventory[0]].change[i];
					game.myhero.inventoryWorn[invid]=1;
					console.log(artefacts[game.myhero.inventory[invid]].attr[i]);
				}
			}
		},
		artefact_unequip : function (invid, target) {
			if (target==="hero") {
				for (var i = 0; i < artefacts[game.myhero.inventory[invid]].attr.length; i++) {
					game.myhero[artefacts[game.myhero.inventory[invid]].attr[i]] -= artefacts[game.myhero.inventory[0]].change[i];
					game.myhero.inventoryWorn[invid] = 0;
					console.log(artefacts[game.myhero.inventory[invid]].attr[i]);
				}
			}
		},
		checkAudio : function (typeAudio, target) {
			if (typeAudio==='sfx'){
				if (target==='all'){
					if (game.sfx_all===1){
						return true;
					} else {
						return false;
					}
				}
				if (target==='events'){
					if (game.sfx_events===1){
						return true;
					} else {
						return false;
					}
				}
				if (target==='actions'){
					if (game.sfx_actions===1){
						return true;
					} else {
						return false;
					}
				}
			}
			if (typeAudio==='music'){
				if (target==='all'){
					if (game.music_all===1){
						return true;
					} else {
						return false;
					}
				}
				if (target==='scripts'){
					if (game.music_scripts===1){
						return true;
					} else {
						return false;
					}
				}
			}
		},
		//WIP
		research : function (techName) {
			if (techName==="artillery"){
				if (game.techArtillery===0) {
					if (game.gold >= config.artilleryResearchCost) {
						game.gold -= config.artilleryResearchCost;
						game.techArtillery = 1;
						postEventLog(locObj.techArtilleryResearched.txt, "BOLD");
						updateUI();
					} else {
						//WE NEED MORE MONEY
					}
				} else {
					//ALREADY LEARNED
				}
			}
		},
		setupAudio : function (typeAudio, target, dvalue) {
			if (typeAudio==='sfx') {
				if (target==='all') {
					if (dvalue===1) {
						game.sfx_all       = 1;
						game.sfx_events    = 1;
						game.sfx_actions   = 1;
					}
					if (dvalue===0) {
						game.sfx_all       = 0;
					}
				}
				if (target==='events') {
					if (dvalue===1) {
						game.sfx_events    = 1;
						game.sfx_actions   = 1;
					}
					if (dvalue===0) {
						game.sfx_all       = 0;
						game.sfx_events    = 0;
					}
				}
				if (target==='actions') {
					if (dvalue===1) {
						game.sfx_actions   = 1;
					}
					if (dvalue===0) {
						game.sfx_all       = 0;
						game.sfx_events    = 0;
						game.sfx_actions   = 0;
					}
				}
			}
			if (typeAudio==='music') {
				if (target==='all') {
					if (dvalue===1) {
						game.music_all     = 1;
						game.music_scripts = 1;
					}
					if (dvalue===0) {
						game.music_all     = 0;
					}
				}
				if (target==='scripts') {
					if (dvalue===1) {
						game.music_scripts = 1;
					}
					if (dvalue===0) {
						game.music_all     = 0;
						game.music_scripts = 0;
					}
				}
			}
			setupAudioUI();
		},
		genBlackMarketGoods : function () {
			return new Promise(function (resolve) {
				var artefactIds = ['artid00']; // Always set artid00 as default market item. For now...
				var rnd = randomFromRange(11, 13);
				if (rnd.toString().length < 2) {
					rnd = "0"+rnd;
				}
				var id = "artid" + rnd;

				artefactIds.push(id);
				resolve(artefactIds);
			});
		},
		generateMap : function () {
			var genMapPriceFinal = Math.pow((game.buildLevelInn+2)*(game.buildLevelTreasury+2),2)*config.genMapCostBasic/2;
			if (game.heroExists()===true) {
				if (game.myhero.status !== 2) {
					var question      = localeStrings[179];
					question          = question.replace("%arg1", genMapPriceFinal);
					showModal(1, '', game.generateMapCallback, question, localeStrings[32], localeStrings[33])
				} else {
					alertMsg = localeStrings[180];
					showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
				}
			} else {
				var question      = localeStrings[179];
				question          = question.replace("%arg1", genMapPriceFinal);
				showModal(1, '', game.generateMapCallback, question, localeStrings[32], localeStrings[33])
			}
		},
		generateMapCallback : function (silent) {
			//generate landscape
			var genMapPriceFinal = Math.pow((game.buildLevelInn+2)*(game.buildLevelTreasury+2),2)*config.genMapCostBasic/2;
			if (silent===true) {
				genMap(0);
			} else {
				if (answer === 2) {
					if (game.gold >= genMapPriceFinal) {
						genMap(genMapPriceFinal);
						postEventLog(localeStrings[168]);
						updateUI();
					} else {
						alertMsg = locObj.notEnoughGold.txt;
						showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
					}
				}
			}
		},
		checkMonsters : function () {
			//WIP
			for (index = 0; index < game.monstersOnAdvMap.length; ++index) {
				if (Math.abs(game.heroY-game.monstersOnAdvMap[index].coordy)<=1) {
					if (Math.abs(game.heroX-game.monstersOnAdvMap[index].coordx)<=1) {
						if (Math.abs(game.heroY-game.monstersOnAdvMap[index].coordy)===1&&Math.abs(game.heroX-game.monstersOnAdvMap[index].coordx)===1){
							//do nothing
						} else {
							console.log("movement a monster toward the hero");
							game.myMapRemObjects[game.heroX][game.heroY]=41;//hero tile in attacked state
							//prepare for battle!
							//generate enemy squad
							if (Object.keys(game.enemyHeroArmy.units).length === 0) {
								game.generateEnemyUnitsForBattle("AdvMap");
							}
							game.isAutoBattle = true;
							while(game.isAutoBattle) {
								game.calcAttackPhase("AdvMap");
							}
							//suppose we win the battle
							//removing the monster from removable objects (render array)
							game.myMapRemObjects[game.monstersOnAdvMap[index].coordx][game.monstersOnAdvMap[index].coordy] = 0;
							//removing the monster object from monsters array
							game.monstersOnAdvMap.splice(index, 1);
							composite_gm();
							break;
						}
					}
				}
			}
		},
		checkCollisionWithBordersOfMap : function (changeX, changeY) {
			if (game.heroX+changeX<0){
				return true;
			}
			if (game.heroY+changeY<0){
				return true;
			}
			if (game.heroX+changeX>config.sizeMapX-1){
				return true;
			}
			if (game.heroY+changeY>config.sizeMapY-1){
				return true;
			}
			return false;
		},
		checkCollisionWithNonRemovableObstacles : function (changeX, changeY) {
			if (game.myMapObjects[game.heroX+changeX][game.heroY+changeY]===0) {
				return false;
			} else {
				if (game.myMapObjects[game.heroX+changeX][game.heroY+changeY]===10){
					return false;//we can enter the castle!
				}
				if (game.myMapObjects[game.heroX+changeX][game.heroY+changeY]===4){
					return false;//we can enter the blackmarket!
				}
				if (game.myMapObjects[game.heroX+changeX][game.heroY+changeY]===41){
					return false;//we can step over the burned blackmarket!
				}
				return true;
			}
		},
		checkColissionWithRemovableObstacles : function () {
			if (game.myMapRemObjects[game.heroX][game.heroY]===1) {
				postEventLog(localeStrings[186]+config.chestMoney);
				game.myhero.gold += config.chestMoney;
				game.checkTreasuryCapacity();
				updateUI();
			}
			if (game.myMapRemObjects[game.heroX][game.heroY]===2) {
				postEventLog(localeStrings[58][0]);
				eventItemCollected();
			}
		},
		tryHeroMovement : function (changeX, changeY) {
			if (game.checkCollisionWithBordersOfMap(changeX, changeY)===false) {
				if (game.checkCollisionWithNonRemovableObstacles(changeX, changeY)===false) {
					game.myMapRemObjects[game.heroX][game.heroY] = 0;
					game.heroX = game.heroX + changeX;
					game.heroY = game.heroY + changeY;
					game.checkColissionWithRemovableObstacles();
					game.myMapRemObjects[game.heroX][game.heroY] = 40;
					if (game.heroX===game.castleX && game.heroY===game.castleY) {
						game.cityEnter();
					}
					if (game.myMapObjects[game.heroX][game.heroY]===4) {
						if (!game.tips.includes("blackmarket")){
							game.tips.push("blackmarket");
							showModal(1, '', game.blackmarketCallback, locObj.blackmarket_dstr.txt, locObj.blackmarket_dstr_brn.txt, locObj.blackmarket_dstr_kp.txt);
						} else {
							updateUI();
							openTab(null, 'tabBlackmarket');
						}
					}
					game.checkMonsters();
					composite_gm();
					game.adv_steps += 1;
					if (game.adv_steps === 2) {
						//STORY
						if (!game.story.includes("story_two_steps")){
							game.story.push("story_two_steps");
							showModal(0, '', getAck, locObj.story2_two_steps.txt, locObj.okay.txt, '');
						}
					}
				}
			} else {
				postEventLog(locObj.borderCollide.txt, "BOLD");
			}
		},
		blackmarketCallback : function () {
			if (answer === 2) {
				//BURN THE MARKET DOWN
				game.myMapObjects[game.heroX][game.heroY]=41;//blackmarket burned down
			}
			if (answer === 3) {
				updateUI();
				openTab(null, 'tabBlackmarket');
			}
		},
		cityLeave : function () {
			cityLeaveSmall();
			function cityLeaveSmall() {
				if (game.heroExists()===true && game.myhero.status === 0) {
					if (game.isHeroHaveTroops() === true) {
						var question = localeStrings[225];
						showModal(1, '', game.cityLeaveCallback, question, localeStrings[226], localeStrings[227]);
					} else {
						alertMsg = localeStrings[228];
						showModal(0, '', getAck, alertMsg, localeStrings[60], '');
					}
				} else {
					if (game.heroExists() === true && game.myhero.status === 2) {
						console.log("just open the adv map, please!");
						openTab(null, 'Explore');
						updateUI();
						composite_gm();
					}
				}
			}
		},
		cityLeaveCallback : function () {
			if (answer === 2) {
				game.myhero.stance = 0;
			}
			if (answer === 3) {
				game.myhero.stance = 1;
			}
			game.myhero.status = 2;
			game.myMapRemObjects[game.heroX][game.heroY] = 0;
			game.heroX = game.castleX;
			game.heroY = game.castleY + 1;
			game.myMapRemObjects[game.heroX][game.heroY] = 40;
			openTab(null, 'Explore');
			updateUI();
			composite_gm();
			if (!game.tips.includes("adventure_map")){
				game.tips.push("adventure_map");
				showModal(0, '', getAck, locObj.advmap.txt, locObj.okay.txt, '');
			}
		},
		cityEnter : function () {
			if (game.heroExists()===true && game.myhero.status === 2) {
				game.myhero.status = 0;
				var gold_diff = game.addMoneyToTreasury(game.myhero.gold);
				if (gold_diff!==game.myhero.gold){
					postEventLog(localeStrings[89].replace("%arg1", gold_diff));
				}
				game.myhero.gold = 0;
				updateResources();
				openTab(null, 'Main');
				updateUI();
			}
		},
		/*-- New: Used for adding troops to squads on autocamp. start and after recalc of enemy troops when autobattle is over (if gamer is won the battle of course) --*/
		genUnitStack: function(unit, count, squad) {
			var stackName = unit.name;
			if (squad && squad.hasOwnProperty(stackName)) {
				squad[stackName].count += count;
				squad[stackName].stackHealth = squad[stackName].health * squad[stackName].count;
			} else {
				squad[stackName] = Object.assign({}, unit);
				Object.defineProperty(squad[stackName], 'count', {value: count, writable: true, configurable: true, enumerable: true});
				Object.defineProperty(squad[stackName], 'stackHealth', {value: squad[stackName].health * squad[stackName].count, writable: true, configurable: true, enumerable: true})
			}
		},
		generateEnemyUnitsForBattle: function(campaignType) {
			game.goldReward = 0;
			game.expReward = 0;
			var myheroTotalUnits = game.myhero.turkopols + game.myhero.sergeants + game.myhero.knights;
			var enemyMaxCount = null;
			// TODO: Refactor this section later
			if (campaignType === "AdvMap") {
				console.log('GEN for advmap')
				enemyMaxCount = randomFromRange(myheroTotalUnits, myheroTotalUnits * 2);
				if (game.myhero.stance === 0) {
					game.difficultyModifier = 1.05;
					// TEMP SECTION just for adv map with autobattle
					grolinWorker.health = Math.round(1.25 * grolinWorker.health);
					grolinWorker.minDmg = Math.round(1.25 * grolinWorker.minDmg);
					grolinWorker.maxDmg = Math.round(1.25 * grolinWorker.maxDmg);
					enemyRandomizer.addEntry(grolinWorker, 100.0);
				} else {
					game.difficultyModifier = 0.35;
					enemyRandomizer.addEntry(grolinWorker, 100.0);
				}
			} else {
				console.log('GEN for autocampaign')
				enemyMaxCount = randomFromRange(myheroTotalUnits, myheroTotalUnits * 2)
				if (game.myhero.stance === 0) {
					game.difficultyModifier = 1.05;
					enemyRandomizer.addEntry(banditWarrior, 35.0);
					enemyRandomizer.addEntry(banditArcher,  35.0);
					enemyRandomizer.addEntry(mercSwordman,  15.0);
					enemyRandomizer.addEntry(mercSpearmen,  15.0);
				} else {
					game.difficultyModifier = 0.35;
					enemyRandomizer.addEntry(banditWarrior, 50.0);
					enemyRandomizer.addEntry(banditArcher, 50.0);
				}
			}
			for (var i = 0; i < enemyMaxCount; i++) {
				var unit = enemyRandomizer.getRandom();
				game.expReward += Math.round(unit.health * game.difficultyModifier);
				game.goldReward += Math.round(randomFromRange(4, unit.health) * game.difficultyModifier);
				game.genUnitStack(unit, 1, game.enemyHeroArmy.units);
			}
			if (game.myhero.inventory.length) {
				for (var i = 0; i < game.myhero.inventory.length; i++) {
					if (game.myhero.inventory[i].id === "artid13") {
						game.goldReward = Math.round(game.goldReward * game.myhero.inventory[i].attr[0].val);
						break;
					}
				}
			}
			console.log("%c NEW ENEMY ARMY: ", "color: red;", game.enemyHeroArmy)
		},
		restoreHealth: function() {
			for (unitKey in game.myheroArmy.units) {
				if (game.myheroArmy.units.hasOwnProperty(unitKey)) {
					game.myheroArmy.units[unitKey].stackHealth = game.myheroArmy.units[unitKey].health * game.myheroArmy.units[unitKey].count;
				}
			}
		},
		checkWinner: function(campaignType) {
			console.log("%c CHECKING WINNER!", "color: #333; background: red");
			if (game.attacker === 1 && !game.isAutoBattle) {
				if (campaignType === "AutoCampaign") {
					if (game.myhero.stance === 1) {
						postJournalLog(localeStrings[174]);
					} else {
						postJournalLog(localeStrings[173]);
					}
				}
				console.log('123: ', campaignType)
				console.log("The player is the winner");
				game.myhero.gold += game.goldReward;
				game.myhero.exp += game.expReward;
				game.restoreHealth();
				game.generateEnemyUnitsForBattle(campaignType);
				if (campaignType !== "AutoCampaign") {
					game.heroLvlUp("AdvMap");
					updateUI();
				}
			} else {
				if (campaignType === "AutoCampaign") {
					if (game.myhero.stance === 0) {
						postJournalLog(localeStrings[172]);
						game.heroDie();
						game.myheroArmy = {armyID: 1, units: {}};
					} else {
						game.myhero.aCampaignForward   = 0;
						game.myhero.aCampaignBackward  = 1;
						game.myheroArmy = {armyID: 1, units: {}};
						game.myhero.knights   = 0;
						game.myhero.sergeants = 0;
						game.myhero.turkopols = 0;
						game.isDefeated = true;
					}
				} else {
					if (game.myhero.stance === 0) {
						game.heroDie();
						game.myheroArmy = {armyID: 1, units: {}};
						postEventLog("The hero has been defeated", "bold");
						openTab(event, 'Main');
					} else {
						//!BUG!
						game.myheroArmy = {armyID: 1, units: {}};
						game.myhero.knights   = 0;
						game.myhero.sergeants = 0;
						game.myhero.turkopols = 0;
						game.myhero.status    = 0;
						postEventLog("The hero has been defeated, but managed out to flee from the battlefield", "bold");
						openTab(event, 'Main');
						game.isDefeated = true;
					}
				}
				console.log("The PC opponent is the Winner");
			}
		},
		calcDmg: function(attackerSquad, attackerHeroAttack, defenderSquad, defenderHeroDefence) {
			var attackVal = attackerHeroAttack + attackerSquad.attack;
			var defenceVal = defenderHeroDefence + defenderSquad.defence;
			console.log(attackVal);
			console.log(defenceVal);
			var battleDiff = attackVal - defenceVal;
			var totalDMG = 0;
			if (battleDiff >= 0) {
				if (battleDiff > 20) battleDiff = 20;
				for (var i = 0; i < attackerSquad.count; i++) {
					var randDMG = randomFromRange(attackerSquad.minDmg, attackerSquad.maxDmg) * (1 + 0.1 * battleDiff);
					console.log("RAND DMG: ", randDMG);
					totalDMG += randDMG;
				}
			} else {
				if (battleDiff < -17) battleDiff = -17;
				for (var i = 0; i < attackerSquad.count; i++) {
					var randDMG = randomFromRange(attackerSquad.minDmg, attackerSquad.maxDmg) * (1 + 0.05 * battleDiff);
					console.log("RAND DMG: ", randDMG);
					totalDMG += randDMG;
				}
			}
			console.log("TOTAL DMG test: ", totalDMG);
			return totalDMG
		},
		unitNameLoc: function (name) {
			switch (name) {
				case "sergeants": return locObj.unit_sergeants.txt;
				case "turkopols": return locObj.unit_turkopols.txt;
				case "knights": return locObj.unit_knights.txt;
				case "bandit": return locObj.unit_bandit.txt;
				case "banditArcher": return locObj.unit_bandit_archer.txt;
				case "mercSwordman": return locObj.unit_merc_swordman.txt;
				case "mercSpearmen": return locObj.unit_merc_spearman.txt;
				case "Grolin worker": return locObj.unit_goblin.txt;
				default: return "Unknown unit name";
			}
		},
		calcAutoBattle: function(attackerStack, attackerHeroAttack, defenderStack, defenderHeroDefence, campaignType) {
			console.log('--Attack start --');
			var startRoundStr = locObj.autobattle_journal_log_start.txt;
			var endRoundStr = locObj.autobattle_journal_log_end.txt;
			if (campaignType==="AutoCampaign") {
				postBattleLog(startRoundStr);
			}
			for (var attackerKey  in attackerStack.units) {
				if (attackerStack.units.hasOwnProperty(attackerKey)) {
					console.log('Attacker: ', attackerStack.units[attackerKey]);
					for (var defenderKey in defenderStack.units) {
						if (defenderStack.units.hasOwnProperty(defenderKey)) {
							var target = defenderStack.units[defenderKey];
							var dmg = game.calcDmg(attackerStack.units[attackerKey], attackerHeroAttack, defenderStack.units[defenderKey], defenderHeroDefence);
							console.log('DMG before round: ', dmg);
							dmg = Math.round(dmg);
							console.log(dmg);
							var attackerStr = locObj.autobattle_journal_log_dmg.txt.replace("%arg1", game.unitNameLoc(attackerStack.units[attackerKey].name)).replace("%arg2", dmg).replace("%arg3", game.unitNameLoc(target.name));
							if (dmg >= target.stackHealth) {
								console.log(`${target.name} is dying`);
								delete defenderStack.units[defenderKey];
								console.log("%c DEFENDER UNITS LIST: ", "background: purple; color: #ededed", defenderStack.units);
								attackerStr += ' '  + locObj.autobattle_journal_log_destroyed.txt.replace("%arg1", game.unitNameLoc(target.name));
								if (campaignType==="AutoCampaign") {
									postBattleLog(attackerStr);
								}
								if (isEmptyObj(defenderStack.units)) {
									game.isAutoBattle = false;
									game.checkWinner(campaignType);
									if (campaignType === "AutoCampaign") {
										game.attacker = 0;
									}
								}
							} else {
								var defenderLooses = parseInt(dmg / defenderStack.units[defenderKey].health);
								defenderStack.units[defenderKey].count -= defenderLooses;
								target.stackHealth -= dmg;
								if (defenderLooses > 0) {
									attackerStr += ' ' + locObj.autobattle_journal_log_dead.txt.replace("%arg1", defenderLooses).replace("%arg2", game.unitNameLoc(target.name));
								}
								if (campaignType==="AutoCampaign") {
									postBattleLog(attackerStr);
								}
							}
						}
					}
				}
			}
			if (campaignType==="AutoCampaign") {
				postBattleLog(endRoundStr);
			}
			console.log('-- Attack turn ended --');
			console.log('-----------------------');
		},
		calcAttackPhase: function (campaignType) {
			var attackVal = 0;
			var defenceVal = 0;
			if (game.attacker === 1) {
				if (game.myhero.atk) {
					attackVal = game.myhero.atk;
				}
				if (game.enemyHero && game.enemyHero.def) {
					defenceVal = game.enemyHero.def
				}
				console.log("%cENEMY ARMY FROM MAP: ", 'color: #333; background: #fc3; padding: 6px;', game.enemyHeroArmy);
				game.calcAutoBattle(game.myheroArmy, attackVal, game.enemyHeroArmy, defenceVal, campaignType);
				game.attacker = 2;
			} else if (game.attacker === 2) {
				if (game.enemyHero && game.enemyHero.atk) {
					attackVal = game.enemyHero.atk;
				}
				if (game.myhero.def) {
					defenceVal = game.myhero.def
				}
				game.calcAutoBattle(game.enemyHeroArmy, attackVal, game.myheroArmy, defenceVal, campaignType);
				game.attacker = 1;
			}
		},
		heroDismiss: function () {
			if (game.heroExists()===true){
				if (game.isHeroHaveTroops()) {
					var question      = localeStrings[177];
					showModal(1, '', game.heroDismissCallback, question, localeStrings[32],  localeStrings[178]);
				} else {
					game.heroDie();
				}
			} else {
				alertMsg = localeStrings[229];
				showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
			}
		},
		heroDismissCallback : function () {
			if (answer === 2){
				game.heroDie();
			}
		},
		hrSrgntsUpkp : function (sergeants) {
			return sergeants*config.sergeantUpkeep;
		},
		hrTrkplsUpkp : function (turkopols) {
			return turkopols*config.turkopolUpkeep;
		},
		hrKnghtsUpkp : function (knights) {
			return knights*config.knightUpkeep;
		},
		heroSquadUpkeep : function () {
			if (game.heroExists()) {
				if (game.myhero.upkeepsrc === 0) {
					paidTurkopols = 0;
					UnPaidTurkopols = 0;
					paidSergeants = 0;
					UnPaidSergeants = 0;
					paidKnights = 0;
					UnPaidKnights = 0;
					UnPaidTurkopols = game.myhero.turkopols;
					UnPaidSergeants = game.myhero.sergeants;
					UnPaidKnights = game.myhero.knights;
					/*------------------------------------------*/
					var gold_was_purse = game.myhero.gold;
					if (game.myhero.gold >= game.hrTrkplsUpkp(UnPaidTurkopols)) {
						paidTurkopols = UnPaidTurkopols;
						UnPaidTurkopols = 0;
						game.myhero.gold -= game.hrTrkplsUpkp(paidTurkopols);
					} else {
						while (game.myhero.gold >= game.hrTrkplsUpkp(paidTurkopols + 1)) {
							paidTurkopols += 1;
							UnPaidTurkopols -= 1;
						}
						game.myhero.gold -= game.hrTrkplsUpkp(paidTurkopols);
					}
					var purse_diff = gold_was_purse - game.myhero.gold;
					if (purse_diff !== 0) {
						console.log("we paid from hero's purse to this amount of Tukropols " + paidTurkopols + " and this amount of gold " + purse_diff);
					}
					/*------------------------------------------*/
					var gold_was_treasury = game.gold;
					if (game.gold >= game.hrTrkplsUpkp(UnPaidTurkopols)) {
						game.gold -= game.hrTrkplsUpkp(UnPaidTurkopols);
						paidTurkopols += UnPaidTurkopols;
					} else {
						while (game.gold < game.hrTrkplsUpkp(UnPaidTurkopols)) {
							UnPaidTurkopols -= 1;
						}
						game.gold -= game.hrTrkplsUpkp(UnPaidTurkopols);
						paidTurkopols += UnPaidTurkopols;
						game.myhero.turkopols = paidTurkopols;
					}
					var treasury_diff = gold_was_treasury - game.gold;
					if (treasury_diff !== 0) {
						console.log("we paid from treasury to this amount of Tukropols " + UnPaidTurkopols + " and this amount of gold " + treasury_diff);
					}
					UnPaidTurkopols = 0;

					/*------------------------------------------*/
					var gold_was_purse = game.myhero.gold;
					if (game.myhero.gold >= game.hrKnghtsUpkp(UnPaidKnights)) {
						paidKnights = UnPaidKnights;
						UnPaidKnights = 0;
						game.myhero.gold -= game.hrKnghtsUpkp(paidKnights);
					} else {
						while (game.myhero.gold >= game.hrKnghtsUpkp(paidKnights + 1)) {
							paidKnights += 1;
							UnPaidKnights -= 1;
						}
						game.myhero.gold -= game.hrKnghtsUpkp(paidKnights);
					}
					var purse_diff = gold_was_purse - game.myhero.gold;
					if (purse_diff !== 0) {
						console.log("we paid from hero's purse to this amount of Knights " + paidKnights + " and this amount of gold " + purse_diff);
					}
					/*------------------------------------------*/
					var gold_was_treasury = game.gold;
					if (game.gold >= game.hrKnghtsUpkp(UnPaidKnights)) {
						game.gold -= game.hrKnghtsUpkp(UnPaidKnights);
						paidKnights += UnPaidKnights;
					} else {
						while (game.gold < game.hrKnghtsUpkp(UnPaidKnights)) {
							UnPaidKnights -= 1;
						}
						game.gold -= game.hrKnghtsUpkp(UnPaidKnights);
						console.log('paid knights was '+paidKnights);//DEBUG
						paidKnights += UnPaidKnights;
						game.myhero.knights = paidKnights;
					}
					var treasury_diff = gold_was_treasury - game.gold;
					if (treasury_diff !== 0) {
						console.log("we paid from treasury to this amount of Knights" + UnPaidKnights + " and this amount of gold " + treasury_diff);
					}
					UnPaidKnights = 0;

					/*------------------------------------------*/
					var gold_was_purse = game.myhero.gold;
					if (game.myhero.gold >= game.hrSrgntsUpkp(UnPaidSergeants)) {
						paidSergeants = UnPaidSergeants;
						UnPaidSergeants = 0;
						game.myhero.gold -= game.hrSrgntsUpkp(paidSergeants);
					} else {
						while (game.myhero.gold >= game.hrSrgntsUpkp(paidSergeants + 1)) {
							paidSergeants += 1;
							UnPaidSergeants -= 1;
						}
						game.myhero.gold -= game.hrSrgntsUpkp(paidSergeants);
					}
					var purse_diff = gold_was_purse - game.myhero.gold;
					if (purse_diff !== 0) {
						console.log("we paid from hero's purse to this amount of Sergeants" + paidSergeants + " and this amount of gold " + purse_diff);
					}
					/*------------------------------------------*/
					flagTreasuryToNull = false;
					var gold_was_treasury = game.gold;
					if (game.gold >= game.hrSrgntsUpkp(UnPaidSergeants)) {
						game.gold -= game.hrSrgntsUpkp(UnPaidSergeants);
					} else {
						while (game.gold < game.hrSrgntsUpkp(UnPaidSergeants)) {
							if (UnPaidSergeants !== 1) {
								UnPaidSergeants -= 1;
							} else {
								flagTreasuryToNull = true;
								break;
							}
						}
						paidSergeants += UnPaidSergeants;
						if (flagTreasuryToNull === true) {
							game.gold = 0
						} else {
							game.gold -= game.hrSrgntsUpkp(UnPaidSergeants);
						}
						game.myhero.sergeants = paidSergeants;
					}
					var treasury_diff = gold_was_treasury - game.gold;
					if (treasury_diff !== 0) {
						console.log("we paid from treasury to this amount of Sergeants" + UnPaidSergeants + " and this amount of gold " + treasury_diff);
					}
					UnPaidSergeants = 0;
				} else {//from treasury only
					if (game.gold >= game.hrTrkplsUpkp(game.myhero.turkopols)) {
						game.gold -= game.hrTrkplsUpkp(game.myhero.turkopols);
					} else {
						while (game.gold < game.hrTrkplsUpkp(game.myhero.turkopols)) {
							game.myhero.turkopols -= 1;
						}
						game.gold -= game.hrTrkplsUpkp(game.myhero.turkopols);
					}
					if (game.gold >= game.hrKnghtsUpkp(game.myhero.knights)) {
						game.gold -= game.hrKnghtsUpkp(game.myhero.knights);
					} else {
						while(game.gold<game.hrKnghtsUpkp(game.myhero.knights)){
							game.myhero.knights -= 1;
						}
						game.gold -= game.hrKnghtsUpkp(game.myhero.knights);
					}
					flagTreasuryToNull = false;
					if (game.gold >= game.hrSrgntsUpkp(game.myhero.sergeants)) {
						game.gold -= game.hrSrgntsUpkp(game.myhero.sergeants);
					} else {
						while (game.gold < game.hrSrgntsUpkp(game.myhero.sergeants)) {
							if (game.myhero.sergeants !== 1) {
								game.myhero.sergeants -= 1;
							} else {
								flagTreasuryToNull = true;
								break;
							}
						}
						if (flagTreasuryToNull === true) {
							game.gold = 0
						} else {
							game.gold -= game.hrSrgntsUpkp(game.myhero.sergeants);
						}
					}
				}
			}
		},
		calculateAutocampaign : function () {
			if (game.heroExists() && game.myhero.status===1 && game.myhero.aCampaignForward===1) {
				game.myhero.aCampaignLong         += 1;
				game.myhero.aCampaignTotalLong    += 1;
				game.ac_steps                     += 1;
				if (game.ac_steps === 2) {
					if (!game.story.includes("story_two_steps")){
						game.story.push("story_two_steps");
						showModal(0, '', getAck, locObj.story2_two_steps.txt, locObj.okay.txt, '');
					}
				}
				var heroTroopsPrice = game.heroTroopsPrice();
				var rnd = Math.floor((Math.random() * 24) + 1);
				if (game.myhero.stance === 0) {//aggressive stance

					if (rnd<=12) {

						game.isAutoBattle = true;
						createBattleAccordion();

						while (game.isAutoBattle) {
							game.calcAttackPhase("AutoCampaign");
						}

					}
					if (rnd>12 && rnd<25) {
						postJournalLog(localeStrings[175]);
					}
				}
				if (game.myhero.stance === 1) {//cautious stance

					if (rnd>1 && rnd<=12) {

						game.isAutoBattle = true;
						createBattleAccordion();

						while (game.isAutoBattle) {
							game.calcAttackPhase("AutoCampaign");
						}

					}
					if (rnd>12 && rnd<25) {
						postJournalLog(localeStrings[175]);
					}
				}
				game.heroLvlUp("AutoCampaign");
			}
			if (game.heroExists() && game.myhero.status===1 && game.myhero.aCampaignBackward===1) {
				console.log("%c CHECK IF IS DEFEATED: ", "bakcground: #31b5e7; color: #fff");
				if (game.myhero.aCampaignLong-1>0){
					game.myhero.aCampaignLong     -= 1;
					if (game.isDefeated) {
						postJournalLog(locObj.advmapHeroLose.txt);
						game.isDefeated = false;
						return
					}
					game.myhero.aCampaignTotalLong+= 1;
					postJournalLog(localeStrings[175]);
				} else {
					document.getElementById("btnAutocampaign").disabled = false;
					game.myhero.aCampaignLong      = 0;
					game.myhero.aCampaignTotalLong = 0;
					game.myhero.status             = 0;
					game.myhero.aCampaignForward   = 0;
					game.myhero.aCampaignBackward  = 0;
					postEventLog(localeStrings[176]+game.myhero.gold);
					var gold_diff = game.addMoneyToTreasury(game.myhero.gold);
					if (gold_diff!==game.myhero.gold){
						postEventLog(localeStrings[89].replace("%arg1", gold_diff));
					}
					game.myhero.gold               = 0;
				}
				game.heroLvlUp("AutoCampaign");
			}
		},
		isHeroHaveTroops : function () {
			var heroTroopsFlag = false;
			if (game.heroExists() === true) {
				var heroSergeantsCount = game.myhero.sergeants;
				var heroTurkopolsCount = game.myhero.turkopols;
				var heroKnightsCount   = game.myhero.knights;
				var totalCount = game.myhero.sergeants+game.myhero.turkopols+game.myhero.knights;
				if (game.myheroArmy.units == null) {
					game.myheroArmy = {armyID: 1, units: {}};
				}
				if (game.myhero.sergeants > 0) {
					game.genUnitStack(sergeantsData, heroSergeantsCount, game.myheroArmy.units);
				}
				if (game.myhero.turkopols > 0) {
					game.genUnitStack(turkopolsData, heroTurkopolsCount, game.myheroArmy.units);
				}
				if (game.myhero.knights > 0) {
					game.genUnitStack(knightsData, heroKnightsCount, game.myheroArmy.units);
				}
				if (totalCount>0) {
					heroTroopsFlag = true;
				}
			}
			return heroTroopsFlag;
		},
		heroTroopsPrice : function () {
			var price = 0;
			price    += game.myhero.sergeants*20;
			price    += game.myhero.turkopols*20;
			price    += game.myhero.knights*40;
			return price;
		},
		autocampaign : function () {
			if (game.heroExists()===true){
				if (game.myhero.status===0) {
					if (game.isHeroHaveTroops()) {
						var question      = localeStrings[225];
						showModal(1, '', game.autocampaignLaunchCallback, question, localeStrings[226], localeStrings[227]);
					} else {
						alertMsg = localeStrings[228];
						showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
					}
				} else {
					if (game.myhero.status===1) {
						var question      = localeStrings[171];
						showModal(1, '', game.autocampaignWithdrawCallback, question, localeStrings[32],  localeStrings[33]);
					} else {
						alertMsg = localeStrings[170];
						showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
					}
				}
			} else {
				alertMsg = localeStrings[229];
				showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
			}
		},
		autocampaignLaunchCallback : function () {
			if (answer === 2) {
				game.myhero.stance = 0;
				game.generateEnemyUnitsForBattle();
			}
			if (answer === 3) {
				game.myhero.stance = 1;
				game.generateEnemyUnitsForBattle();
			}
			game.myhero.status = 1;
			game.myhero.aCampaignForward   = 1;
			game.myhero.aCampaignBackward  = 0;

			console.log(game.myheroArmy);
			console.log(game.enemyHeroArmy);

			createJournalAccordion();
			postJournalLog("------------------------");
			updateUI();
		},
		autocampaignWithdrawCallback : function () {
			if (answer === 2) {
				if (game.myhero.aCampaignLong === 0) {
					game.myhero.status = 0;
					updateUI();
				} else {
					game.myhero.aCampaignForward   = 0;
					game.myhero.aCampaignBackward  = 1;
					document.getElementById("btnAutocampaign").disabled = true;
					updateUI();
				}
			}
		},
		help(myobject) {
			if (myobject.id==="defences_img") {
				nextDefPrice = 0;
				blMaxLvlDef = 0;
				if (game.buildLevelD === 0) {
					nextDefPrice = config.costWall;
				}
				if (game.buildLevelD === 1) {
					nextDefPrice = config.costTower;
				}
				if (game.buildLevelD === 2) {
					nextDefPrice = config.costCastle;
				}
				if (game.buildLevelD === 3) {
					blMaxLvlDef = 1;
				}
				if (blMaxLvlDef === 0){
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[232]+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",nextDefPrice);
				} else {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[232];
				}
			}
			if (myobject.id==="home_img") {
				nextLvlHome           = game.buildLevelH*1+1;
				nextLvlPriceHome      = Math.pow(config.costHome,(game.buildLevelH*1+1));
				if (nextLvlHome===1) {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[233]+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",nextLvlPriceHome);
				} else {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[233]+"<br>"+locObj.upgCostSidebar.txt.replace("%arg1",nextLvlHome).replace("%arg2",nextLvlPriceHome);
				}
			}
			if (myobject.id==="treasury_img") {
				nextLvlTreasury       = game.buildLevelTreasury*1+1;
				nextLvlPriceTreasury  = Math.pow(config.costTreasury,(game.buildLevelTreasury*1+1));
				if (nextLvlTreasury===1) {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[234]+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",nextLvlPriceTreasury);
				} else {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[234]+"<br>"+locObj.upgCostSidebar.txt.replace("%arg1",nextLvlTreasury).replace("%arg2",nextLvlPriceTreasury);
				}
			}
			if (myobject.id==="gallows_img") {
				nextLvlGallows        = game.buildLevelGallows*1+1;
				nextLvlPriceGallows   = Math.pow(config.costGallows,(game.buildLevelGallows*1+1));
				if (nextLvlGallows===1) {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[235]+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",nextLvlPriceGallows);
				} else {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[235]+"<br>"+locObj.upgCostSidebar.txt.replace("%arg1",nextLvlGallows).replace("%arg2",nextLvlPriceGallows);
				}
			}
			if (myobject.id==="university_img") {
				document.getElementById("lblBuildHelp").innerHTML=locObj.bldUniversityHelp.txt+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",config.bldUniversityCost);
			}
			if (myobject.id==="fountain_img") {
				nextLvlFountain       = game.buildLevelFountain*1+1;
				nextLvlPriceFountain  = Math.pow(config.costFountain,(game.buildLevelFountain*1+1));
				if (nextLvlFountain===1) {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[236]+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",nextLvlPriceFountain);
				} else {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[236]+"<br>"+locObj.upgCostSidebar.txt.replace("%arg1",nextLvlFountain).replace("%arg2",nextLvlPriceFountain);
				}
			}
			if (myobject.id==="moneystash_img") {
				nextLvlStash          = game.buildLevelStash*1+1;
				nextLvlPriceStash     = Math.pow(config.costStash,(game.buildLevelStash*1+1));
				if (nextLvlStash===1) {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[237]+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",nextLvlPriceStash);
				} else {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[237]+"<br>"+locObj.upgCostSidebar.txt.replace("%arg1",nextLvlStash).replace("%arg2",nextLvlPriceStash);
				}
			}
			if (myobject.id==="inn_img") {
				nextLvlInn            = game.buildLevelInn*1+1;
				nextLvlPriceInn       = Math.pow(config.costInn,(game.buildLevelInn*1+1));
				if (nextLvlInn===1) {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[238]+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",nextLvlPriceInn);
				} else {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[238]+"<br>"+locObj.upgCostSidebar.txt.replace("%arg1",nextLvlInn).replace("%arg2",nextLvlPriceInn);
				}
			}
			if (myobject.id==="stable_img") {
				nextLvlStable         = game.buildLevelStable*1+1;
				nextLvlPriceStable    = Math.pow(config.costStable,(game.buildLevelStable*1+1));
				if (nextLvlStable===1) {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[239]+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",nextLvlPriceStable);
				} else {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[239]+"<br>"+locObj.upgCostSidebar.txt.replace("%arg1",nextLvlStable).replace("%arg2",nextLvlPriceStable);
				}
			}
			if (myobject.id==="archery_img") {
				nextLvlArchery         = game.buildLevelArchery*1+1;
				nextLvlPriceArchery    = Math.pow(config.costArchery,(game.buildLevelArchery*1+1));
				if (nextLvlArchery===1) {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[240]+"<br>"+locObj.bldCostSidebar.txt.replace("%arg2",nextLvlPriceArchery);
				} else {
					document.getElementById("lblBuildHelp").innerHTML=localeStrings[240]+"<br>"+locObj.upgCostSidebar.txt.replace("%arg1",nextLvlArchery).replace("%arg2",nextLvlPriceArchery);
				}
			}
			if (myobject.id==="imgHiringScreenSergeantToHire") {
				document.getElementById("grid-info").innerHTML=localeStrings[308].replace("%arg1", config.sergeantHiring).replace("%arg2", config.sergeantUpkeep);
			}
			if (myobject.id==="imgHiringScreenTurkopolToHire") {
				document.getElementById("grid-info").innerHTML=localeStrings[309].replace("%arg1", config.turkopolHiring).replace("%arg2", config.turkopolUpkeep);
			}
			if (myobject.id==="imgHiringScreenKnightToHire") {
				document.getElementById("grid-info").innerHTML=localeStrings[310].replace("%arg1", config.knightHiring).replace("%arg2", config.knightUpkeep);
			}
			if (myobject.id==="btnHireSergeant") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[308].replace("%arg1", config.sergeantHiring).replace("%arg2", config.sergeantUpkeep);
			}
			if (myobject.id==="btnHireTurkopol") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[309].replace("%arg1", config.turkopolHiring).replace("%arg2", config.turkopolUpkeep);
			}
			if (myobject.id==="btnHireKnight") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[310].replace("%arg1", config.knightHiring).replace("%arg2", config.knightUpkeep);
			}
			if (myobject.id==="imgCastellanInHiringScreen") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[311];
			}
			if (myobject.id==="imgHeroInHiringScreenKnight") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[312];
			}
			if (myobject.id==="imgHeroInHiringScreenMonk") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[312];
			}
			if (myobject.id==="imgHeroInHiringScreenMonk") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[312];
			}
			if (myobject.id==="btnMoveSergeantToHero") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[313];
			}
			if (myobject.id==="btnMoveTurkopolToHero") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[313];
			}
			if (myobject.id==="btnMoveKnightToHero") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[313];
			}
			if (myobject.id==="btnMoveSergeantToGarrison") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[314];
			}
			if (myobject.id==="btnMoveTurkopolToGarrison") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[314];
			}
			if (myobject.id==="btnMoveKnightToGarrison") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[314];
			}
			if (myobject.id==="btnMoveAllSergeantsToHero") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[331];
			}
			if (myobject.id==="btnMoveAllTurkopolsToHero") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[331];
			}
			if (myobject.id==="btnMoveAllKnightsToHero") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[331];
			}
			if (myobject.id==="btnMoveAllTroopsToHero") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[332];
			}
			if (myobject.id==="btnMoveAllSergeantsToGarrison") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[333];
			}
			if (myobject.id==="btnMoveAllTurkopolsToGarrison") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[333];
			}
			if (myobject.id==="btnMoveAllKnightsToGarrison") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[333];
			}
			if (myobject.id==="btnMoveAllTroopsToGarrison") {
				document.getElementById("lblTroopsHelp").innerHTML=localeStrings[334];
			}

			if (myobject.id === "btnDismissGarrisonSergeant") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[339];
			}

			if (myobject.id === "btnDismissAllGarrisonSergeants") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[340];
			}

			if (myobject.id === "btnDismissGarrisonTurkopol") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[341];
			}

			if (myobject.id === "btnDismissAllGarrisonTurkopols") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[342];
			}

			if (myobject.id === "btnDismissGarrisonKnight") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[343];
			}

			if (myobject.id === "btnDismissAllGarrisonKnights") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[344];
			}

			if (myobject.id === "btnDismissAllGarrisonForces") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[345];
			}

			if (myobject.id === "btnDismissHeroSergeant") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[346];
			}

			if (myobject.id === "btnDismissAllHeroSergeants") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[347];
			}

			if (myobject.id === "btnDismissHeroTurkopol") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[348];
			}

			if (myobject.id === "btnDismissAllHeroTurkopols") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[349];
			}

			if (myobject.id === "btnDismissHeroKnight") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[350];
			}

			if (myobject.id === "btnDismissAllHeroKnights") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[351];
			}

			if (myobject.id === "btnDismissAllHeroForces") {
				document.getElementById("lblTroopsHelp").innerHTML = localeStrings[352];
			}

		},
		heroExists: function () {
			return (Object.keys(game.myhero).length === 0 && game.myhero.constructor === Object) ? false : true;
		},
		heroAlignment(returnFormat) {
			if (returnFormat==="text") {
				var heroAlignment = "";
				if (game.myhero.lawful < 40) {
					heroAlignment += localeStrings[200];
				}
				if (game.myhero.lawful >= 40 && game.myhero.lawful <60) {
					heroAlignment += localeStrings[199];
				}
				if (game.myhero.lawful >= 60) {
					heroAlignment += localeStrings[198];
				}
				if (game.myhero.kindness < 40) {
					heroAlignment += " "+localeStrings[203];
				}
				if (game.myhero.kindness >= 40 && game.myhero.kindness <60) {
					heroAlignment += " "+localeStrings[202];
				}
				if (game.myhero.kindness >= 60) {
					heroAlignment += " "+localeStrings[201];
				}
				heroAlignment += " ("+game.myhero.lawful+"; "+game.myhero.kindness+")";
			}
			return heroAlignment;
		},
		heroNextLvlExpLimit () {
			return Math.pow((game.myhero.level+1) * config.heroExpK,2);
		},
		heroHire : function (silent) {
			if (game.heroExists() === false) {
				if (game.gold > config.costHero || silent===true) {
					if (silent === false) {
						game.gold                 = game.gold - config.costHero;
					}
					clearJournalLog();
					game.myhero.level     = heroesForHire[curHeroForHire].level;
					game.myhero.exp       = Math.pow(game.myhero.level * config.heroExpK,2);
					game.myhero.class     = curHeroForHire;
					game.myhero.atk       = heroesForHire[curHeroForHire].atk;
					game.myhero.def       = heroesForHire[curHeroForHire].def;
					game.myhero.mpow      = heroesForHire[curHeroForHire].mpow;
					game.myhero.int       = heroesForHire[curHeroForHire].int;
					game.myhero.mana      = heroesForHire[curHeroForHire].int*10;
					game.myhero.cmana     = heroesForHire[curHeroForHire].int*10;

					if (game.myhero.class===0){
						game.myhero.lawful    = 80;
						game.myhero.kindness  = 50;
						var heroAttributesRandomizer = new WeightedRandom();
						heroAttributesRandomizer.addEntry('atk', 60.0);
						heroAttributesRandomizer.addEntry('def', 40.0);
						heroAttributesRandomizer.addEntry('int', 0.0); // Temp logic for knight, until there is no magic mechanics at autocampaign
						heroAttributesRandomizer.addEntry('mpow', 0.0); // Temp logic for knight, until there is no magic mechanics at autocampaign
					}
					if (game.myhero.class===1){
						game.myhero.lawful    = 80;
						game.myhero.kindness  = 70;
						var heroAttributesRandomizer = new WeightedRandom();
						heroAttributesRandomizer.addEntry('atk', 45.0);  //Temp logic for monk, until there is no magic mechanics in autocampaign
						heroAttributesRandomizer.addEntry('def', 55.0); //Temp logic for monk, until there is no magic mechanics in autocampaign
						heroAttributesRandomizer.addEntry('int', 0.0);
						heroAttributesRandomizer.addEntry('mpow', 0.0);
					}
					game.myhero.sergeants  = 0;
					game.myhero.turkopols  = 0;
					game.myhero.knights    = 0;
					game.myhero.inventory    = [];//should the list contain objects?
					game.myhero.inventoryWorn= [];//should the list contain objects?
					game.myhero.status     = 0;
					game.myhero.gold       = 0;
					game.myhero.upkeepsrc  = 0;//0 from the hero's purse, 1 from the treasury
					game.myhero.statLuck           = 0;
					game.myhero.statSuperstition   = 0;
					game.myhero.statMorale         = 0;
					game.myhero.pskillCharisma     = 0;
					game.myhero.pskillLeadership   = 0;
					game.myhero.eqRigtharm         = 0;
					game.myhero.eqLeftarm          = 0;
					game.myhero.eqHelmet           = 0;
					game.myhero.eqBoots            = 0;
					game.myhero.eqCloak            = 0;
					game.myhero.eqRightring        = 0;
					game.myhero.eqLeftring         = 0;
					game.myhero.eqNecklace         = 0;
					game.myhero.eqBody             = 0;
					game.myhero.eqRange            = 0;
					game.myhero.artefactsWorn      = 0;//5
					game.myhero.aCampaign          = 0;
					game.myhero.aCampaignLong      = 0;
					game.myhero.aCampaignTotalLong = 0;
					game.myhero.aCampaignForward   = 0;
					game.myhero.aCampaignBackward  = 0;
					game.myhero.portrait_id        = heroesForHire[curHeroForHire].portrait_id;
					updateHeroStatus();
					game.gold -= config.costHero;
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			} else {
				disabledElements.push("btnHireHero");
				disabledElements.push("selectHeroClass");
				document.getElementById("btnHireHero").disabled = true;
				document.getElementById("selectHeroClass").disabled = true;
				alertMsg = localeStrings[61];
				showModal(0, '', getAck, alertMsg, localeStrings[60], '');
			}
		},
		heroLvlUp : function (campaignType) {
			if (game.myhero.exp > game.heroNextLvlExpLimit()){
				game.myhero.level +=1;
				var heroAttributesRandomizer = new WeightedRandom();
				if (game.myhero.class === 0) {
					heroAttributesRandomizer.addEntry('atk', 60.0);
					heroAttributesRandomizer.addEntry('def', 40.0);
					heroAttributesRandomizer.addEntry('int', 0.0); // Temp logic for knight, until there is no magic mechanics at autocampaign
					heroAttributesRandomizer.addEntry('mpow', 0.0);
				}

				if (game.myhero.class === 1) {
					heroAttributesRandomizer.addEntry('atk', 45.0);  //Temp logic for monk, until there is no magic mechanics in autocampaign
					heroAttributesRandomizer.addEntry('def', 55.0); //Temp logic for monk, until there is no magic mechanics in autocampaign
					heroAttributesRandomizer.addEntry('int', 0.0);
					heroAttributesRandomizer.addEntry('mpow', 0.0);
				}

				var rndAttrName = heroAttributesRandomizer.getRandom();
				game.myhero[rndAttrName]++;
				console.log(rndAttrName);
				if (rndAttrName === "int") {
					game.recalcManaPoints();
				}

				if (campaignType === "AutoCampaign") {
					postJournalLog(localeStrings[224]);
				}
			}
		},

		recalcManaPoints: function() {
			game.myhero.mana = game.myhero.cmana = game.myhero.int * 10;
		},

		heroDie : function () {
			game.myhero = {};
			//heroAttributesRandomizer.clearEntriesList();
			updateHeroStatus();
			writeSave();
		},
		hireSergeants : function () {
			if (game.buildLevelStable>=1) {
				if (game.gold >= numberToHire*config.sergeantHiring) {
					game.sergeants += parseInt(numberToHire);
					game.gold      -= numberToHire*config.sergeantHiring;
					updateTroopsNumbers();
					updateResources();
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1",localeStrings[316]);
				postEventLog(msg);
			}
		},
		hireTurkopols : function () {
			if (game.buildLevelStable>=1) {
				if (game.buildLevelArchery >= 1) {
					if (game.gold >= numberToHire*config.turkopolHiring) {
						game.turkopols += parseInt(numberToHire);
						game.gold      -= numberToHire*config.turkopolHiring;
						updateTroopsNumbers();
						updateResources();
					} else {
						postEventLog(locObj.notEnoughGold.txt, "bold");
					}
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[317]);
					postEventLog(msg);
				}
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1",localeStrings[316]);
				postEventLog(msg);
			}
		},
		hireKnights : function () {
			if (game.buildLevelStable>=2) {
				if (game.gold >= numberToHire*config.knightHiring) {
					game.knights   += parseInt(numberToHire);
					game.gold      -= numberToHire*config.knightHiring;
					updateTroopsNumbers();
					updateResources();
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1",localeStrings[318]);
				postEventLog(msg);
			}
		},
		hireUnits : function () {
			if (selectedUnitToHire==="sergeant"){
				game.hireSergeants();
			}
			if (selectedUnitToHire==="turkopol"){
				game.hireTurkopols();
			}
			if (selectedUnitToHire==="knight"){
				game.hireKnights();
			}
		},
		moveSergeants() {
			if (moveFromGarrison===true) {
				if (game.sergeants >= numberToMove) {
					game.sergeants -= numberToMove;
					game.myhero.sergeants += numberToMove;
					updateHeroStatus();
					updateTroopsNumbers();
					updateResources();
				}
			} else {

			}
		},
		moveTurkopols() {
			if (moveFromGarrison===true) {
				if (game.turkopols >= numberToMove) {
					game.turkopols -= numberToMove;
					game.myhero.turkopols += numberToMove;
					updateHeroStatus();
					updateTroopsNumbers();
					updateResources();
				}
			} else {

			}
		},
		moveKnights() {
			if (moveFromGarrison===true) {
				if (game.knights >= numberToMove) {
					game.knights -= numberToMove;
					game.myhero.knights += numberToMove;
					updateHeroStatus();
					updateTroopsNumbers();
					updateResources();
				}
			} else {

			}
		},
		moveUnits : function () {
			if (selectedUnitToMove==="sergeant"){
				game.moveSergeants();
			}
			if (selectedUnitToMove==="turkopol"){
				game.moveTurkopols();
			}
			if (selectedUnitToMove==="knight"){
				game.moveKnights();
			}
		},
		moveSergeantsToGarnison : function () {
			if (game.myhero.status===0){
				if (game.myhero.sergeants>0) {
					game.sergeants += 1;
					game.myhero.sergeants -= 1;
					updateTroopsNumbers();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[315]);
					postEventLog(msg);
				}
			}
			console.group("%c Garrison sergeants", "background-color: #090; color: #fff; padding: 0 10px;");
			console.log("%c Sergeants: ", "color: #090;", game.sergeants);
			console.groupEnd();

			console.group("%c Hero sergeants", "background-color: blue; color: #fff; padding: 0 10px;");
			console.log("%c Sergeants: ", "color: blue;", game.myhero.sergeants);
			console.groupEnd();
		},
		moveTurkopolsToGarnison : function () {
			if (game.myhero.status===0){
				if (game.myhero.turkopols>0) {
					game.turkopols += 1;
					game.myhero.turkopols -= 1;
					updateTroopsNumbers();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[315]);
					postEventLog(msg);
				}
			}
			console.group("%c Garrison turkopols", "background-color: #090; color: #fff; padding: 0 10px;");
			console.log("%c Turkopols: ", "color: #090;", game.turkopols);
			console.groupEnd();

			console.group("%c Hero turkopols", "background-color: blue; color: #fff; padding: 0 10px;");
			console.log("%c Turkopols: ", "color: blue;", game.myhero.turkopols);
			console.groupEnd();
		},
		moveKnightsToGarnison : function () {
			if (game.myhero.status===0){
				if (game.myhero.knights>0) {
					game.knights += 1;
					game.myhero.knights -= 1;
					updateTroopsNumbers();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[315]);
					postEventLog(msg);
				}
			}

			console.group("%c Garrison knights", "background-color: #090; color: #fff; padding: 0 10px;");
			console.log("%c Knights: ", "color: #090;", game.knights);
			console.groupEnd();

			console.group("%c Hero knights", "background-color: blue; color: #fff; padding: 0 10px;");
			console.log("%c Knights: ", "color: blue;", game.myhero.knights);
			console.groupEnd();
		},

		//--- Move troops by type to garrison: Start ---//
		moveAllSergeantsToGarrison : function () {
			if (game.myhero.status===0){
				if (game.myhero.sergeants>0) {
					var heroSergeantsCount = game.myhero.sergeants;
					game.sergeants += heroSergeantsCount;
					game.myhero.sergeants -= heroSergeantsCount;
					updateTroopsNumbers();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[315]);
					postEventLog(msg);
				}
			}

			console.group("%c Garrison sergeants", "background-color: #090; color: #fff; padding: 0 10px;");
			console.log("%c Sergeants: ", "color: #090;", game.sergeants);
			console.groupEnd();

			console.group("%c Hero sergeants", "background-color: blue; color: #fff; padding: 0 10px;");
			console.log("%c Sergeants: ", "color: blue;", game.myhero.sergeants);
			console.groupEnd();

		},
		moveAllTurkopolsToGarrison: function () {
			if (game.myhero.status===0){
				if (game.myhero.turkopols>0) {
					var heroTurkopolsCount = game.myhero.turkopols;
					game.turkopols += heroTurkopolsCount;
					game.myhero.turkopols -= heroTurkopolsCount;
					updateTroopsNumbers();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[315]);
					postEventLog(msg);
				}
			}

			console.group("%c Garrison turkopols", "background-color: #090; color: #fff; padding: 0 10px;");
			console.log("%c Turkopols: ", "color: #090;", game.turkopols);
			console.groupEnd();

			console.group("%c Hero turkopols", "background-color: blue; color: #fff; padding: 0 10px;");
			console.log("%c Turkopols: ", "color: blue;", game.myhero.turkopols);
			console.groupEnd();

		},
		moveAllKnightsToGarrison: function () {
			if (game.myhero.status===0){
				if (game.myhero.knights>0) {
					var heroKnightsCount = game.myhero.knights;
					game.knights += heroKnightsCount;
					game.myhero.knights -= heroKnightsCount;
					updateTroopsNumbers();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[315]);
					postEventLog(msg);
				}
			}

			console.group("%c Garrison knights", "background-color: #090; color: #fff; padding: 0 10px;");
			console.log("%c Knights: ", "color: #090;", game.knights);
			console.groupEnd();

			console.group("%c Hero knights", "background-color: blue; color: #fff; padding: 0 10px;");
			console.log("%c Knights: ", "color: blue;", game.myhero.knights);
			console.groupEnd();

		},
		//--- Move troops by type to garrison: End ---//


		// Functions for moving all troops between garrison and hero's squad. Just incase.

		moveAllTroopsToHero: function () {
			if (game.myhero.status===0) {
				if (game.sergeants > 0 || game.turkopols > 0 || game.knights > 0) {
					var sergeantsCount = game.sergeants,
						turkopolsCount = game.turkopols,
						knightsCount = game.knights;

					game.myhero.sergeants += sergeantsCount
					game.myhero.turkopols += turkopolsCount;
					game.myhero.knights	+= knightsCount;

					game.sergeants -= sergeantsCount;
					game.turkopols -= turkopolsCount;
					game.knights -= knightsCount;
					updateTroopsNumbers();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[315]);
					postEventLog(msg);
				}
			}

			console.group("%c Garrison troops", "background-color: #090; color: #fff; padding: 0 10px;");
			console.log("%c Sergeants: ", "color: #090;", game.sergeants);
			console.log("%c Turkopols: ", "color: #090;", game.turkopols);
			console.log("%c Knights: ", "color: #090;", game.knights);
			console.groupEnd();

			console.group("%c Hero troops", "background-color: blue; color: #fff; padding: 0 10px;");
			console.log("%c Sergeants: ", "color: blue;", game.myhero.sergeants);
			console.log("%c Turkopols: ", "color: blue;", game.myhero.turkopols);
			console.log("%c Knights: ", "color: blue;", game.myhero.knights);
			console.groupEnd();



		},

		moveAllTroopsToGarrison: function () {
			if (game.myhero.status===0) {
				if (game.myhero.sergeants > 0 || game.myhero.turkopols > 0 || game.myhero.knights > 0) {
					var sergeantsCount = game.myhero.sergeants,
						turkopolsCount = game.myhero.turkopols,
						knightsCount = game.myhero.knights;

					game.sergeants += sergeantsCount
					game.turkopols += turkopolsCount;
					game.knights	+= knightsCount;

					game.myhero.sergeants -= sergeantsCount;
					game.myhero.turkopols -= turkopolsCount;
					game.myhero.knights -= knightsCount;
					updateTroopsNumbers();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[315]);
					postEventLog(msg);
				}
			}

			console.group("%c Garrison troops", "background-color: #090; color: #fff; padding: 0 10px;");
			console.log("%c Sergeants: ", "color: #090;", game.sergeants);
			console.log("%c Turkopols: ", "color: #090;", game.turkopols);
			console.log("%c Knights: ", "color: #090;", game.knights);
			console.groupEnd();

			console.group("%c Hero troops", "background-color: blue; color: #fff; padding: 0 10px;");
			console.log("%c Sergeants: ", "color: blue;", game.myhero.sergeants);
			console.log("%c Turkopols: ", "color: blue;", game.myhero.turkopols);
			console.log("%c Knights: ", "color: blue;", game.myhero.knights);
			console.groupEnd();

		},



		//-- Dismiss garrison troops by one  --//
		dismissGarrisonSergeant: function() {
			if (game.sergeants > 0) {
				question = localeStrings[353];
				showModal(1, '', game.dismissGarrisonSergeantCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[367]);
				postEventLog(msg);
			}
		},

		dismissGarrisonSergeantCallback: function () {
			if (answer == 2) {
				game.sergeants--;
				updateTroopsNumbers();
			}
		},

		dismissGarrisonTurkopol: function() {
			if (game.turkopols > 0) {
				question = localeStrings[354];
				showModal(1, '', game.dismissGarrisonTurkopolCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[368]);
				postEventLog(msg);
			}
		},

		dismissGarrisonTurkopolCallback: function () {
			if (answer == 2) {
				game.turkopols--;
				updateTroopsNumbers();
			}
		},

		dismissGarrisonKnight: function() {
			if (game.knights > 0) {
				question = localeStrings[355];
				showModal(1, '', game.dismissGarrisonKnightCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[369]);
				postEventLog(msg);
			}
		},

		dismissGarrisonKnightCallback: function () {
			if (answer == 2) {
				game.knights--;
				updateTroopsNumbers();
			}
		},
		//-- /Dismiss garrison troops by one  --//


		//-- Dismiss all garrison troops by type --//
		dismissAllGarrisonSergenats: function() {
			if (game.sergeants > 0) {
				question = localeStrings[356];
				showModal(1, '', game.dismissAllGarrisonSergenatsCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[367]);
				postEventLog(msg);
			}
		},

		dismissAllGarrisonSergenatsCallback: function () {
			if (answer == 2) {
				game.sergeants = 0;
				updateTroopsNumbers();
			}
		},

		dismissAllGarrisonTurkopols: function () {
			if (game.turkopols > 0) {
				question = localeStrings[357];
				showModal(1, '', game.dismissAllGarrisonTurkopolsCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[368]);
				postEventLog(msg);
			}
		},

		dismissAllGarrisonTurkopolsCallback: function () {
			if (answer == 2) {
				game.turkopols = 0;
				updateTroopsNumbers();
			}
		},

		dismissAllGarrisonKnights: function () {
			if (game.knights > 0) {
				question = localeStrings[358];
				showModal(1, '', game.dismissAllGarrisonKnightsCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[369]);
				postEventLog(msg);
			}
		},

		dismissAllGarrisonKnightsCallback: function () {
			if (answer == 2) {
				game.knights = 0;
				updateTroopsNumbers()
			}
		},
		//-- /Dismiss all garrison troops by type --//


		//-- Dismiss heroe's troops by one --//
		dismissHeroSergeant: function() {
			console.log(game.hero);
			if (game.myhero.sergeants > 0) {
				question = localeStrings[359];
				showModal(1, '', game.dismissHeroSergeantCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[370]);
				postEventLog(msg);
			}
		},

		dismissHeroSergeantCallback: function () {
			if (answer == 2) {
				console.log('Hero sergeants: ', game.myhero);
				game.myhero.sergeants--;
				updateTroopsNumbers();
			}
		},

		dismissHeroTurkopol: function () {
			if (game.myhero.turkopols > 0) {
				question = localeStrings[360];
				showModal(1, '', game.dismissHeroTurkopolCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[371]);
				postEventLog(msg);
			}
		},

		dismissHeroTurkopolCallback: function () {
			if (answer == 2) {
				game.myhero.turkopols--;
				updateTroopsNumbers();
			}
		},

		dismissHeroKnight: function () {
			if (game.myhero.knights > 0) {
				question = localeStrings[361];
				showModal(1, '', game.dismissHeroKnightCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[372]);
				postEventLog(msg);
			}
		},

		dismissHeroKnightCallback: function () {
			if (answer == 2) {
				game.myhero.knights--;
				updateTroopsNumbers();
			}
		},
		//-- /Dismiss heroe's troops by one --//


		//-- Dismiss heroe's troops by type --//
		dismissAllHeroSergeants: function () {
			if (game.myhero.sergeants > 0) {
				question = localeStrings[362];
				showModal(1, '', game.dismissAllHeroSergeantsCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[370]);
				postEventLog(msg);
			}
		},

		dismissAllHeroSergeantsCallback: function () {
			if (answer == 2) {
				game.myhero.sergeants = 0;
				updateTroopsNumbers();
			}
		},

		dismissAllHeroTurkopols: function () {
			if (game.myhero.turkopols > 0) {
				question = localeStrings[363];
				showModal(1, '', game.dismissAllHeroTurkopolsCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[371]);
				postEventLog(msg);
			}
		},

		dismissAllHeroTurkopolsCallback: function () {
			if (answer == 2) {
				game.myhero.turkopols = 0;
				updateTroopsNumbers();
			}
		},

		dismissAllHeroKnights: function () {
			if (game.myhero.knights > 0) {
				question = localeStrings[364];
				showModal(1, '', game.dismissAllHeroKnightsCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[372]);
				postEventLog(msg);
			}
		},

		dismissAllHeroKnightsCallback: function () {
			if (answer == 2) {
				game.myhero.knights = 0;
				updateTroopsNumbers();
			}
		},

		//-- /Dismiss heroe's troops by type --//


		//-- Dismiss all forces --//
		dismissAllGarrisonForces: function () {
			if (game.sergeants > 0 || game.turkopols > 0 || game.knights > 0) {
				var garrisonSergeantsStr = '', garrisonTurkopolsStr = '', garrisonKnightsStr = '';
				if (game.sergeants > 0) {
					garrisonSergeantsStr = localeStrings[375].replace("%arg1", game.sergeants);
				}
				if (game.turkopols > 0) {
					garrisonTurkopolsStr = localeStrings[376].replace("%arg1", game.turkopols);
				}
				if (game.knights > 0) {
					garrisonKnightsStr = localeStrings[377].replace("%arg1", game.knights);
				}
				question = localeStrings[365].replace("%arg1", garrisonSergeantsStr).replace("%arg2", garrisonTurkopolsStr).replace("%arg3", garrisonKnightsStr);
				showModal(1, '', game.dismissAllGarrisonForcesCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[373]);
				postEventLog(msg);
			}
		},

		dismissAllGarrisonForcesCallback: function () {
			if (answer == 2) {
				game.sergeants = 0;
				game.turkopols = 0;
				game.knights = 0;
				updateTroopsNumbers();
			}
		},

		dismissAllHeroForces: function () {
			if (game.myhero.sergeants > 0 || game.myhero.turkopols > 0 || game.myhero.knights > 0) {
				var heroSergeantsStr = '', heroTurkopolsStr = '', heroKnightsStr = '';
				if (game.myhero.sergeants > 0) {
					heroSergeantsStr = localeStrings[375].replace("%arg1", game.myhero.sergeants);
				}
				if (game.myhero.turkopols > 0) {
					heroTurkopolsStr = localeStrings[376].replace("%arg1", game.myhero.turkopols);
				}
				if (game.myhero.knights > 0) {
					heroKnightsStr = localeStrings[377].replace("%arg1", game.myhero.knights);
				}
				question = localeStrings[366].replace("%arg1", heroSergeantsStr).replace("%arg2", heroTurkopolsStr).replace("%arg3", heroKnightsStr);
				showModal(1, '', game.dismissAllHeroForcesCallback, question, localeStrings[32], localeStrings[33]);
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1", localeStrings[374]);
				postEventLog(msg);
			}
		},

		dismissAllHeroForcesCallback: function () {
			if (answer == 2) {
				game.myhero.sergeants = 0;
				game.myhero.turkopols = 0;
				game.myhero.knights = 0;
				updateTroopsNumbers();
			}
		},
		//-- /Dismiss all forces --//


		goldLimit : function () {
			return Math.pow(config.costTreasury,(game.buildLevelTreasury*1+1))*2+500;
		},
		popLimit : function () {
			if (game.buildLevelH >= 1){
				return 2*Math.pow((game.buildLevelH*1+2),2);
			} else {
				return 6;
			}
		},
		recordStats : function() {
			game.years.push(game.year+" "+game.season);
			game.budgets.push(game.gold);
			game.pops.push(game.pop);
		},
		calculateTurn : function() {
			var gold_was = game.gold;
			//console.log("%c GOLD BEFORE UPDATE: ", "color: red", gold_was);
			game.recordStats();
			//game.getNearestEventTime();
			//game.getReward();
			pop_m         = 0;
			pop_was       = game.pop;
			game.ticks    = game.ticks + 1;
			game.season   = game.season + 1;
			if (game.season === 5) {
				game.season   = 1;
				game.year     = game.year+1;
			}
			pop_limit = game.popLimit();
			if (game.fire ===0) {
				if (game.pop < pop_limit) {
					pop_incr = Math.round((game.pop*20/1000)*(config.popIncRate+game.buildLevelFountain*1/10),0)
					if (pop_incr === 0) {
						game.pop = game.pop*1+config.popIncRate;
					} else {
						game.pop = game.pop*1+pop_incr*1;
						if (game.pop > pop_limit) {
							game.pop = pop_limit;
						}
					}
					pop_m    = 1;
					game.userPopAck = 0;
				} else {
					game.pop = pop_limit;
					if (game.userPopAck === 0) {
						postEventLog(locObj.buildUpgradeHouse.txt, "bold");
						game.userPopAck = 1;
					}
					//TUTORIALS
					if (game.isTutorialState && !game.tips.includes("tutorial1_pop0")){
						game.tips.push("tutorial1_pop0");
						showModal(0, '', getAck, locObj.tutorial1_pop0.txt, locObj.okay.txt, '')
					}
				}
			}
			game.calculateAutocampaign();
			game.heroSquadUpkeep();
			if (game.treasuryGuard > 0) {
				if (game.gold - game.treasuryGuard * config.treasuryGuardPricePayroll >= 0) {
					game.gold = game.gold - game.treasuryGuard * config.treasuryGuardPricePayroll;
				}
				else {
					//fire guards which we cannot afford
					//for now fire all guards!
					//TODO fire only those who we cannot afford
					var canUpkeep = Math.floor(game.gold/config.treasuryGuardPricePayroll);
					var dissmisedTreasuryGuard = game.treasuryGuard - canUpkeep;
					game.treasuryGuard = canUpkeep;
					game.gold -= (canUpkeep * config.treasuryGuardPricePayroll);
					console.group("%c Treausury guard: ", "background-color: cyan; color: #333");
					console.log("Treasury guard: ", game.treasuryGuard);
					console.groupEnd();

					msg = (canUpkeep > 0) ? localeStrings[335].replace("%arg1", dissmisedTreasuryGuard) : localeStrings[37];
					postEventLog(msg);
				}
			}
			if (game.sergeants > 0) {
				if (game.gold - game.sergeants * config.sergeantUpkeep >= 0) {
					game.gold = game.gold - game.sergeants * 5;
				}
				else {
					//fire guards which we cannot afford
					//for now fire all guards!
					//TODO fire only those who we cannot afford

					var canUpkeep = Math.floor(game.gold/config.sergeantUpkeep);
					var dismissedSergeants = game.sergeants - canUpkeep;
					game.sergeants = canUpkeep;
					game.gold -= (canUpkeep * config.sergeantUpkeep);

					console.group("%c Sergeants: ", "background-color: cyan; color: #333");
					console.log("Sergeants: ", game.sergeants);
					console.groupEnd();

					msg = (canUpkeep > 0) ? localeStrings[336].replace("%arg1", dismissedSergeants) : localeStrings[280];
					postEventLog(msg);
				}
			}
			if (game.turkopols > 0) {
				if (game.gold - game.turkopols * config.turkopolUpkeep >= 0) {
					game.gold = game.gold - game.turkopols * 5;
				}
				else {
					//fire guards which we cannot afford
					//for now fire all guards!
					//TODO fire only those who we cannot afford

					var canUpkeep = Math.floor(game.gold/config.turkopolUpkeep);
					var dismissedTurkopols = game.turkopols - canUpkeep;
					game.turkopols = canUpkeep;
					game.gold -= (canUpkeep * config.turkopolUpkeep);

					console.group("%c Turkopols: ", "background-color: cyan; color: #333");
					console.log("Turkopols: ", game.turkopols);
					console.groupEnd();

					msg = (canUpkeep > 0) ? localeStrings[337].replace("%arg1", dismissedTurkopols) : localeStrings[281];
					postEventLog(msg);
				}
			}
			if (game.knights > 0) {
				if (game.gold - game.knights * config.knightUpkeep >= 0) {
					game.gold = game.gold - game.knights * 5;
				}
				else {
					//fire guards which we cannot afford
					//for now fire all guards!
					//TODO fire only those who we cannot afford


					var canUpkeep = Math.floor(game.gold/config.knightUpkeep);
					var dismissedKnights = game.knights - canUpkeep;
					game.knights = canUpkeep;
					game.gold -= (canUpkeep * config.knightUpkeep);

					console.group("%c Knights: ", "background-color: cyan; color: #333");
					console.log("Knights: ", game.knights);
					console.groupEnd();

					msg = (canUpkeep > 0) ? localeStrings[338].replace("%arg1", dismissedKnights) : localeStrings[282];
					postEventLog(msg);
				}
			}
			if (game.fireGuard === 1) {
				if (game.gold - game.fireGuardUpkeep() >= 0) {
					game.gold = game.gold - game.fireGuardUpkeep();
				}
				else {
					game.fireGuard = 0;
					setupFirebrigadeUI();
					msg   = localeStrings[283];
					postEventLog(msg);
				}
			}
			if (game.fire === 1 && game.fireGuard === 1) {
				if (game.fireSteps > 0) {
					game.fireSteps = game.fireSteps-1;
					if (game.fireSteps===0) {
						game.fire = 0;
						game.putOutFireUI();
					}
					if (game.fireGuard===1){
						document.getElementById("divFBProgress").style.display="inline";
					}
					var fireProgress = Math.ceil((config.fireStepsBasic-game.fireSteps)/config.fireStepsBasic*100);
					document.getElementById("divFBProgress").innerHTML = localeStrings[275].replace("%arg1",fireProgress);
				}
			}
			//console.log("%c GOLD AFTER UPKEEP PAYMENTS: ", "color: blue", game.gold);
			taxes = Math.round(game.pop*(1+game.buildLevelGallows*1/10),0);
			game.addMoneyToTreasury(taxes);
			if (game.gold !== gold_was) {
				if (game.gold > gold_was) {
					msg = locObj.moneyIncreased.txt;
				} else {
					msg = locObj.moneyDecreased.txt;
				}
				postEventLog(msg);
			}
			if (game.pop !== pop_was) {
				if (game.pop > pop_was) {
					msg = locObj.popIncreased.txt;
				} else {
					msg = locObj.popDecreased.txt;
				}
				postEventLog(msg);
			};
			//TUTORIALS
			gameTips();
			gameStory();
			gameChangePath();
			cnt_cursession = cnt_cursession+1;
			if (cnt_cursession===10) {
				//TODO
				//ym(47225574, 'reachGoal', 'min5');
				//return true;
			}
			//console.log("GOLD AFTER UPDATE: ", game.gold);
			updateUI();
		},
		makeFestival : function() {
			question      = localeStrings[56].replace("%arg1", game.festivalPrice());
			if (game.festival_cooldown !==0) {
				question += localeStrings[57];
			}
			showModal(1, '', game.makeFestivalCallback, question, localeStrings[32], localeStrings[33])
		},
		makeFestivalCallback : function() {
			if (answer === 2) {
				if (game.gold>=game.festivalPrice()) {
					var gold_was          = game.gold;
					game.gold = game.gold-game.festivalPrice();
					var fundraising = Math.floor(game.festivalPrice()*(30-game.festival_cooldown)/30*1.05+2*(game.buildLevelFountain+1));
					game.addMoneyToTreasury(fundraising);
					gold_diff = game.gold-gold_was;
					if (gold_diff>=0){
						msg = localeStrings[59][0].replace("%arg1",gold_diff);
					} else {
						msg = localeStrings[59][1].replace("%arg1",gold_diff);
					}
					postEventLog(msg);
					game.festival_cooldown  = config.festCooldown;
					updateResources();
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			}
		},
		Build : function (Structure) {
			if (Structure==="Wall" || Structure ==="Tower" || Structure ==="Castle") {
				//WALL
				if (game.buildLevelD === 0) {
					if (game.gold >= config.costWall){
						game.buildLevelD        = game.buildLevelD*1 + 1;
						game.gold               = game.gold - config.costWall;
						commonBuild();
						return true;
					} else {
						postEventLog(locObj.notEnoughGold.txt, "bold");
					}
				}
				//WOODEN TOWER
				if (game.buildLevelD === 1) {
					if (game.gold >= config.costTower){
						game.buildLevelD        = game.buildLevelD*1 + 1;
						game.gold               = game.gold - config.costTower;
						commonBuild();
						return true;
					} else {
						postEventLog(locObj.notEnoughGold.txt, "bold");
					}
				}
				//STONE CASTLE
				if (game.buildLevelD === 2) {
					if (game.gold >= config.costCastle) {
						game.buildLevelD        = game.buildLevelD*1 + 1;
						game.gold               = game.gold - config.costCastle;
						commonBuild();
						return true;
					} else {
						postEventLog(locObj.notEnoughGold.txt, "bold");
					}
				}
			}
			if (Structure==="Home") {
				if (game.gold >= Math.pow(config.costHome,(game.buildLevelH*1 + 1)) && game.buildLevelH < config.maxLevelHome) {
					game.gold               = game.gold - Math.pow(config.costHome,(game.buildLevelH*1 + 1));
					game.buildLevelH        = game.buildLevelH*1 + 1;
					commonBuild();
					return true;
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			}
			if (Structure==="Treasury") {
				if (game.gold >= Math.pow(config.costTreasury,(game.buildLevelTreasury*1 + 1))) {
					game.gold               = game.gold - Math.pow(config.costTreasury,(game.buildLevelTreasury*1 + 1));
					game.buildLevelTreasury = game.buildLevelTreasury*1 + 1;
					if (game.isTutorialState && !game.tips.includes("tutorial_treasury_guards")){
						game.tips.push("tutorial_treasury_guards");
						showModal(0, '', getAck, locObj.tutorial_treasury_guards.txt, locObj.okay.txt, '')
						updateImagesBuildingTab();
					}
					commonBuild();
					return true;
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			}
			if (Structure==="Gallows") {
				if (game.gold >= Math.pow(config.costGallows,(game.buildLevelGallows*1 + 1)) && game.buildLevelFountain == 0 && game.buildLevelGallows < config.maxLevelGallows) {
					game.gold               = game.gold - Math.pow(config.costGallows,(game.buildLevelGallows*1 + 1));
					game.buildLevelGallows  = game.buildLevelGallows*1 + 1;
					commonBuild();
					return true;
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			}
			if (Structure==="Fountain") {
				if (game.gold >= Math.pow(config.costFountain,(game.buildLevelFountain*1 + 1)) && game.buildLevelGallows == 0 && game.buildLevelGallows < config.maxLevelGallows) {
					game.gold               = game.gold - Math.pow(config.costFountain,(game.buildLevelFountain*1 + 1));
					game.buildLevelFountain = game.buildLevelFountain*1 + 1;
					commonBuild();
					return true;
				}//TODO make else
			}
			if (Structure==="Stash") {
				if (game.gold >= Math.pow(config.costStash,(game.buildLevelStash*1 + 1)) && game.buildLevelTreasury*1 > 0) {
					game.gold               = game.gold - Math.pow(config.costStash,(game.buildLevelStash*1 + 1));
					game.buildLevelStash    = game.buildLevelStash*1 + 1;
					commonBuild();
					return true;
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			}
			if (Structure==="University") {
				if (game.gold >= Math.pow(config.bldUniversityCost,(game.buildLevelUniversity*1 + 1))) {
					game.gold                 = game.gold - Math.pow(config.bldUniversityCost,(game.buildLevelUniversity*1 + 1));
					game.buildLevelUniversity = game.buildLevelUniversity*1 + 1;
					commonBuild();
					return true;
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			}
			if (Structure==="Inn") {
				//STORY
				if (game.gold >= Math.pow(config.costInn,(game.buildLevelInn*1 + 1)) && game.buildLevelInn < config.maxLevelInn) {
					game.gold               = game.gold - Math.pow(config.costInn,(game.buildLevelInn*1 + 1));
					game.buildLevelInn      = game.buildLevelInn*1 + 1;
					if (game.buildLevelInn===1) {
						game.generateMapCallback(true);
						if (!game.story.includes("story_catastrophe")){
							game.story.push("story_catastrophe");
							showModal(0, '', getAck, locObj.story1_catastrophe.txt, locObj.okay.txt, '')
						}
					}
					populateHeroesForHire();
					commonBuild();
					return true;
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			}
			if (Structure==="Stable") {
				if (game.gold >= Math.pow(config.costStable,(game.buildLevelStable*1 + 1)) && game.buildLevelStable < config.maxLevelStable) {
					game.gold               = game.gold - Math.pow(config.costStable,(game.buildLevelStable*1 + 1));
					if (game.buildLevelStable >= 1) {
						sergeantsData.attack++;
						sergeantsData.defence++;
						sergeantsData.health = Math.round(sergeantsData.health * 1.1);
					}
					if (game.buildLevelArchery >= 1) {
						turkopolsData.attack++;
						turkopolsData.defence++;
						turkopolsData.health = Math.round(turkopolsData.health * 1.1);
					}
					if (game.buildLevelStable >= 2) {
						knightsData.attack++;
						knightsData.defence++;
						knightsData.health = Math.round(knightsData.health * 1.2);
					}
					game.buildLevelStable   = game.buildLevelStable*1 + 1;
					commonBuild();
					return true;
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			}
			if (Structure==="Archery") {
				if (game.buildLevelStable>0){
					if (game.gold >= Math.pow(config.costArchery,(game.buildLevelArchery*1 + 1)) && game.buildLevelArchery < config.maxLevelArchery) {
						game.gold                = game.gold - Math.pow(config.costArchery,(game.buildLevelArchery*1 + 1));
						game.buildLevelArchery   = game.buildLevelArchery*1 + 1;
						commonBuild();
						return true;
					} else {
						postEventLog(locObj.notEnoughGold.txt, "bold");
					}
				} else {
					postEventLog(locObj.buildArchery.txt, "bold");
				}
			}
			function commonBuild() {
				updateUI();
				composite();
			}
		},
		buildGallowsOrFountain(objectToBuild) {
			var costOfBuilding = 0;
			if (objectToBuild==="Fountain") {
				costOfBuilding = config.costFountain;
				question = localeStrings[64].replace("%arg1",localeStrings[142]).replace("%arg2",localeStrings[141]);
			}
			if (objectToBuild==="Gallows") {
				costOfBuilding = config.costGallows;
				question = localeStrings[64].replace("%arg1",localeStrings[141]).replace("%arg2",localeStrings[142]);
			}
			if (game.gold > costOfBuilding) {
				if (game.buildLevelFountain === 0 && game.buildLevelGallows === 0) {
					the_objectToBuild = objectToBuild;
					showModal(1, '', game.buildGallowsOrFountainCallback, question, localeStrings[32], localeStrings[33])
				} else {
					game.Build(objectToBuild);
				}
			} else {
				postEventLog(locObj.notEnoughGold.txt, "bold");
			}
		},
		buildGallowsOrFountainCallback() {
			if (answer === 2) {
				game.Build(the_objectToBuild);
			}
		},
		hireTreasuryGuardCost : function () {
			hireCost =  config.treasuryGuardPriceHire;
			if (game.techLearned.includes("war_propaganda")){
				hireCost = hireCost*techs.war_propaganda.attrs["hire cost"];
				hireCost = Math.ceil(hireCost);
			}
			return hireCost;
		},
		hireTreasuryGuard : function () {
			if (game.buildLevelTreasury >= 1) {
				disabledElements.push("buttonFireGuard");
				disabledElements.push("buttonHireGuard");
				document.getElementById("buttonFireGuard").disabled = true;
				document.getElementById("buttonHireGuard").disabled = true;
				question = localeStrings[18].replace("%arg1",game.hireTreasuryGuardCost()).replace("%arg2",config.treasuryGuardPricePayroll);;
				showModal(1, '', game.hireTreasuryGuardCallback, question,  localeStrings[32], localeStrings[33])
			} else {
				alertMsg = locObj.treasuryRequired.txt;
				showModal(0, '', getAck, alertMsg,  localeStrings[60], '')
			}
		},
		hireTreasuryGuardCallback : function () {
			if (answer === 2) {
				if (game.gold >= config.treasuryGuardPriceHire) {
					game.treasuryGuard = game.treasuryGuard*1 + 1;
					game.gold          = game.gold - game.hireTreasuryGuardCost();
					postEventLog(locObj.hiredGuardsman.txt);
					updateResources();
				} else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			}
			getAck();
		},
		fireTreasuryGuard : function () {
			if (game.treasuryGuard > 0) {
				disabledElements.push("buttonFireGuard");
				disabledElements.push("buttonHireGuard");
				document.getElementById("buttonFireGuard").disabled = true;
				document.getElementById("buttonHireGuard").disabled = true;
				qst = locObj.dialogConfirmDismssGuardsman.txt;
				showModal(1, '', game.fireTreasuryGuardCallback, qst,  localeStrings[32], localeStrings[33])
			} else {
				postEventLog(locObj.noGuardsman.txt, "bold");
			}
		},
		fireTreasuryGuardCallback : function () {
			if (answer === 2) {
				game.treasuryGuard      = game.treasuryGuard*1 - 1;
				postEventLog(locObj.dismissedGuardsman.txt);
				updateResources();
			}
			getAck();
		},
		deathPenalty : function () {
			if (game.buildLevelGallows > 0) {
				if (game.pop > 2) {
					if (game.checkAudio('sfx', 'all')===true) {
						document.getElementById('gallowsAudio0').play();
					}
					game.pop          = game.pop - 1;
					getTypeOfCitizen  = Math.floor(Math.random()*100+1,0);
					if (getTypeOfCitizen >= 1 && getTypeOfCitizen < 50) {
						wealthShare     = 1/100*10;
						shareOfClass    = 50/100;
						citizensOfClass = Math.floor(shareOfClass*game.pop,0);
					}
					if (getTypeOfCitizen >= 50 && getTypeOfCitizen < 80) {
						wealthShare     = 1/100*20;
						shareOfClass    = 30/100;
						citizensOfClass = Math.floor(shareOfClass*game.pop,0);
					}
					if (getTypeOfCitizen >= 80 && getTypeOfCitizen <= 99) {
						wealthShare     = 1/100*30;
						shareOfClass    = 9/100;
						citizensOfClass = Math.floor(shareOfClass*game.pop,0);
					}
					if (getTypeOfCitizen > 99 && getTypeOfCitizen <= 100) {
						wealthShare     = 1/100*40;
						shareOfClass    = 1/100;
						citizensOfClass = Math.floor(shareOfClass*game.pop,0);
					}
					moneyToSeize    = Math.floor(game.gold*wealthShare*game.pop/game.popLimit()/8,0)+1;
					if (moneyToSeize > 5000){
						moneyToSeize = 5000;
					}
					rnd             = Math.floor((Math.random() * 6));
					reason          = locObj.execReasons[rnd].txt;
					msg             = localeStrings[34].replace("%arg1", reason);
					postEventLog(msg);
					msg             = localeStrings[35].replace("%arg1", moneyToSeize);
					postEventLog(msg);
					var gold_diff   = game.addMoneyToTreasury(moneyToSeize);
					if (gold_diff!==moneyToSeize){
						postEventLog(localeStrings[89].replace("%arg1", gold_diff));
					}
				} else {
					alertMsg        = localeStrings[36];
					showModal(0, '', getAck, alertMsg,  localeStrings[60], '')
				}
				updateResources();
			}
		},
		theftFromTreasury : function () {
			if (game.buildLevelTreasury > 0) {
				var guards = 0;
				guards    += game.sergeants + game.turkopols + game.knights;
				if (game.heroExists()===true) {
					if (game.myhero.status===0){// in town
						guards += game.myhero.sergeants + game.myhero.turkopols + game.myhero.knights;
					}
				}
				guards     = Math.ceil(guards / 4);
				guards    += game.treasuryGuard;
				rndThieves = Math.floor(Math.random()*(guards+1)+1);
				console.log(rndThieves);
				if (rndThieves === 1) {
					goldLost      = Math.floor(Math.random() * (game.gold/(1+game.buildLevelStash))/(guards-game.treasuryGuard+1)+1);
					if (goldLost > game.gold) {
						goldLost = game.gold;
					}
					if (game.checkAudio('sfx', 'events')===true) {
						document.getElementById('stealingAudio0').play();
					}
					game.gold     = game.gold - goldLost;
					msg = localeStrings[42].replace("%arg1", goldLost);
					postEventLog(msg);
					updateResources();
					if (game.isTutorialState && !game.tips.includes("tutorial_stash")){
						game.tips.push("tutorial_stash");
						showModal(0, '', getAck, locObj.tutorial_stash.txt, locObj.okay.txt, '')
					}
				} else {
					//TODO make a message about failed robbery
				}
			}
		},
		migration : function () {
			if (game.popLimit() > game.pop){
				rndPopPlus = Math.floor((Math.random() * 4) + 1);
				rnd        = Math.floor((Math.random() * 3) + 1);
				if (rndPopPlus > game.popLimit - game.pop) {
					rndPopPlus = game.popLimit - game.pop;
				}
				if (rnd === 1 && rndPopPlus > 0){
					game.pop += rndPopPlus;
					postEventLog(locObj.new_adepts.txt.replace("%arg1", rndPopPlus), "bold");
				}
				if (rnd === 2 && rndPopPlus > 0 && game.buildLevelFountain > 0){
					game.pop += rndPopPlus;
					postEventLog(locObj.people_arrive.txt.replace("%arg1", rndPopPlus), "bold");
				}
				if (rnd === 3 && game.buildLevelGallows  > 0){
					rndPopMinus = Math.floor((Math.random() * 3) + 1);
					if (game.pop - rndPopMinus > 2){
						game.pop -= rndPopMinus;
						postEventLog(locObj.people_leave.txt.replace("%arg1", rndPopMinus), "bold");
					}
				}
			}
		},
		startFire : function () {
			if (game.year > 1260) {
				if (game.fire === 0) {
					var rnd = Math.floor((Math.random() * 3) + 1);
					console.log('Fire rnd');
					if (rnd === 1) {
						msg = "<b>%arg1</b>";
						msg = msg.replace("%arg1",localeStrings[38]);
						postEventLog(msg);
						game.fire = 1;
						if (game.checkAudio('sfx', 'actions')===true) {
							document.getElementById('fireAudio0').play();
						}
						composite();
						game.fireSteps = config.fireStepsBasic;
						document.getElementById("divFBProgress").innerHTML = localeStrings[275].replace("%arg1","0");
						if (game.fireGuard===1){
							document.getElementById("divFBProgress").style.display="inline";
						}
						document.getElementById("gameIcon").href="resources/favicon-flame.png";
						//TUTORIALS
						if (game.isTutorialState && !game.tips.includes("tutorial_firebrigade") && game.pop>=50){
							game.tips.push("tutorial_firebrigade");
							showModal(0, '', getAck, locObj.tutorial_firebrigade.txt, locObj.okay.txt, '')
						}
						//TODO make a certain building in fire, not just "city"
						if (game.buildLevelD == 1) {
							ceil = 1
						}
						if (game.buildLevelD == 2) {
							ceil = 2
						}
						rnd = Math.floor((Math.random() * 2) + 0);
						if (rnd === 0) {
							//	document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
						}
						if (rnd === 1) {
							//	document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
						}
						if (rnd === 0) {
							//	document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
						}
					}
				} else {
					//you can't get another fire, while you do have previous still burning your city. For now.
				}
			}
		},
		putOutFire : function () {
			if (game.fire === 1) {
				question = localeStrings[39].replace("%arg1", config.costPutOutFire)
				showModal(1, '', game.putOutFireCallback, question,  localeStrings[32], localeStrings[33])
			}
		},
		putOutFireCallback : function () {
			if (answer === 2) {
				if (game.gold >= config.costPutOutFire) {
					game.fire = 0;
					game.fireSteps = 0;
					game.gold = game.gold - config.costPutOutFire;
					game.putOutFireUI();
				}
				else {
					postEventLog(locObj.notEnoughGold.txt, "bold");
				}
			} else {
				msg = localeStrings[41];
				postEventLog(msg);
			}
		},
		putOutFireUI : function(load) {
			if (document.getElementById("fire_graphics") !== null) {
				document.getElementById("fire_graphics").setAttribute("style", "position:absolute; top:200px; left:200px; z-index=100; display:none");
				document.getElementById("buttonPutOutFire").setAttribute("style", "top:390px; left: 20px; display:none");
				document.getElementById("gameIcon").href="resources/favicon-normal.png";
				document.getElementById("divFBProgress").style.display="none";
				if (load!==true){
					msg = localeStrings[40];
					postEventLog(msg);
				}
				updateResources();
			}
		},
		winLottery : function () {
			msg = localeStrings[43].replace("%arg1", config.lotteryPrize);
			postEventLog(msg);
			var gold_diff = game.addMoneyToTreasury(config.lotteryPrize);
			if (gold_diff!==config.lotteryPrize){
				postEventLog(localeStrings[89].replace("%arg1", gold_diff));
			}
			updateResources();
		},
		chestCityAppear : function () {
			game.chestCity = 1;
			chest_timer = setTimeout(game.chestCityDisappear, config.chestCity_timeout);
			composite();
		},
		chestCityDisappear : function () {
			game.chestCity = 0;
			removeIndex = buildingsInTown.indexOf('chest');
			deleteFromArray(buildingsInTown, removeIndex);
			composite();
		},
		chestCityOpen : function () {
			msg = locObj.city_chest_gold.txt.replace("%arg1", config.chestCity);
			postEventLog(msg);
			var gold_diff = game.addMoneyToTreasury(config.chestCity);
			if (gold_diff!==config.chestCity){
				postEventLog(localeStrings[89].replace("%arg1", gold_diff));
			}
			updateResources();
			//REMOVE THE CHEST
			game.chestCityDisappear();
		},
		startPlague : function () {
			if (game.year > 1265) {
				rnd = Math.floor((Math.random() * 15) + 1);
				if (rnd === 1) {
					if (game.pop > 2) {
						numberOfDied = Math.floor(Math.random() * (game.pop*0.65)+game.pop*0.10+1);
						if (numberOfDied>game.pop-2){
							numberOfDied = game.pop-2;
						}
						game.pop     = game.pop - numberOfDied;
						msg = msg = locObj.plague.txt.replace("%arg1", numberOfDied);
						if (game.checkAudio('sfx', 'events')===true) {
							document.getElementById('plagueAudio0').play();
						}
						postEventLog(msg);
						updateResources();
					}
				}
				if (rnd === 2) {
					if (game.pop > 2) {
						if (game.turkopols>0){
							if (game.checkAudio('sfx', 'events')===true) {
								document.getElementById('archeryAudio0').play();
							}
							postEventLog(locObj.plague_turk.txt);
						} else {
							army_count = game.treasuryGuard+game.sergeants+game.knights;
							if (army_count > 0) {
								numberOfDied = Math.floor(Math.random() * (army_count*0.5)+1);
								if (numberOfDied > army_count) {
									numberOfDied = army_count
								}
								if (game.checkAudio('sfx', 'events')===true) {
									document.getElementById('plagueAudio0').play();
								}
								deceased = 0;
								while (deceased < numberOfDied && game.treasuryGuard>0){
									game.treasuryGuard=game.treasuryGuard-1;
									deceased = deceased+1;
								}
								if (deceased < numberOfDied){
									while (deceased < numberOfDied && game.sergeants>0){
										game.sergeants=game.sergeants-1;
										deceased = deceased+1;
									}
								}
								if (deceased < numberOfDied){
									while (deceased < numberOfDied && game.knights>0){
										game.knights=game.knights-1;
										deceased = deceased+1;
									}
								}
								console.log("so the random value of numberOfDied in the army is "+numberOfDied);
								console.log("and number actually deceased troops is "+deceased);
								postEventLog(locObj.plague_army.txt.replace("%arg1", numberOfDied));
								updateTroopsNumbers();
								updateResources();
							}
						}
					}
				}
				if (rnd === 3) {
					army_count = game.treasuryGuard+game.sergeants+game.knights;
					if (army_count > 0) {
						numberOfDied = Math.floor(Math.random() * (army_count*0.5)+1);
						if (numberOfDied > army_count) {
							numberOfDied = army_count
						}
						if (game.checkAudio('sfx', 'events')===true) {
							document.getElementById('plagueAudio0').play();
						}
						deceased = 0;
						while (deceased < numberOfDied && game.treasuryGuard>0){
							game.treasuryGuard=game.treasuryGuard-1;
							deceased = deceased+1;
						}
						if (deceased < numberOfDied){
							while (deceased < numberOfDied && game.sergeants>0){
								game.sergeants=game.sergeants-1;
								deceased = deceased+1;
							}
						}
						if (deceased < numberOfDied){
							while (deceased < numberOfDied && game.knights>0){
								game.knights=game.knights-1;
								deceased = deceased+1;
							}
						}
						console.log("so the random value of numberOfDied in the army is "+numberOfDied);
						console.log("and number actually deceased troops is "+deceased);
						postEventLog(locObj.plague_army.txt.replace("%arg1", numberOfDied));
						updateTroopsNumbers();
						updateResources();
					} else {
						if (game.pop > 2) {
							numberOfDied = Math.floor(Math.random() * (game.pop*0.65)+game.pop*0.10+1);
							if (numberOfDied>game.pop-2){
								numberOfDied = game.pop-2;
							}
							game.pop     = game.pop - numberOfDied;
							msg = locObj.plague.txt.replace("%arg1", numberOfDied);
							if (game.checkAudio('sfx', 'events')===true) {
								document.getElementById('plagueAudio0').play();
							}
							postEventLog(msg);
							updateResources();
						}
					}
				}
			}
		}
	};
	//init const-variables

	var tabLinks 		= document.querySelectorAll('.tab-link');
	var tabs = document.querySelectorAll('.tab');

	function openTab(evt, tabName) {
		if (tabName==="Explore"){
			game.active_tab="Explore";
			console.log('open Explore tab');
		} else {
			game.active_tab="";
			console.log('close Explore tab');
		}
		if (tabName==="Settings"){
			document.getElementById("lblStnUIDValue").innerHTML = game.UID;
			document.getElementById("inpStnAliasValue").value = game.alias;
		}

		tabs.forEach(tab => {
			if (tab.classList.contains('active')) {
				tab.classList.remove('active');
			}

			if (tab.getAttribute('id') === tabName) {
				tab.classList.add('active');
			}

		});

		tabLinks.forEach(tabLink => {
			if (tabLink.classList.contains('active')) {
				tabLink.classList.remove('active');
			}
		});


		if (evt !== null) {
			evt.currentTarget.classList.add('active');
		}
		if (tabName==="tabTroopsHiring"){
			if (game.isTutorialState && !game.tips.includes("tutorial_moving_troops") && game.heroExists()){
				game.tips.push("tutorial_moving_troops");
				showModal(0, '', getAck, locObj.tutorial_moving_troops.txt, locObj.okay.txt, '');
			}
		}
	}
	document.getElementById("tabCity").click();


	// 2. Выносим сюда config и game






</script>
<script>
	//TOWN
	var canvas  	= document.getElementById("canvas");
	var canvasPos = getElementPosition(canvas);

	canvas.addEventListener("touchstart", tap);
	canvas.addEventListener("mousedown", tap);
	canvasScaleRatio = canvas.width / canvas.offsetWidth;
	languageDefined = 0;

	var ctx     = canvas.getContext("2d");
	//use forward slashes for Linux and Windows compatible. \ this slash works only in Windows.
	// if (theme === "winter") {
	// 	var img1    = loadImage('resources/background_a_w.png', composite);
	// 	var img2    = loadImage('resources/sawmill_a_w.png', composite);
	// } else {
	// 	var img1    = loadImage('resources/background_a.png', composite);
	// 	var img2    = loadImage('resources/sawmill_a.png', composite);
	// }
	// var sawmillX     = 670;
	// var sawmillY     = 65;
	// var sawmillW     = 110;
	// var sawmillH     = 56;
	// var img3    = loadImage('resources/gold_a.png', composite);
	// var goldX        = 10;
	// var goldY        = 40;
	// var goldW        = 28;
	// var goldH        = 22;
	// var img4    = loadImage('resources/pop_a.png', composite);
	// var popX         = 10;
	// var popY         = 80;
	// var popW         = 29;
	// var popH         = 22;
	// var amber_ico = loadImage('resources/amber_ico.png', composite);
	// var amberX       = 10;
	// var amberY       = 120;
	// var amberW       = 30;
	// var amberH       = 22;
	// if (theme === "winter") {
	// 	var img5    = loadImage('resources/home_as_w.png', composite);
	// } else {
	// 	var img5    = loadImage('resources/home_as.png', composite);
	// }
	// var homeX        = 90;
	// var homeY        = 160;
	// var homeW        = 80;
	// var homeH        = 90;
	// if (theme === "winter") {
	// 	var img5_1  = loadImage('resources/house_as_w.png', composite);
	// } else {
	// 	var img5_1  = loadImage('resources/house_as.png', composite);
	// }
	// var houseX       = 90;
	// var houseY       = 160;
	// var houseW       = 113;
	// var houseH       = 125;
	// if (theme === "winter") {
	// 	var img6_1  = loadImage('resources/wallsr_a_w.png', composite);
	// 	var img6_2  = loadImage('resources/wallsf_a_w.png', composite);
	// } else {
	// 	var img6_1  = loadImage('resources/wallsr_a.png', composite);
	// 	var img6_2  = loadImage('resources/wallsf_a.png', composite);
	// }
	// var wallX        = 330;
	// var wallY        = 400;
	// var wallW        = 110;
	// var wallH        = 65;
	// if (theme === "winter") {
	// 	var img7    = loadImage('resources/castle_as_w.png', composite);
	// } else {
	// 	var img7    = loadImage('resources/castle_as.png', composite);
	// }
	// var castleX      = 300;
	// var castleY      = 160;
	// var castleW      = 180;
	// var castleH      = 160;
	// if (theme === "winter") {
	// 	var img71   = loadImage('resources/castle_st_w.png', composite);
	// } else {
	// 	var img71   = loadImage('resources/castle_st.png', composite);
	// }
	// var castle_st_X  = 300;
	// var castle_st_Y  = 160;
	// var castle_st_W  = 195;
	// var castle_st_H  = 175;
	// if (theme === "winter") {
	// 	var img8    = loadImage('resources/wishing_well_builded_w.png', composite);
	// } else {
	// 	var img8    = loadImage('resources/wishing_well_builded.png', composite);
	// }
	// var wellX        = 230;
	// var wellY        = 200;
	// var wellW        = 41;
	// var wellH        = 47;
	// if (theme === "winter") {
	// 	var img9    = loadImage('resources/treasury_as_w.png', composite);
	// } else {
	// 	var img9    = loadImage('resources/treasury_as.png', composite);
	// }
	// var treasuryX    = 200;
	// var treasuryY    = 270;
	// var treasuryW    = 125;
	// var treasuryH    = 120;
	// if (theme === "winter") {
	// 	var img10   = loadImage('resources/gallows_w.png', composite);
	// } else {
	// 	var img10   = loadImage('resources/gallows.png', composite);
	// }
	// var gallowsX     = 485;
	// var gallowsY     = 270;
	// var gallowsW     = 50;
	// var gallowsH     = 75;
	// if (theme === "winter") {
	// 	var img11   = loadImage('resources/fountain_w.png', composite);
	// } else {
	// 	var img11   = loadImage('resources/fountain.png', composite);
	// }
	// var fountainX    = 485;
	// var fountainY    = 290;
	// var fountainW    = 70;
	// var fountainH    = 55;
	// //var img13 is already used in fire singleton
	// if (theme === "winter") {
	// 	var img14   = loadImage('resources/inn_w.png', composite);
	// } else {
	// 	var img14   = loadImage('resources/inn.png', composite);
	// }
	// var innX = 270;
	// var innY = 80;
	// var innW = 87;
	// var innH = 79;
	// var img15   = loadImage('resources/fire_a.gif', composite);
	// img15.id      = "fire_graphics";
	// if (theme === "winter") {
	// 	var img16   = loadImage('resources/stable_w.png', composite);
	// } else {
	// 	var img16   = loadImage('resources/stable.png', composite);
	// }
	// var stableX = 480;
	// var stableY = 100;
	// var stableW = 160;
	// var stableH = 120;
	// if (theme === "winter") {
	// 	var img17   = loadImage('resources/archery_range_w.png', composite);
	// } else {
	// 	var img17   = loadImage('resources/archery_range.png', composite);
	// }
	// var archeryX = 390;
	// var archeryY = 90;
	// var archeryW = 80;
	// var archeryH = 80;
	// var smoke_anm   = loadImage('resources/smoke.gif', composite);
	// var smoke_anm2  = loadImage('resources/smoke.gif', composite);
	// //smoke_and.id      = "smoke_graphics";
	// var smokeX = 90;
	// var smokeY = 260;
	// var smokeW = 100;
	// var smokeH = 100;
	// if (theme === "winter") {
	// 	var chest_img   = loadImage('resources/chest_w.png', composite);
	// } else {
	// 	var chest_img   = loadImage('resources/chest.png', composite);
	// }
	// var chest_imgW = 48;
	// var chest_imgH = 48;

	// buildingsInTownB=[];
	// buildingsInTownX=[];
	// buildingsInTownY=[];
	// buildingsInTownW=[];
	// buildingsInTownH=[];

	var resourceDir = './resources/'

	var RES_NAME_SUFFIX = {
		AUTUMN:	'_a',
		WINTER: '_w',
		SPRING:	'_s',
	};

	Object.freeze(RES_NAME_SUFFIX);

	function prepareResPath(resourceName) {
		switch(config.theme) {
			case 'autumn'	: return resourceDir + resourceName + RES_NAME_SUFFIX.AUTUMN + '.png';
			case 'winter'	: return resourceDir + resourceName + RES_NAME_SUFFIX.WINTER + '.png';
			case 'spring'	: return resourceDir + resourceName + RES_NAME_SUFFIX.SPRING + '.png';
			default				: return resourceDir + resourceName + '.png';
		}
	}

	function loadImage(src, onload) {
		var img = new Image();
		img.onload = onload;
		img.src = src;
		return img;
	}

	//use forward slashes for Linux and Windows compatible. \ this slash works only in Windows.

	var img1 		= loadImage(prepareResPath('background_a'), composite);
	var img2 		= loadImage(prepareResPath('sawmill_a'), composite);
	var img5 		= loadImage(prepareResPath('home_as'), composite);
	var img5_1  = loadImage(prepareResPath('house_as'), composite);
	var img6_1  = loadImage(prepareResPath('wallsr_a'), composite);
	var img6_2  = loadImage(prepareResPath('wallsf_a'), composite);
	var img7    = loadImage(prepareResPath('castle_as'), composite);
	var img71   = loadImage(prepareResPath('castle_st'), composite);
	var img8    = loadImage(prepareResPath('wishing_well_builded'), composite);
	var img9    = loadImage(prepareResPath('treasury_as'), composite);
	var img10   = loadImage(prepareResPath('gallows'), composite);
	var img11   = loadImage(prepareResPath('fountain'), composite);
	var img14   = loadImage(prepareResPath('inn'), composite);

	var img15   = loadImage('resources/fire_a.gif', composite);
	img15.id    = "fire_graphics";

	var img16   = loadImage(prepareResPath('stable'), composite);
	var img17   = loadImage(prepareResPath('archery_range'), composite);

	var smoke_anm      = loadImage('resources/smoke.gif', composite);
	var smoke_anm2     = loadImage('resources/smoke.gif', composite);
	var chest_img      = loadImage(prepareResPath('chest'), composite);
	var university_img = loadImage(prepareResPath('university2'), composite);
	var university   = {
		name: 'university',
		x: 550,
		y: 250,
		w: 96,
		h: 96
	}
	var sawmill = {
		name: 'sawmill',
		x: 670,
		y: 65,
		w: 110,
		h: 56
	};

	var well = {
		name: 'well',
		x: 230,
		y: 200,
		w: 41,
		h: 47
	};

	var home = {
		name: 'home',
		x: 90,
		y: 160,
		w: 80,
		h: 90
	};

	var house = {
		name: 'house',
		x: 90,
		y: 160,
		w: 113,
		h: 125,
	};

	var wall = {
		name: 'wall',
		x: 340,
		y: 400,
		w: 115,
		h: 50
	};

	var tower = {
		name: 'tower',
		x: 300,
		y: 160,
		w: 180,
		h: 160
	};

	var castle = {
		name: 'castle',
		x: 300,
		y: 160,
		w: 195,
		h: 175
	};

	var castle_st = {
		name: 'stone_castle',
		x: 300,
		y: 160,
		w: 195,
		h: 175
	};

	var treasury = {
		name: 'treasury',
		x: 200,
		y: 270,
		w: 125,
		h: 120
	};

	var gallows = {
		name: 'gallows',
		x: 485,
		y: 270,
		w: 50,
		h: 75
	};

	var fountain = {
		name: 'fountain',
		x: 485,
		y: 290,
		w: 70,
		h: 55
	};

	var stable = {
		name: 'stable',
		x: 480,
		y: 100,
		w: 160,
		h: 120
	};

	var archery = {
		name: 'archery',
		x: 390,
		y: 90,
		w: 80,
		h: 80
	};

	var inn = {
		name: 'inn',
		x: 270,
		y: 80,
		w: 87,
		h: 79
	};

	var chest = {
		name: 'chest',
		x: 0,
		y: 0,
		w: 48,
		h: 48,
	}

	var buildingsInTown = [];

	function inArray (arrayToCheck, valueToCheck) {
		 return arrayToCheck.indexOf(valueToCheck) > -1;
	}
	function deleteFromArray (arrayToMod, indexToDelete) {
		arrayLenght                = arrayToMod.length;
		tArrayBeforeDeletedElement = arrayToMod.slice(0,indexToDelete);
		tArrayAfterDeletedElement  = arrayToMod.slice(indexToDelete+1,arrayToMod.length);
		tResultArray               = tArrayBeforeDeletedElement.concat(tArrayAfterDeletedElement);
		return tResultArray;
	}
	function removeFromArrays (elementIndex) {
		buildingsInTownB = deleteFromArray(buildingsInTownB, elementIndex);
		buildingsInTownX = deleteFromArray(buildingsInTownX, elementIndex);
		buildingsInTownY = deleteFromArray(buildingsInTownY, elementIndex);
		buildingsInTownW = deleteFromArray(buildingsInTownW, elementIndex);
		buildingsInTownH = deleteFromArray(buildingsInTownH, elementIndex);
	}
	var Singleton = (function () {
		var instance;
		function createInstance() {
			var object = loadImage('resources/fire_static.png');
			return object;
		}
		return {
			getInstance: function () {
				if (!instance) {
					instance = createInstance();
				}
				return instance;
			}
		};
	})();
	//var imagesLoaded = 0;
	// function pushBuilding(buildingName, buildingX, buildingY, buildingW, buildingH){
	// 	if (buildingsInTownB.indexOf(buildingName)==-1) {
	// 		if (buildingName==='house') {
	// 			removeIndex = buildingsInTownB.indexOf('home');
	// 			removeFromArrays(removeIndex);
	// 		}
	// 		if (buildingName==='swall') {
	// 			removeIndex = buildingsInTownB.indexOf('wall');
	// 			removeFromArrays(removeIndex);
	// 		}
	// 		if (buildingName==='stone_castle') {
	// 			removeIndex = buildingsInTownB.indexOf('castle');
	// 			removeFromArrays(removeIndex);
	// 		}
	// 		buildingsInTownB.push(buildingName);
	// 		buildingsInTownX.push(buildingX);
	// 		buildingsInTownY.push(buildingY);
	// 		buildingsInTownW.push(buildingW);
	// 		buildingsInTownH.push(buildingH);
	// 	}
	// }

	function pushBuilding(buildingObj) {
		if (buildingsInTown.includes(buildingObj)) {
			return
		}

		if (buildingObj.name === house.name) {
			const index = buildingsInTown.findIndex(function (building) {
				return building.name === home.name;
			});
			if (index > -1) {
				buildingsInTown.splice(index, 1);
			}
		}


		if (buildingObj.name === castle_st.name) {
			const index = buildingsInTown.findIndex(function (building) {
				return building.name === castle.name;
			});
			if (index > -1) {
				buildingsInTown.splice(index, 1);
			}
		}

		buildingsInTown.push(buildingObj);
		console.log(buildingsInTown)
	};

	function composite() {
		ctx.clearRect(0, 0, 800, 480);
		ctx.drawImage(img1, 0, 0);   //draw background
		ctx.drawImage(img2, sawmill.x, sawmill.y);//draw sawmill
		pushBuilding(sawmill);

		ctx.drawImage(img8, well.x, well.y); //draw wishing well
		pushBuilding(well);
		if (game.buildLevelD > 0) {
			// draw back piece of wall
			ctx.drawImage(img6_1, 0, 0);
			// draw front piece of wall
			ctx.drawImage(img6_2, 0, 0);
			//pushing gatehouse of the wall
			pushBuilding(wall);
		}
		if (game.buildLevelH > 0 && game.buildLevelH < 10) {
			// draw homes
			ctx.drawImage(img5, home.x, home.y);
			pushBuilding(home);
			smoke_anm.style   = 'position:absolute; top: 0; left: 0;';
			document.getElementById("events_graphics").appendChild(smoke_anm);
		}

		if (game.buildLevelH >= 10) {
			// draw more houses
			ctx.drawImage(img5_1, house.x, house.y);
			pushBuilding(house);
			smoke_anm.style   = 'position:absolute; top: 0; left: 30px;';
			document.getElementById("events_graphics").appendChild(smoke_anm);
			smoke_anm2.style   = 'position:absolute; top: 30px; left: 0';
			document.getElementById("events_graphics").appendChild(smoke_anm2);
		}
		if (game.buildLevelD === 2) {
			// draw castle
			ctx.drawImage(img7, castle.x, castle.y);
			pushBuilding(castle);
		}
		if (game.buildLevelD === 3) {
			// draw castle
			ctx.drawImage(img71, castle_st.x, castle_st.y);
			pushBuilding(castle_st);
		}
		if (game.buildLevelTreasury > 0) {
			// draw treasury
			ctx.drawImage(img9, treasury.x, treasury.y);
			pushBuilding(treasury);
		}
		if (game.buildLevelGallows > 0) {
			// draw gallows
			ctx.drawImage(img10, gallows.x, gallows.y);
			pushBuilding(gallows);
		}
		if (game.buildLevelFountain > 0) {
			// draw fountain
			ctx.drawImage(img11, fountain.x, fountain.y);
			pushBuilding(fountain);
		}
		if (game.buildLevelStash > 0) {
			//We do not draw a secret Stash under the Treasury. It's a secret, are you understand?!
		}
		if (game.buildLevelInn > 0) {
			ctx.drawImage(img14, inn.x, inn.y);
			pushBuilding(inn);
		}

		if (game.buildLevelStable > 0) {
			ctx.drawImage(img16, stable.x, stable.y);
			pushBuilding(stable);
		}

		if (game.buildLevelUniversity > 0) {
			ctx.drawImage(university_img, university.x, university.y);
			pushBuilding(university);
		}

		if (game.buildLevelArchery > 0) {
			ctx.drawImage(img17, archery.x, archery.y);
			pushBuilding(archery);
		}

		if (game.fire === 1) {
			img15.style   = 'position:absolute; top:240px; left:80px; z-index:8';
			document.getElementById("events_graphics").appendChild(img15);
			//img15.style   = 'position:absolute; top:170px; left:0px; z-index:8';
			// document.getElementById("fire_graphics").setAttribute("onclick", "game.putOutFire()");
			document.getElementById("buttonPutOutFire").style.display="block";
		}
		if (game.chestCity === 1) {
			console.log("try to draw a chest of gold");
			chest.x = Math.floor(Math.random() * (800-chest.w*2)+chest.w);
			chest.y = Math.floor(Math.random() * (480-chest.h*2)+chest.h);
			console.log("locX is "+chest.x+" and locY is "+chest.y);
			ctx.drawImage(chest_img, chest.x, chest.y);
			pushBuilding(chest);
		}
	}
	function loadImage(src, onload) {
		var img = new Image();
		img.onload = onload;
		img.src = src;
		return img;
	}
	function getElementPosition (element) {
		//thanks to William Alone
		var parentOffset,
				pos = {
					x: element.offsetLeft,
					y: element.offsetTop
				};
		if (element.offsetParent) {
			parentOffset = getElementPosition(element.offsetParent);
			pos.x += parentOffset.x;
			pos.y += parentOffset.y;
		}
		return pos;
	}

	function tap (e) {
		var x = (e.pageX - canvasPos.x) * canvasScaleRatio;
		var y = (e.pageY - canvasPos.y) * canvasScaleRatio;

		buildingsInTown.forEach(function(element) {
			if (y > element.y && y < element.y + element.h && x > element.x && x < element.x + element.w) {
				buildingClick(element.name)
			}
		});

		// pos = getElementPosition(canvas);
		// loc = {};
		// tapX = e.targetTouches ? e.targetTouches[0].pageX : e.pageX;
		// tapY = e.targetTouches ? e.targetTouches[0].pageY : e.pageY;

		// loc.x = (tapX - 9) * canvasScaleRatio;
		// loc.y = (tapY - 58) * canvasScaleRatio;
		// for (bi=0;bi<buildingsInTownB.length;bi++){
		// 	if (loc.x >= buildingsInTownX[bi] && loc.x <= buildingsInTownX[bi]+buildingsInTownW[bi]) {
		// 		if (loc.y >= buildingsInTownY[bi] && loc.y <= buildingsInTownY[bi]+buildingsInTownH[bi]) {
		// 			console.log(buildingsInTownB[bi]);
		// 			buildingClick(buildingsInTownB[bi]);
		// 		}
		// 	}
		// }
	}
	function buildingClick(buildingName){
		console.log('buildingName: ', buildingName);
		var showAlert = true;
		alertMsg = "";
		if (buildingName==='amber'){
			alertMsg = localeStrings[90];
		}
		if (buildingName==='well') {
			showAlert = false;
			checkFirebrigade();
		}
		if (buildingName==='gold') {
			showAlert = false;
			checkGold();
		}
		if (buildingName==='pop') {
			//alertMsg = localeStrings[145];
			showAlert = false;
			checkPop();
		}
		if (buildingName==='sawmill') {
			showAlert = false;
			if (game.checkAudio('sfx', 'all')===true) {
				var arnd = Math.floor(Math.random() * 3);
				var Audio = 'sawmillAudio'+arnd;
				document.getElementById(Audio).play();
			}
			//alertMsg = localeStrings[133];
		}
		if (buildingName==='wall') {
			//alertMsg = localeStrings[134];
		}
		if (buildingName==='university') {
			showAlert = false;
			updateUI();
			openTab(null, 'tabUniversity');
		}
		if (buildingName==='swall') {
			//alertMsg = localeStrings[135];
		}
		if (buildingName==='home') {
			showAlert = false;
			checkPop();
		}
		if (buildingName==='house') {
			showAlert = false;
			checkPop();
		}
		if (buildingName==='castle') {
			showAlert = false;
			alertMsg = localeStrings[136];
		}
		if (buildingName==='stone_castle') {
			showAlert = false;
			alertMsg = localeStrings[137];
		}
		if (buildingName==='inn') {
			//alertMsg = localeStrings[140];
			showAlert = false;
			if (game.checkAudio('sfx', 'all')===true) {
				document.getElementById('innAudio0').play();
			}
			openTab(null, 'tabInn');
		}
		if (buildingName==='gallows') {
			//alertMsg = localeStrings[141];
			showAlert = false;
			game.deathPenalty();
		}
		if (buildingName==='fountain') {
			showAlert = false;
			if (game.checkAudio('sfx', 'all')===true) {
				document.getElementById('fountainAudio0').play();
			}
			game.makeFestival();
		}
		if (buildingName==='treasury') {
			openTab(null, 'tabGarrison');
			if (game.checkAudio('sfx', 'all')===true) {
				var arnd = Math.floor(Math.random() * 3);
				var Audio = 'treasuryAudio'+arnd;
				document.getElementById(Audio).play();
			}
		}
		if (buildingName==='stable') {
			showAlert = false;
			if (game.checkAudio('sfx', 'all')===true) {
				var arnd = Math.floor(Math.random() * 3);
				var Audio = 'stableAudio'+arnd;
				document.getElementById(Audio).play();
			}
			updateUI();
			openTab(null, 'tabTroopsHiring');
		}
		if (buildingName==='archery') {
			showAlert = false;
			if (game.checkAudio('sfx', 'all')===true) {
				var arnd = Math.floor(Math.random() * 3);
				var Audio = 'archeryAudio'+arnd;
				document.getElementById(Audio).play();
			}
			updateUI();
			openTab(null, 'tabTroopsHiring');
		}
		if (buildingName === chest.name) {
			showAlert = false;
			game.chestCityOpen();
		}
		if (showAlert === true &&  alertMsg !=="" ) {
			showModal(0, '', getAck, alertMsg,  localeStrings[60], '')
		}
	}
	//composite();
</script>
<!--THE GAME-->
<script>
//THE GAME


/*-- New --*/

var WeightedRandom = function() {
  this.entries = [];
  this.accumulatedWeight = 0.0;
};

WeightedRandom.prototype.addEntry = function(object, weight) {
  this.accumulatedWeight += weight;
  this.entries.push( { object: object, accumulatedWeight: this.accumulatedWeight });
}

WeightedRandom.prototype.getRandom = function() {
  var r = Math.random() * this.accumulatedWeight;
  return this.entries.find(function(entry) {
    return entry.accumulatedWeight >= r;
  }).object;
};

WeightedRandom.prototype.clearEntriesList = function() {
	this.entries = [];
};


	function randomFromRange(min, max) {
	  let rand = min - 0.5 + Math.random() * (max - min + 1);
	  return Math.round(rand);
	};

	function isEmptyObj(obj) {
		for (var key in obj) return false;
		return true;
	};

	function objSize(obj) {
		var size = 0, key;
		for (key in obj) {
			if (obj.hasOwnProperty(key)) size++;
		}
		return size;
	};


	function shuffleArray(array) {
		for (var i = array.length - 1; i > 0; i--) {
			var j = Math.floor(Math.random() * (i + 1));
			var temp = array[i];
			array[i] = array[j];
			array[j] = temp;
		}
		return array;
	}
	//init variables
	var disabledElements = [];
	var hiddenElements = []; // Cache for hidden UI elements; NOTE: Do not clear it, temp fix for tutorial elements.
	flag_event_started = "";
	allowMvt = 1;
	curObjId = "";


	//OTHERWISE RECORDS ONLY ADDS AND STACKS IN THE SAME OBJECT FOR DIFFERENT HEROES
	//CANDIDATE FOR DELETING
	//var heroAttributesRandomizer = new WeightedRandom();

	var enemyRandomizer = new WeightedRandom();
	function Monster(monster, coordx, coordy, monsterData) {
		this.monster = monster;
		this.coordx = coordx;
		this.coordy = coordy;
		this.name   	= monsterData.name;
		this.minDmg 	= monsterData.minDmg;
		this.maxDmg 	= monsterData.maxDmg;
		this.attack 	= monsterData.attack;
		this.defence	= monsterData.defence;
		this.count 		= monsterData.defence;
		this.health 	= monsterData.health;
	}




	//init service variables
	var cnt_cursession= 0;
	var delimiter     = ";"
	var nightMode     = 0;
	var dcounter_def  = 30;
	var dcounter      = dcounter_def;
	var curHeroForHire= 0;
	var heroesForHire = [];
	var dialogShown   = false;
	if (typeof updateResources === "function") { updateResources() }
	var autosaveObject;
	//setupAutosave();//DEBUG
	//composite();

	include('localisation.js',function(){
		console.log('load1');
		loadStartLocale();
		console.log('we are in first level include after loadStartLocale()');
	});

	openLog();
	setInterval(cooldown, config.oneSecMS);
	setInterval(endOfTurnTimer, config.oneSecMS);

	//functions
	function openTabAutocampaignJournal() {
		openTab(null, 'tabAutocampaignJournal');
		scrollDown();
	}
	function openTabAutocampaignBattle() {
		openTab(null, 'tabAutocampaignBattle');
		scrollDown();
	}

	function checkSaves() {

		if (localStorage.getItem('game')!==null) {
			document.getElementById("loadGameButton").style.display = "block";
		} else {
			if (game.isTutorialState && !game.tips.includes("tutorial0-welcome0")){
				game.tips.push("tutorial0-welcome0");
				showModal(0, '', getAck, locObj.tutorial0_w0.txt, locObj.okay.txt, locObj.skipTutorial.txt)
			}
		}

	}

	function getAck() {
		console.log('we are at getAck method');
		console.log("the length is "+disabledElements.length);

		if (answer === 3) {
			game.isTutorialState = false;
			// document.getElementById("tabBuilding").classList.remove('is-tutorial');
			for (var i=0; i<disabledElements.length; i++) {
				document.getElementById(disabledElements[i]).disabled = false;
			}

			hiddenElements = document.querySelectorAll('.is-tutorial');
			if (hiddenElements.length) {
				hiddenElements.forEach(function (el) {
					el.classList.remove('is-tutorial');
				})
			}
		}

		for (var i=0; i<disabledElements.length; i++) {
			console.log('we are inside the loop');
			document.getElementById(disabledElements[i]).disabled = false;
		}
		disabledElements = [];
		dialogShown = false;
	}
	function reloadLang() {
		var x = document.getElementById("selectLng").selectedIndex;
		var y = document.getElementById("selectLng").options;
		language = y[x].value; //y[x].id, text, index
		loadLocale(language);
	}
	function localeCallback(returnLanguage) {
		if (returnLanguage==='en-US') {
			document.getElementById("selectLng").selectedIndex=0;
		}
		if (returnLanguage==='ru-RU') {
			document.getElementById("selectLng").selectedIndex=1;
		}
		if (returnLanguage==='de-DE') {
			document.getElementById("selectLng").selectedIndex=2;
		}
		if (returnLanguage==='eo') {
			document.getElementById("selectLng").selectedIndex=3;
		}
		if (returnLanguage==='fr-FR') {
			document.getElementById("selectLng").selectedIndex=4;
		}
		if (returnLanguage==='fi-FI') {
			document.getElementById("selectLng").selectedIndex=5;
		}
		document.getElementById("buttonPutOutFire").innerText    = localeStrings[53];
		document.getElementById("buttonDeathPenalty").innerText  = localeStrings[54];
		document.getElementById("saveGameButton").innerText      = localeStrings[44];
		document.getElementById("loadGameButton").innerText      = localeStrings[45];
		document.getElementById("tabCity").innerText             = localeStrings[46];
		//document.getElementById("tabExplore").innerText          = localeStrings[47];
		document.getElementById("tabSettings").innerText         = localeStrings[48];
		//document.getElementById("tabGarrison").innerText         = localeStrings[49];
		document.getElementById("tabBuilding").innerText         = localeStrings[50];
		document.getElementById("tabAbout").innerText            = localeStrings[51];
		document.getElementById("tabDiscord").innerText          = localeStrings[52];
		document.getElementById("labelSettings").innerText       = localeStrings[66];
		document.getElementById("labelSettings").innerText       = localeStrings[66];
		document.getElementById("buttonExportGame").innerText    = localeStrings[67];
		document.getElementById("buttonImportGame").innerText    = localeStrings[68];
		document.getElementById("labelAutosave").innerText       = localeStrings[69];
		document.getElementById("labelGarrison").innerText       = localeStrings[91];
		document.getElementById("buttonFireGuard").innerText     = localeStrings[92];
		document.getElementById("buttonHireGuard").innerText     = localeStrings[93];
		document.getElementById("labelBuilding").innerText       = localeStrings[106];
		document.getElementById("lblAboutGame").innerHTML        = localeStrings[131].replace("%arg1",config.treasuryGuardPriceHire).replace("%arg2",config.treasuryGuardPricePayroll);
		document.getElementById("lblTabPop").innerText           = localeStrings[161];
		document.getElementById("lblTabGold").innerText          = localeStrings[164];
		document.getElementById("btnColorMode").innerText        = localeStrings[70];
		document.getElementById("lblTabInn").innerText           = localeStrings[181];
		document.getElementById("lblUpkeepSrc").innerText        = localeStrings[279];
		document.getElementById("selectUpkeepSrc")[0].text       = localeStrings[284];
		document.getElementById("selectUpkeepSrc")[1].text       = localeStrings[285];
		document.getElementById("btnColorMode").innerText        = localeStrings[70];
		document.getElementById("btnDismissHero").innerText      = localeStrings[217];
		//document.getElementById("btnAutocampaign").innerText     = localeStrings[218];
		document.getElementById("btnAutocampaignJournal").innerText  = localeStrings[220];
		document.getElementById("btnTowngate").innerText         = localeStrings[221];
		document.getElementById("btnLeaveCity").innerText        = localeStrings[222];
		document.getElementById("btnGenerateMap").innerText      = localeStrings[223];

		document.getElementById("btnAutobattlesList").innerText  = locObj.autobattle_journal_btn.txt;

		document.getElementById("lblOption").innerText           = localeStrings[71];
		document.getElementById("lblOn").innerText               = localeStrings[72];
		document.getElementById("lblOff").innerText              = localeStrings[73];
		document.getElementById("lblSfxAll").innerText           = localeStrings[74];
		document.getElementById("lblSfxEvt").innerText           = localeStrings[75];
		document.getElementById("lblSfxEvtAR").innerText         = localeStrings[76];
		document.getElementById("lblMscAll").innerText           = localeStrings[77];
		document.getElementById("lblMscScr").innerText           = localeStrings[78];
		document.getElementById("btnToGeneralSettings").innerText= localeStrings[79];

		document.getElementById("btnToInn").innerText            = localeStrings[79];
		document.getElementById("btnToInn1").innerText           = localeStrings[79];

		document.getElementById("lblSoundMenu").innerText        = localeStrings[80];
		document.getElementById("btnSoundSettings").innerText    = localeStrings[81];
		document.getElementById("lblStnMobileUI").innerText      = localeStrings[82];
		document.getElementById("lblStnEventLogSize").innerText  = localeStrings[83];
		document.getElementById("lblStnLines").innerText         = localeStrings[84];
		/*
		document.getElementById("lblTroopsHiring").innerText     = localeStrings[94];
		document.getElementById("btnHireSergeant").innerHTML     = localeStrings[97].replace("%arg1",config.sergeantHiring);
		document.getElementById("btnHireTurkopol").innerHTML     = localeStrings[98].replace("%arg1",config.turkopolHiring);
		document.getElementById("btnHireKnight").innerHTML       = localeStrings[99].replace("%arg1",config.knightHiring);
		document.getElementById("lblTabHiringTroopsSergeantsGarrison").innerText       = localeStrings[100];
		document.getElementById("lblTabHiringTroopsTurkopolsGarrison").innerText       = localeStrings[101];
		document.getElementById("lblTabHiringTroopsKnightsGarrison").innerText         = localeStrings[102];
		document.getElementById("lblTabHiringTroopsSergeantsHeroSquad").innerText      = localeStrings[100];
		document.getElementById("lblTabHiringTroopsTurkopolsHeroSquad").innerText      = localeStrings[101];
		document.getElementById("lblTabHiringTroopsKnightsHeroSquad").innerText        = localeStrings[102];
		document.getElementById("lblTabHiringTroopsKnightsHeroSquad").innerText        = localeStrings[102];
		*/
		document.getElementById("lblGoodsForSale").innerText     = localeStrings[260];

		//document.getElementById("lblArtefactSellPrice").innerText= localeStrings[261];
		//document.getElementById("lblArtefactBuyPrice").innerText = localeStrings[261];
		//document.getElementById("btnBuyArtefact").innerText      = localeStrings[262];
		document.getElementById("lblGoodsForBuying").innerText   = localeStrings[263];
		//document.getElementById("btnSellArtefact").innerText     = localeStrings[264];
		document.getElementById("btnLeaveBlackmarket").innerText = localeStrings[222];
		document.getElementById("lblFirebrigade").innerText      = localeStrings[270];
		document.getElementById("lblFBOption").innerText         = localeStrings[271];
		document.getElementById("lblFBOn").innerText             = localeStrings[272];
		document.getElementById("lblFBOff").innerText            = localeStrings[273];
		document.getElementById("lblFBUpKeepPrice").innerText    = localeStrings[274];
		document.getElementById("btnPopAtStart").innerText       = localeStrings[157];
		document.getElementById("btnGoldAtStart").innerText      = localeStrings[157];
		document.getElementById("btnPopPrev").innerText          = localeStrings[158];
		document.getElementById("btnGoldPrev").innerText         = localeStrings[158];
		document.getElementById("btnPopNext").innerText          = localeStrings[159];
		document.getElementById("btnGoldNext").innerText         = localeStrings[159];
		document.getElementById("btnPopAtEnd").innerText         = localeStrings[160];
		document.getElementById("btnGoldAtEnd").innerText        = localeStrings[160];
		document.getElementById("downloadGame").innerText        = localeStrings[328];
		document.getElementById("lblLevelForHireLbl").innerText  = locObj.heroLvlLbl.txt;
		populateHeroesForHire();
		checkSaves();
		welcomeMsg();
		updateButtonCaptions();
		updateHeroStatus();
		loadArtifacts();
		updateUI();
	}
	function loadArtifacts(){
		include('js/artifacts.js',function(){
			console.log('we are loading the artifacts');
		});
	}
	function welcomeMsg(){
		postEventLog(locObj.welcome0.txt);
		postEventLog(locObj.welcome1.txt);
		postEventLog(locObj.welcome2.txt);
	}
	function postEventLog(msgEventLog, styling) {
        if (typeof styling !== 'undefined') {
            styling = styling.toUpperCase();
        } else {
            styling = "";
        }
        styling = styling.toUpperCase();
        if (styling.indexOf("BOLD")!==-1){
            msgEventLog = "<b>"+msgEventLog+"</b>";
        }
        if (styling.indexOf("ITALIC")!==-1){
            msgEventLog = "<i>"+msgEventLog+"</i>";
        }
        if (styling.indexOf("RED")!==-1){
            msgEventLog = "<font color='red'>"+msgEventLog+"</font>";
        }
		document.getElementById("log").innerHTML += getTime(0)+": "+msgEventLog+"<br>";
		scrollDown();
	}
	function clearJournalLog() {
		document.getElementById("lblAutocampaignJournal").innerHTML = "";
	}

	function createJournalAccordion() {
		var accordionContainerElement = document.createElement('div');
		var accordionHeaderElement    = document.createElement('div');
		var accordionBodyElement      = document.createElement('div');

		accordionContainerElement.classList.add('accordion', 'active');
		accordionHeaderElement.classList.add('accordion-header');
		accordionBodyElement.classList.add('accordion-body');

		game.autocampaignCounter++;

		let previousCampaignList = document.querySelectorAll('.accordion');

		previousCampaignList.forEach(function (item) {
			if (item.classList.contains('active')) {
				item.classList.remove('active');
			}
		});

		accordionBodyElement.setAttribute('id', 'accordionBody-' + game.autocampaignCounter);
		accordionHeaderElement.innerText = locObj.campaignTitle.txt.replace("%arg1", game.autocampaignCounter);

		accordionContainerElement.appendChild(accordionHeaderElement);
		accordionContainerElement.appendChild(accordionBodyElement);


		document.getElementById("lblAutocampaignJournal").appendChild(accordionContainerElement);
	}


	function createBattleAccordion() {
		var accordionContainerElement = document.createElement('div');
		var accordionHeaderElement    = document.createElement('div');
		var accordionBodyElement      = document.createElement('div');

		accordionContainerElement.classList.add('accordion-battle', 'active');
		accordionHeaderElement.classList.add('accordion-battle-header');
		accordionBodyElement.classList.add('accordion-battle-body');

		game.autocampaignBattlesCounter++;

		let previousListItem = document.querySelectorAll('.accordion-battle');

		previousListItem.forEach(function (item) {
			if (item.classList.contains('active')) {
				item.classList.remove('active');
			}
		});

		accordionBodyElement.setAttribute('id', 'accordionBattleBody-' + game.autocampaignBattlesCounter);
		accordionHeaderElement.innerText = locObj.autobattleTitle.txt.replace("%arg1", game.autocampaignBattlesCounter);

		accordionContainerElement.appendChild(accordionHeaderElement);
		accordionContainerElement.appendChild(accordionBodyElement);

		document.getElementById("lblAutocampaignBattle").appendChild(accordionContainerElement);

	}
	function postBattleLog(msgBattleLog) {
		var id = 'accordionBattleBody-' + game.autocampaignBattlesCounter;
		var accordionBattleElement = document.getElementById(id);
		var logStrElement = document.createElement('p');

		logStrElement.innerText = msgBattleLog;
		accordionBattleElement.appendChild(logStrElement);
	}

	function postJournalLog(msgEventLog) {
		var id = "accordionBody-" + game.autocampaignCounter;
		var targetCampaignLogElement = document.getElementById(id);
		targetCampaignLogElement.innerHTML += localeStrings[169]+game.myhero.aCampaignTotalLong;
		targetCampaignLogElement.innerHTML += ": "+msgEventLog+"<br>";
		scrollDown();
	}
	function writeToTextArea(msg) {
		document.getElementById("patchnotes").value = document.getElementById("patchnotes").value+"\r\n"+msg;
	}
	function autosaveGame() {
		saveGame("silent");
	}
	function saveGame(saveConfirmation) {
		if (saveConfirmation=="silent") {
			writeSave("silent");
		} else {
			if (localStorage.getItem('game')!==null) {
				question = locObj.dialogSaveGame.txt;
				showModal(1, '', saveGameCallback, question, localeStrings[32], localeStrings[33])
			} else {
				writeSave();
			}
		}
	}
	function saveGameCallback() {
		if (answer === 2) {
			writeSave();
		}
	}
	function writeSave(SaveType){
		document.getElementById("loadGameButton").style.visibility = "visible";
		localStorage.setItem('game', JSON.stringify(game));
		if (SaveType === "silent") {
			if (game.userASaveAck === 0) {
				game.userASaveAck = 1;
				postEventLog(locObj.savedSuccessfully.txt, "bold");
				scrollDown();
			}
		} else {
			postEventLog(locObj.savedSuccessfully.txt, "bold");
			scrollDown();
		}
	}
	function loadGame() {
		question = locObj.dialogLoadGame.txt;
		showModal(1, '', loadGameCallback, question,  localeStrings[32], localeStrings[33])
	}
	function loadGameCallback() {
		if (answer === 2) {
			if (localStorage.getItem('game')!==null){
				//Object.assign(game, JSON.parse(localStorage.getItem('game')));//DOESN'T WORK IN IE AT ALL.
				gameTemp = JSON.parse(localStorage.getItem('game'));
				dialogShown = false;
				overrideGame(gameTemp);
			} else {
				//TODO DO NOT SHOW loadGame BUTTON UNTIL WE DO HAVE A SAVEGAME!!!!
				alert(localeStrings[locObj.noSaveGame.txt]);
			}
		}
	}


function setTutorialAfterSaveRestore(gameTemp) {
	if (gameTemp.isTutorialState || gameTemp.tips.length > 0) {
		hiddenElements.forEach(function (el) {
			if (!el.classList.contains('is-tutorial')) {
				el.classList.add('is-tutorial')
			}
		});
	}
}

	function overrideGame(gameTemp){
		game.myhero = {};
		game.heroHire(true);
		tmpHero = game.myhero;
		game.myhero = {};
		for (var propertyName in gameTemp) { game[propertyName] = gameTemp[propertyName]; }
		console.log(game.heroExists());
		if (game.heroExists()){
			for (var propertyName in tmpHero) {
				if (game.myhero[propertyName]===undefined){
					game.myhero[propertyName] = tmpHero[propertyName];
				}
				if (propertyName === "int") {
					if (game.myhero.class===0) {
						game.myhero.int = 0;
					}
					if (game.myhero.class===1) {
						game.myhero.int = 2;
					}
				}
			}
			while (game.myhero.inventory.length>game.myhero.inventoryWorn.length){
				game.myhero.inventoryWorn.push(0);
			}
		}
		//options  = JSON.parse(localStorage.getItem('options'));
		game.active_tab="";
		game.putOutFireUI(true);
		game.userPopAck   = 0;
		game.userGoldAck  = 0;
		game.userASaveAck = 0;
		/*
		buildingsInTownB=[];
		buildingsInTownX=[];
		buildingsInTownY=[];
		buildingsInTownW=[];
		buildingsInTownH=[];
		*/

		setTutorialAfterSaveRestore(gameTemp);

		setupMobileUI();
		if (typeof setupFirebrigadeUI === "function") { setupFirebrigadeUI() };
		if (typeof setupAudioUI === "function") { setupAudioUI() };
		setupAutosave();
		if (typeof setupNickname === "function") { setupNickname() };
		setupEventLogSizeUI();
		updateImagesBuildingTab()
		composite();
		enforceColorMode();
		updateUI();
		postEventLog(locObj.loadedSuccessfully.txt, "bold");
		scrollDown();
	}
	function updateUI() {
		if (typeof updateResources      === "function") { updateResources() }
		if (typeof updateTroopsNumbers  === "function") { updateTroopsNumbers() }
		if (typeof updateButtonCaptions === "function") { updateButtonCaptions() }
		if (typeof updateHeroStatus     === "function") { updateHeroStatus() }
		if (typeof updateBlackMarket    === "function") { updateBlackMarket() }
		if (typeof updateImagesBuildingTab === "function") { updateImagesBuildingTab() }
		if (document.getElementById("inp_nickname").value === "" ||
			document.getElementById("inp_nickname").value === "undefined"){
			if (typeof setupNickname    === "function") { setupNickname() }
		}
		if (typeof drawTabUniversity === "function" ) { drawTabUniversity() }
	}
	function updateBlackMarket(changeSaleOffer,changeBuyOffer) {

		// var selectGoodsForBuying = document.getElementById("selectGoodsForHero");
		// if (changeSaleOffer!==null) {
		// 	if (changeSaleOffer!==undefined){
		// 		selectGoodsForBuying.options[changeSaleOffer].remove();
		// 	}
		// }
		// var selectedItemIndex = selectGoodsForBuying.selectedIndex;
		// selectGoodsForBuying.length = 0;
		// for(var j in game.blackMarketGoods)	{
		// 	selectGoodsForBuying.add(new Option(artefacts[game.blackMarketGoods[j]].name,artefacts[game.blackMarketGoods[j]].id));
		// }
		// if (selectedItemIndex!==-1) {
		// 	selectGoodsForBuying.selectedIndex=selectedItemIndex;
		// }
		// if (game.blackMarketGoods.length!==0){
		// 	if (selectedItemIndex !== -1){
		// 		document.getElementById("lblArtefactBuyPriceValue").innerText = artefacts[game.blackMarketGoods[selectedItemIndex]].priceBuy;
		// 	}
		// }
		// document.getElementById("lblArtefactSellPriceValue").innerText=0;
		// if (game.heroExists()){
		// 	var selectGoodsForSale = document.getElementById("selectGoodsFromHero");
		// 	if (changeBuyOffer!==null) {
		// 		if (changeSaleOffer!==undefined){
		// 			selectGoodsForSale.options[changeBuyOffer].remove();
		// 		}
		// 	}
		// 	var selectedSaleItemIndex = selectGoodsForSale.selectedIndex;
		// 	selectGoodsForSale.length = 0;
		// 	for(var i in game.myhero.inventory)	{
		// 		selectGoodsForSale.add(new Option(artefacts[game.myhero.inventory[i]].name,artefacts[game.myhero.inventory[i]].id));
		// 	}
		// 	if (selectedItemIndex!==-1) {
		// 		selectGoodsForSale.selectedIndex=selectedSaleItemIndex;
		// 	}
		// 	if (game.myhero.inventory.length!==0){
		// 		if (selectedSaleItemIndex !== -1){
		// 			document.getElementById("btnSellArtefact").disabled = false;
		// 			document.getElementById("lblArtefactSellPriceValue").innerText = artefacts[game.myhero.inventory[selectedSaleItemIndex]].priceBuy/2;
		// 		} else { document.getElementById("btnSellArtefact").disabled = true; }
		// 	} else {
		// 		document.getElementById("btnSellArtefact").disabled = true;
		// 	}
		// }
	}
	function getTime(type) {
		var d  = new Date();
		var hh = d.getHours();
		var mm = d.getMinutes();
		var ss = d.getSeconds();
		var n  = "";
		if (hh < 10) {
			hh = "0"+hh;
		}
		if (mm < 10) {
			mm = "0"+mm;
		}
		if (ss < 10) {
			ss = "0"+ss;
		}
		if (type=="0") {
			n = hh+":"+mm;
		}
		if (type=="1") {
			n = hh+":"+mm+":"+ss;
		}
		return n;
	}
	function scrollDown(){
		var textarea = document.getElementById("log");
		if(textarea.selectionStart === textarea.selectionEnd) {
			textarea.scrollTop = textarea.scrollHeight;
		}
		var textareaJrnl = document.getElementById("lblAutocampaignJournal");
		if(textareaJrnl.selectionStart === textareaJrnl.selectionEnd) {
			textareaJrnl.scrollTop = textareaJrnl.scrollHeight;
		}
	}
	function askPlayer(question, typeofasking) {
		if (typeofasking === 1) {
			playerDecision = confirm(question);
		}
		return playerDecision;
	}
	function showModal(typeofModal, dlgImage, dlgCallback, dlgMessage,  dlgAnswerOne, dlgAnswerTwo) {
		dialogShown = true;
		if (typeofModal===0) {
			myCanvas(dlgImage, dlgCallback, dlgMessage,  dlgAnswerOne, dlgAnswerTwo);
		}
		if (typeofModal===1) {
			myCanvas(dlgImage, dlgCallback, dlgMessage,  dlgAnswerOne, dlgAnswerTwo);
		}
		if (typeofModal===2) {
			//TODO PROMTS
		}
	}
	//timers
	function cooldownMvt(){
		allowMvt = 1;
	}
	function endOfTurnTimer() {
		if (dcounter - 1 === 0) {
			dcounter = dcounter_def;
			game.calculateTurn();
		} else {
			dcounter = dcounter - 1;
		}
		document.getElementById('dcounter').innerText = dcounter;
	}
	function cooldown() {
		if (game.festival_cooldown-1>=0) {
			game.festival_cooldown = game.festival_cooldown-1;
		} else {
			game.festival_cooldown = 0;
		}
	}
</script>
<!--JS FOR POPULATION, GOLD STATS SCREENS-->
<script async src="js/stats.js"></script>
<!--JS FOR SETTINGS SCREEN-->
<script async src="js/settings.js"></script>
<!--JS FOR SOUND SETTINGS SCREEN-->
<script async src="js/sound_settings.js"></script>
<!--JS FOR SHOP SCREEN-->
<script async src="js/shop.js"></script>
<!--JS FOR BUILDINGS SCREEN-->
<script async src="js/building.js"></script>
<!--JS LIBRARY FOR MODAL DIALOGUES-->
<script async src="js/dialogue.js"></script>
<!--ADVENTURE GENERATOR MAP-->
<script async src="js/advmapgen.js"></script>
<!--ADVENTURE RENDERER  MAP-->
<script async src="js/advmaprender.js"></script>
<!--RANDOM EVENTS-->
<script async src="js/random_events.js"></script>
<!--TECH TREE-->
<script src="js/technology_tree.js"></script>
<!--UNITS STATS-->
<script async src="js/units.js"></script>
<!--ONLINE OPTIONS-->
<script async src="js/online.js"></script>
<!--TIPS, STORYTELLING, STUFF-->	1 
<script src="js/tips_story.js"></script>
<script>


	function accordion(elem, targetClass){
		document.addEventListener('click', function (e) {
		var matchStr = elem + ' ' + targetClass;
		if (!e.target.matches(matchStr)) return;
		else{
			if(!e.target.parentElement.classList.contains('active')){
				e.target.parentElement.classList.add('active');
			}else{
				e.target.parentElement.classList.remove('active');
			}
		}
		});
	}

	accordion('.accordion', '.accordion-header');
	accordion('.accordion-battle', '.accordion-battle-header');

</script>
<!--Google Analytics. Sorry guys and girls, but I need some analytic from the game. Feel free to block it -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111661515-1"></script>
<script async>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'UA-111661515-1');
</script>
<!-- Yandex.Metrika counter. The same -->
<script type="text/javascript" >
	(function (d, w, c) {
		(w[c] = w[c] || []).push(function() {
			try {
				w.yaCounter47225574 = new Ya.Metrika({
					id:47225574,
					clickmap:true,
					trackLinks:true,
					accurateTrackBounce:true,
					webvisor:true
				});
			} catch(e) { }
		});
		var n = d.getElementsByTagName("script")[0],
				s = d.createElement("script"),
				f = function () { n.parentNode.insertBefore(s, n); };
		s.type = "text/javascript";
		s.async = true;
		s.src = "https://mc.yandex.ru/metrika/watch.js";
		if (w.opera == "[object Opera]") {
			d.addEventListener("DOMContentLoaded", f, false);
		} else { f(); }
	})(document, window, "yandex_metrika_callbacks");
</script>
<noscript>
	<div>
	<img src="https://mc.yandex.ru/watch/47225574" style="position:absolute; left:-9999px;" alt="" />
	</div>
</noscript>
<script src="js/hire.js"></script>
<script src="js/inn.js" ></script>

<!-- /Yandex.Metrika counter -->
</body>
</html>
